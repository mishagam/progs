(function(jQuery){var $=jQuery;(function($){var defaults={key:null,endpoint:"oembed",secure:null,query:{},method:"replace",addImageStyles:true,wrapElement:"div",className:"embed",batch:20,urlRe:null};var urlRe=/(http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;var none=function(obj){return obj===null||obj===undefined};var batch=function(list,split){var batches=[],current=[];$.each(list,function(i,obj){current.push(obj);if(current.length===split){batches.push(current);
current=[]}});if(current.length!==0)batches.push(current);return batches};var listify=function(obj){if(none(obj))return[];else if(!$.isArray(obj))return[obj];return obj};var zip=function(arrays){return $.map(arrays[0],function(_,i){return[$.map(arrays,function(array){return array[i]})]})};var Keeper=function(len,each,after){this.init(len,each,after)};Keeper.prototype={init:function(urls){this.urls=urls;this.count=0;this.results={};this._deferred=$.Deferred()},notify:function(result){this.results[result.original_url]=
result;this.count++;this._deferred.notify.apply(this._deferred,[result]);if(this.count===this.urls.length){var self=this;var results=$.map(this.urls,function(url){return self.results[url]});this._deferred.resolve(results)}return this},state:function(){return this._deferred.state.apply(this._deferred,arguments)}};window.Keeper=Keeper;var API=function(){};API.prototype={defaults:{},log:function(level,message){if(!none(window.console)&&!none(window.console[level]))window.console[level].apply(window.console,
[message])},build:function(method,urls,options){options=none(options)?{}:options;var secure=options.secure;if(none(secure))secure=window.location.protocol==="https:"?true:false;var base=(secure?"https":"http")+"://api.embed.ly/"+(method==="objectify"?"2/":"1/")+method;var query=none(options.query)?{}:options.query;query.key=options.key;base+="?"+$.param(query);base+="\x26urls\x3d"+$.map(urls,encodeURIComponent).join(",");return base},ajax:function(method,urls,options){options=$.extend({},defaults,
$.embedly.defaults,typeof options==="object"&&options);if(none(options.key)){this.log("error","Embedly jQuery requires an API Key. Please sign up for one at http://embed.ly");return null}urls=listify(urls);var keeper=new Keeper(urls);var valid_urls=[],rejects=[],valid;$.each(urls,function(i,url){valid=false;if(urlRe.test(url)){valid=true;if(options.urlRe!==null&&options.urlRe.test&&!options.urlRe.test(url))valid=false}if(valid===true)valid_urls.push(url);else rejects.push({url:url,original_url:url,
error:true,invalid:true,type:"error",error_message:'Invalid URL "'+url+'"'})});var batches=batch(valid_urls,options.batch),self=this;$.each(batches,function(i,batch){$.ajax({url:self.build(method,batch,options),dataType:"jsonp",success:function(data){$.each(zip([batch,data]),function(i,obj){var result=obj[1];result.original_url=obj[0];result.invalid=false;keeper.notify(result)})}})});if(rejects.length)setTimeout(function(){$.each(rejects,function(i,reject){keeper.notify(reject)})},1);return keeper._deferred},
oembed:function(urls,options){return this.ajax("oembed",urls,options)},preview:function(urls,options){return this.ajax("preview",urls,options)},objectify:function(urls,options){return this.ajax("objectify",urls,options)},extract:function(urls,options){return this.ajax("extract",urls,options)}};var ImageAPI=function(){};ImageAPI.prototype={build:function(method,url,options){options=$.extend({},$.embedly.defaults,typeof options==="object"&&options);var secure=options.secure;if(none(secure))secure=window.location.protocol===
"https:"?true:false;var base=(secure?"https":"http")+"://i.embed.ly/"+(method==="display"?"1/":"1/display/")+method;var query=none(options.query)?{}:options.query;query.key=options.key;base+="?"+$.param(query);base+="\x26url\x3d"+encodeURIComponent(url);return base},display:function(url,options){return this.build("display",url,options)},resize:function(url,options){return this.build("resize",url,options)},fill:function(url,options){return this.build("fill",url,options)},crop:function(url,options){return this.build("crop",
url,options)}};var Embedly=function(element,url,options){this.init(element,url,options)};Embedly.prototype={init:function(elem,original_url,options){this.elem=elem;this.$elem=$(elem);this.original_url=original_url;this.options=options;this.loaded=$.Deferred();var self=this;this.loaded.done(function(){self.$elem.trigger("loaded",[self])});this.$elem.trigger("initialized",[this])},progress:function(obj){$.extend(this,obj);if(this.options.display)this.options.display.apply(this.elem,[this,this.elem]);
else if(this.options.endpoint==="oembed")this.display();this.loaded.resolve(this)},imageStyle:function(){var style=[],units;if(this.options.addImageStyles){if(this.options.query.maxwidth){units=isNaN(parseInt(this.options.query.maxwidth,10))?"":"px";style.push("max-width: "+this.options.query.maxwidth+units)}if(this.options.query.maxheight){units=isNaN(parseInt(this.options.query.maxheight,10))?"":"px";style.push("max-height: "+this.options.query.maxheight+units)}}return style.join(";")},display:function(){if(this.type===
"error")return false;this.style=this.imageStyle();var html;if(this.type==="photo"){html="\x3ca href\x3d'"+this.original_url+"' target\x3d'_blank'\x3e";html+="\x3cimg style\x3d'"+this.style+"' src\x3d'"+this.url+"' alt\x3d'"+this.title+"' /\x3e\x3c/a\x3e"}else if(this.type==="video"||this.type==="rich")html=this.html;else{this.title=this.title||this.url;html=this.thumbnail_url?"\x3cimg src\x3d'"+this.thumbnail_url+"' class\x3d'thumb' style\x3d'"+this.style+"'/\x3e":"";html+="\x3ca href\x3d'"+this.original_url+
"'\x3e"+this.title+"\x3c/a\x3e";html+=this.provider_name?"\x3ca href\x3d'"+this.provider_url+"' class\x3d'provider'\x3e"+this.provider_name+"\x3c/a\x3e":"";html+=this.description?'\x3cdiv class\x3d"description"\x3e'+this.description+"\x3c/div\x3e":""}if(this.options.wrapElement)html="\x3c"+this.options.wrapElement+' class\x3d"'+this.options.className+'"\x3e'+html+"\x3c/"+this.options.wrapElement+"\x3e";this.code=html;if(this.options.method==="replace")this.$elem.replaceWith(this.code);else if(this.options.method===
"after")this.$elem.after(this.code);else if(this.options.method==="afterParent")this.$elem.parent().after(this.code);else if(this.options.method==="replaceParent")this.$elem.parent().replaceWith(this.code);this.$elem.trigger("displayed",[this])}};$.embedly=new API;$.embedly.display=new ImageAPI;$.fn.embedly=function(options){if(options===undefined||typeof options==="object"){options=$.extend({},defaults,$.embedly.defaults,typeof options==="object"&&options);if(none(options.key)){$.embedly.log("error",
"Embedly jQuery requires an API Key. Please sign up for one at http://embed.ly");return this.each($.noop)}var nodes={};var create=function(elem){if(!$.data($(elem),"embedly")){var url=$(elem).attr("href");var node=new Embedly(elem,url,options);$.data(elem,"embedly",node);if(nodes.hasOwnProperty(url))nodes[url].push(node);else nodes[url]=[node]}};var elems=this.each(function(){if(!none($(this).attr("href")))create(this);else $(this).find("a").each(function(){if(!none($(this).attr("href")))create(this)})});
var deferred=$.embedly.ajax(options.endpoint,$.map(nodes,function(value,key){return key}),options).progress(function(obj){$.each(nodes[obj.original_url],function(i,node){node.progress(obj)})});if(options.progress)deferred.progress(options.progress);if(options.done)deferred.done(options.done);return elems}};$.expr[":"].embedly=function(elem){return!none($(elem).data("embedly"))};$.fn.display=function(endpoint,options){if(none(endpoint))endpoint="display";if(options===undefined||typeof options==="object"){options=
$.extend({},defaults,$.embedly.defaults,typeof options==="object"&&options);if(none(options.key)){$.embedly.log("error","Embedly jQuery requires an API Key. Please sign up for one at http://embed.ly/display");return this.each($.noop)}var create=function(elem){var $elem=$(elem);if(!$elem.data("display")){var url=$elem.data("src")||$elem.attr("href");var data={original_url:url,url:$.embedly.display.build(endpoint,url,options)};$elem.data("display",data);$elem.trigger("initialized",[elem]);var html=
"\x3cimg src\x3d'"+data.url+"' /\x3e";if($elem.is("a"))$elem.append(html);else $elem.replaceWith(html)}};var doCreate=function(elem){if(none($(elem).data("src"))&&none($(elem).attr("href")))return false;return true};var elems=this.each(function(){if(doCreate(this))create(this);else $(this).find("img,a").each(function(){if(doCreate(this))create(this)})});return elems}};$.expr[":"].display=function(elem){return!none($(elem).data("display"))}})(jQuery,window)})(Echo.jQuery);