(function(c){wp_e2=window.wp_e2||{};wp_e2.extensions=c.extend({},wp_e2.extensions);wp_e2.config=c.extend({},wp_e2.config);wp_e2_defaults={allow_comments:true,allow_links:true,allow_photos:false,allow_videos:false,commentmaxlength:2000,defaulttab:"top",display_ugc_photos:false,display_more:true,includefeaturenotification:true,includeheader:true,includepause:true,includepermalink:false,includereply:true,includereport:true,includerecommend:true,includeshare:true,includesorts:true,includetabs:false,isallcomments:false,max_items_to_display:0,maxitemstop:3,maxitems:15,moderationrequired:false,photocommentmaxlength:500,source:"washpost.com",topiccommentmaxlength:140,filesMax:1,"data-app-instance":"6634zxcgfd","data-canvas-id":"washpost.com/km4ey0dajm"};wp_e2_core={apiBaseURL:"http://echoapi.wpdigital.net",echoSubmissionProxyURL:"http://apps.echoenabled.com/v2/esp/activity",appkey:"dev.washpost.com",backplaneSettings:{serverBaseURL:"http://api.echoenabled.com/v1",busName:"washpost.com"},bookmarkletUrl:"https://testapp12b:7001/bookmarklet/edit-comment.html",counterTarget:".echo-counter",debug:false,default_plugins:{authPluginArray:[{"name":"TWP_formAuth","thisContainer":""}],streamPluginArray:[{"name":"TWP_Stream","thisContainer":""},{"name":"TWP_Stream_Item","thisContainer":""}],submitboxPluginArray:[{"name":"TWP_Share","thisContainer":""},{"name":"TWP_Submit","thisContainer":""}],replyPluginArray:[{"name":"Reply","actionString":"Add your thoughts...","nestedPlugins":[{"name":"FormAuth","nestedPlugins":[{"name":"ReplyAuth"}]},{"name":"ReplyForm","thisContainer":""}]}],ugcstreamPluginArray:[{"name":"TWP_UGC_Gallery"}],ugcsubmitboxPluginArray:[{"name":"FormAuth","nestedPlugins":[{"name":"SubmitAuth"}]},{"name":"SubmitForm"},{"name":"FileUpload","thumbnailRes":[90,60],"previewRes":[300,200],"webRes":[610,407],"showDefaultInputs":false,"fileSizeMax":5120,"fileSizeMin":0,"filesMax":1,"storageServer":"http://twp_echo_ugc.s3.amazonaws.com/comment_photos/","authorName":""}]},allowEdit:true,allowDelete:true,editTime:5,environment:{"dev":{logOutURL:TWP.signin.logouturl_page+"?destination=",logInURL:TWP.signin.logincommentsurl_page+"?destination=",profileURL:TWP.signin.profileurl,registerURL:TWP.signin.registrationcommentsurl_page+"?destination=",proxyURL:"http://bunsen.wapolabs.com/identity/1.5.2/js/wapo_jskit_login_redirect.js",twp_echojsUrl:"/rw/sites/twpweb/js/echo2/v2/core/twp_comments_echo2.js",metaUrl:"http://iddevreg.digitalink.com/identity/public/visitor/submit_metadata.json",bookmarkletUrl:"https://testapp12b:7001/bookmarklet/edit-comment.html",mongoUserActionUrl:"http://data.washingtonpost.com/features/comment_user_action/",argusBaseUrl:"https://argus-stg.washingtonpost.com/api/",commentProfileUrl:"/mycomments",commentBadgesUrl:"http://dre-dev.wpprivate.com/wp-dre/comments/badges",appkey:"dev.washpost.com"},"qa":{logOutURL:TWP.signin.logouturl_page+"?destination=",logInURL:TWP.signin.logincommentsurl_page+"?destination=",profileURL:TWP.signin.profileurl,registerURL:TWP.signin.registrationcommentsurl_page+"?destination=",proxyURL:"http://bunsen.wapolabs.com/identity/1.5.2/js/wapo_jskit_login_redirect.js",twp_echojsUrl:"/rw/sites/twpweb/js/echo2/v2/core/twp_comments_echo2.js",metaUrl:"https://idstg.digitalink.com/identity/public/visitor/submit_metadata.json",bookmarkletUrl:"https://testapp12b:7001/bookmarklet/edit-comment.html",mongoUserActionUrl:"http://data.washingtonpost.com/features/comment_user_action/",argusBaseUrl:"https://argus-stg.washingtonpost.com/api/",commentProfileUrl:"/mycomments",commentBadgesUrl:"http://dre-dev.wpprivate.com/wp-dre/comments/badges",appkey:"dev.washpost.com"},"stage":{logOutURL:TWP.signin.logouturl_page+"?destination=",logInURL:TWP.signin.logincommentsurl_page+"?destination=",profileURL:TWP.signin.profileurl,registerURL:TWP.signin.registrationcommentsurl_page+"?destination=",proxyURL:"http://bunsen.wapolabs.com/identity/1.5.2/js/wapo_jskit_login_redirect.js",twp_echojsUrl:"/rw/sites/twpweb/js/echo2/v2/core/twp_comments_echo2.js",metaUrl:"http://id.washingtonpost.com/identity/public/visitor/submit_metadata.json",bookmarkletUrl:"https://testapp12b:7001/bookmarklet/edit-comment.html",mongoUserActionUrl:"http://data.washingtonpost.com/features/comment_user_action/",argusBaseUrl:"https://argus.washingtonpost.com/api/",commentProfileUrl:"/mycomments",commentBadgesUrl:"http://www.washingtonpost.com/wp-dre/comments/badges",appkey:"prod.washpost.com"},"beta":{logOutURL:TWP.signin.logouturl_page+"?destination=",logInURL:TWP.signin.logincommentsurl_page+"?destination=",profileURL:TWP.signin.profileurl,registerURL:TWP.signin.registrationcommentsurl_page+"?destination=",proxyURL:"http://bunsen.wapolabs.com/identity/1.5.2/js/wapo_jskit_login_redirect.js",twp_echojsUrl:"/rw/sites/twpweb/js/echo2/v2/core/twp_comments_echo2.js",metaUrl:"http://id.washingtonpost.com/identity/public/visitor/submit_metadata.json",bookmarkletUrl:"https://liveadmin.washingtonpost.com/bookmarklet/edit-comment.html",mongoUserActionUrl:"http://data.washingtonpost.com/features/comment_user_action/",argusBaseUrl:"https://argus.washingtonpost.com/api/",commentProfileUrl:"/mycomments",commentBadgesUrl:"http://www.washingtonpost.com/wp-dre/comments/badges",appkey:"prod.washpost.com"},"prod":{logOutURL:TWP.signin.logouturl_page+"?destination=",logInURL:TWP.signin.logincommentsurl_page+"?destination=",profileURL:TWP.signin.profileurl,registerURL:TWP.signin.registrationcommentsurl_page+"?destination=",proxyURL:"http://bunsen.wapolabs.com/identity/1.5.2/js/wapo_jskit_login_redirect.js",twp_echojsUrl:"/rw/sites/twpweb/js/echo2/v2/core/twp_comments_echo2.js",metaUrl:"http://id.washingtonpost.com/identity/public/visitor/submit_metadata.json",bookmarkletUrl:"https://liveadmin.washingtonpost.com/bookmarklet/edit-comment.html",mongoUserActionUrl:"http://data.washingtonpost.com/features/comment_user_action/",argusBaseUrl:"https://argus.washingtonpost.com/api/",commentProfileUrl:"/mycomments",commentBadgesUrl:"http://www.washingtonpost.com/wp-dre/comments/badges",appkey:"prod.washpost.com"}},guid:window.location.href,identityjsUrl:"",liveUpdates:{desktop:{"transport":"websockets","enabled":true,"polling":{"timeout":60},"websockets":{"maxConnectRetries":3,"serverPingInterval":60}},mobile:{"transport":"polling","enabled":true,"polling":{"timeout":120}}},liveUpdatesTimeout:{counter:{"default":60,"closed":0,"no_webtype":60},stream:{"default":60,"closed":0,"no_webtype":0}},logOutURL:"",logInURL:"",markerDisplay:{"top_commenter":"Post Forum Member","top_local":"Washingtologist","top_sports":"SuperFan","staff":"Post Writer","fact_checker":"Fact Checker","post_recommended":"Post Recommended","world_watcher":"World Watcher","culture_connoisseur":"Culture Connoisseur"},"markerSettings":{"delimiter":"__","modPrefix":"mod","userPrefix":"user","votedPrefix":"voted","counterPrefix":"cntr"},metaUrl:"",pageURL:window.location.href,profileURL:"",proxyURL:"",registerURL:"",sectionid:"",source:"washpost.com",streamPluginArray:[],streamSettings:{top:{maxitems:3,childrenItemsPerPage:3},all:{maxitems:15,childrenItemsPerPage:3},appkey:"dev.washpost.com",target:"#comment-stream",apiBaseURL:"",defaultsort:"reverseChronological",displaysort:true,childrenItemsPerPage:3,childrenSortOrder:"chronological",plugins:[],streamStateLabel:{icon:true,text:true},viaLabel:{icon:true,text:true},reTag:false,streamStateToggleBy:"button",aggressiveSanitization:false,openLinksInNewWindow:true,sortorder:"reverseChronological",reply:false,request:"childrenof",allowedItemStates:["Untouched","CommunityFlagged","ModeratorApproved"],allowedUserStates:["ModeratorApproved"],safeHTML:"aggressive",childrenMaxDepth:2,active:false,userMarkers:[""]},streamClient:null,streamId:"",streamTarget:"#echo_comment_stream",submitboxPluginArray:[],submitTarget:"#comment-box",suspend_user_markers:{"tsk_h":"Your account has been suspended for up to 24 hours. ","tsk_d":"Your account has been suspended for up to 24 hours. ","tsk_w":"Your account has been suspended for up to 7 days. ","tsk_perm":"Your account is permanently suspended. "},suspend_type_text:{"default":"Your account has been suspended. ","tsk_type_obscenity":"You submitted a comment that violated our guideline against obscene content. ","tsk_type_namecalling":"You submitted a comment that violated our guideline against intimidation and harassment. ","tsk_type_profanity":"You submitted a comment that violated our guideline against profane content. ","tsk_type_personal":"You submitted a comment that violated our guideline against personal attacks. ","tsk_type_defamatory":"You submitted a comment that violated our guideline against alleged claims and unfounded accusations. "},suspend_core_text:'<span class="discussion-policy"><a http://www.washingtonpost.com/blogs/ask-the-post/discussion-and-submission-guidelines/" target="_policy">Please review the discussion guidelines</a></span>. ',tabs:"",twp_echojsUrl:"",uploadPhotoPluginArray:[],"voteSettings_flag-offtopic":{"cookie":"wapo_comment_offtopic","flag":"flag-offtopic","threshold":5,"markClass":"offtopic","markText":"Off-topic","controlTextShowing":"Off-topic Shown","controlTextHiding":"Off-topic Hidden"}};
wp_e2.createDataObject=function(h,e){var g={};if(typeof h.attr("data")!=="undefined"&&h.attr("data").length>0){var d=h.attr("data").split("&");for(var f=0;f<d.length;f++){if(d[f]!=""){valArry=d[f].split("=");g[valArry[0].toLowerCase()]=(valArry[1]=="true")?true:(valArry[1])=="false"?false:valArry[1];wp_e2[e][valArry[0].toLowerCase()]=g[valArry[0].toLowerCase()];}}}else{var d=h[0].attributes;for(var f=0;f<d.length;f++){g[d[f].nodeName.toLowerCase()]=(d[f].nodeValue=="true")?true:(d[f].nodeValue)=="false"?false:d[f].nodeValue;wp_e2[e][d[f].nodeName.toLowerCase()]=g[d[f].nodeName.toLowerCase()];}}return g;};wp_e2.initDataObject=function(e){var d=(typeof e!="undefined")?e:c(".comment-vars");d.each(function(i,f){var j=c(f);var h=j.attr("id");wp_e2[h]={};data=wp_e2.createDataObject(j,h);c.each(wp_e2_defaults,function(k,l){wp_e2[h][k]=(typeof data[k]!=="undefined"&&data[k]!=="")?data[k]:wp_e2_defaults[k];});wp_e2[h].streamSettings={};c.extend(wp_e2[h].streamSettings,wp_e2_core.streamSettings);wp_e2[h].allCommentsURL=data.articleurlfacet;wp_e2[h].streamSettings.sortorder=(typeof data.defaultsort!=="undefined"&&data.defaultsort!="")?data.defaultsort:wp_e2.streamSettings.sortorder;wp_e2[h].streamSettings.childrenItemsPerPage=(typeof data.childrenitemsperpage!=="undefined"&&data.childrenitemsperpage!="")?parseInt(data.childrenitemsperpage):wp_e2.streamSettings.childrenItemsPerPage;wp_e2[h].streamSettings.childrenMaxDepth=(typeof data.childrenmaxdepth!=="undefined"&&data.childrenmaxdepth!="")?parseInt(data.childrenmaxdepth):wp_e2.streamSettings.childrenMaxDepth;wp_e2[h].itemMarkersTop=data.markers;delete wp_e2[h].markers;wp_e2[h].itemMarkers=(typeof data.markersall!=="undefined"&&data.markersall!="")?data.markersall.split(","):"";delete wp_e2[h].markersall;wp_e2[h].markerDisplay=(typeof data.markerdisplay!=="undefined"&&data.markerdisplay!="")?jQuery.parseJSON("{"+data.markerdisplay.replace(/'/g,'"')+"}"):wp_e2.markerDisplay;wp_e2[h].userMarkersTop=data.usermarkers;delete wp_e2[h].usermarkers;wp_e2[h].userMarkers=(typeof data.usermarkersall!=="undefined"&&data.usermarkersall!="")?data.usermarkersall.split():"";delete wp_e2[h].usermarkersall;wp_e2[h].webType=(typeof data.webtype=="undefined")?"article_story":data.webtype;wp_e2[h].streamSettings.all.maxitems=(typeof data.maxitems!=="undefined"&&data.maxitems!="")?data.maxitems:wp_e2[h].streamSettings.all.maxitems;wp_e2[h].streamSettings.top.maxitems=(typeof data.maxitemstop!=="undefined"&&data.maxitemstop!="")?data.maxitemstop:wp_e2[h].streamSettings.top.maxitems;if(wp_e2[h].allow_photos||wp_e2[h].allow_videos){wp_e2[h].streamSettings.safeHTML="permissive";}if((wp_e2[h].webType).toLowerCase().indexOf("topic_story")>=0){wp_e2[h].commentmaxlength=(typeof wp_e2.config.topiccommentmaxlength!="undefined")?wp_e2.config.topiccommentmaxlength:wp_e2_defaults.topiccommentmaxlength;}if(wp_e2[h].webType=="ugc_photo_story"){wp_e2[h].commentmaxlength=wp_e2_defaults.photocommentmaxlength;}wp_e2[h].plugins={};var g={};g.streamPluginArray=[];g.submitboxPluginArray=[];var f=c("#"+h);if(f.hasClass("stream")||f.hasClass("echo-canvas")){if(wp_e2[h].allow_comments===true&&wp_e2[h].includereply===true){}if(wp_e2[h].includereport===true){g.streamPluginArray=g.streamPluginArray.concat({"name":"CommunityFlag","thisContainer":h});}if(wp_e2[h].webType=="ugc_photo_story"){c.each(wp_e2.default_plugins.ugcstreamPluginArray,function(k,l){g.streamPluginArray.push(c.extend({},l));});}else{c.each(wp_e2.default_plugins.streamPluginArray,function(k,l){g.streamPluginArray.push(c.extend({},l));});}}if(wp_e2[h].webType=="ugc_photo_story"){c.each(wp_e2.default_plugins.ugcsubmitboxPluginArray,function(k,l){g.submitboxPluginArray.push(c.extend({},l));});}else{c.each(wp_e2.default_plugins.submitboxPluginArray,function(k,l){g.submitboxPluginArray.push(c.extend({},l));});}g.submitboxPluginArray=g.submitboxPluginArray.concat([{"name":"TextCounter","limit":wp_e2[h].commentmaxlength}]);if(wp_e2[h].includeverifiedcommenters==true){g.submitboxPluginArray=g.submitboxPluginArray.concat([{"name":"TWP_Submit_VerifiedCommenter"}]);}wp_e2[h].plugins=c.extend({},g,wp_e2.plugins);c.each(wp_e2[h].plugins,function(k,l){c.each(l,function(m,n){n.thisContainer=h;});});wp_e2[h]=c.extend(wp_e2[h],wp_e2.config);});};c(".echo_container").not(".processed").buildecho(wp_e2.config.options);c.extend(wp_e2,wp_e2_core,wp_e2_defaults,wp_e2.config,wp_e2.extensions);wp_e2.initDataObject();wp_e2.streamSettings.apiBaseURL=wp_e2.apiBaseURL;var a=((typeof TWP==="undefined")||(typeof TWP.Data==="undefined")||(typeof TWP.Data.environment)==="undefined")?"dev":TWP.Data.environment;var b=(typeof eidosBase!=="undefined"&&eidosBase!=="")?eidosBase:"";c.each(wp_e2.environment[a],function(d,e){wp_e2[d]=e;});if(window.location.href.indexOf("echodebug=true",0)>0){wp_e2.debug=true;}if(typeof TWP_Debug=="undefined"||TWP_Debug==""){TWP_Debug={};}if(!TWP_Debug.initialTime){TWP_Debug.initialTime=new Date();}wp_e2.debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2_config.js - Starting Identity Load");})(jQuery);(function(c){var b=c;var a=Echo.Plugin.manifest("CommunityFlag","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(a)){return;}a.init=function(){this.extendTemplate("insertAsLastChild","data",a.templates.main);a.config.proxyURL=wp_e2.metaUrl;};a.config={"showUserList":false,"markUnreliableFlaggers":{"enabled":true,"markerValue":"unreliable_flagger"}};a.labels={"flagged":"Reported","flaggedThis":" reported this.","flagControl":"Report","unflagControl":"Reported","flagProcessing":"Reporting...","unflagProcessing":"Unreporting..."};Echo.Labels.set(a.labels,"Echo.StreamServer.Controls.Stream.Item.Plugins.CommunityFlagCardUI");a.templates.main='<div class="{plugin.class:flaggedBy}"></div>';a.component.renderers.buttons=function(d){var e=this.component;this.parentRenderer("buttons",arguments);d.find(".echo-streamserver-controls-stream-item-button-Flag, .echo-streamserver-controls-stream-item-button-Unflag").unbind("click");d.find(".echo-streamserver-controls-stream-item-button-Flag").on("mouseenter",this,function(f){f.stopPropagation();var g=b("#comment-flag-container").clone();g.find("li").on("click",f.data,function(n){n.stopPropagation();var j=b(this).attr("id");var h="Flag";var m=n.data.component;var l=n.data;if(l.config.get("markUnreliableFlaggers").enabled==true){var i=wp_e2.echo_user.get("markers");b.each(i||[],function(p,q){if(q.indexOf(l.config.get("markUnreliableFlaggers").markerValue)>-1){j=j+"-"+l.config.get("markUnreliableFlaggers").markerValue;}});}m.view.get("buttons").find(".echo-streamserver-controls-stream-item-button-Flag .echo-streamserver-controls-stream-item-buttonCaption").empty().append(l.labels.get(h.toLowerCase()+"Processing"));var o={"verbs":["http://activitystrea.ms/schema/1.0/"+h.toLowerCase()],"targets":[{"id":m.get("data.object.id")}]};var k=Echo.StreamServer.API.request({"endpoint":"submit","secure":l.config.get("useSecureAPI",false,true),"submissionProxyURL":l.config.get("submissionProxyURL","",true),"data":{"content":o,"appkey":m.config.get("appkey"),"sessionID":m.user.get("sessionID"),"target-query":m.config.get("parent.query")},"onData":function(p){var q='{"verb": "mark","target": "'+m.get("data.object.id")+'","markers": "'+j+'"}';b.get(l.config.get("proxyURL"),{"appkey":m.config.get("appkey"),"content":q,"sessionID":m.user.get("sessionID","")},function(){p.markers=j;l._publishEventComplete({"name":h,"state":"Complete","response":p});if(h==="Flag"&&!m.config.get("parent.showFlags")){l.set("flagged",true);m.view.render({"name":"buttons"});}l.requestDataRefresh();},"jsonp");},"onError":function(p){l._publishEventComplete({"name":h,"state":"Error","response":p});m.render();}});k.send();});g.appendTo(b(this)).show();});d.find(".echo-streamserver-controls-stream-item-button-Flag").on("mouseleave",function(f){f.stopPropagation();b(this).find("#comment-flag-container").remove();});return d;
};a.methods._publishEventComplete=function(d){var e=this.component;this.events.publish({"topic":"on"+d.name+d.state,"data":{"item":{"data":e.get("data"),"target":e.config.get("target")},"response":d.response}});};a.methods._myFlags=function(d){var e=this.component;return b.map(d,function(f){if(e.user.has("identity",f.actor.id)){return f;}});};a.css=".{plugin.class:flaggedBy} { background: url({config:cdnBaseURL.sdk-assets}/images/curation/status/communityflagged.png) no-repeat 0px 4px; padding: 0px 0px 4px 21px; }";Echo.Plugin.create(a);})(Echo.jQuery);(function(c){var b=c;var a=Echo.Plugin.manifest("TWP_Stream","Echo.StreamServer.Controls.Stream");if(Echo.Plugin.isDefined(a)){return;}a.init=function(){var d=this,f=this.component;var e=this.config.get("thisContainer");f.config.set("thisContainer",e);};a.config={"thisContainer":"#echo_container"};a.events={"Echo.StreamServer.Controls.Stream.onRender":function(d,e){},"Echo.StreamServer.Controls.Stream.onRerender":function(d,e){}};a.component.renderers.more=function(f){var d=this.component;this.parentRenderer("more",arguments);var e=d.config.get("thisContainer");if(wp_e2[e].display_more===false){f.remove();}if(d.data.hasMoreChildren===false){f.append("No more comments.");}};a.component.renderers.container=function(f){var d=this.component,g=this;this.parentRenderer("container",arguments);var e=d.config.get("thisContainer");var h=b(".echo-apps-conversations-streamSorter");if(h.find(".dropdown-toggle .fa").length==0){h.find(".dropdown-toggle").append('<i class="fa fa-caret-down"></i>');}return f;};Echo.Plugin.create(a);})(Echo.jQuery);(function(c){var b=c;var a=Echo.Plugin.manifest("TWP_Stream_Item","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(a)){return;}a.init=function(){var d=this,f=this.component;var e=this.config.get("thisContainer");f.config.set("thisContainer",e);if(a.methods._ignoreVisible(this.component)){this.extendTemplate("insertBefore","buttons",a.ignoreUserTemplate);}if(e&&wp_e2[e]&&wp_e2[e].includeshare){f.addButtonSpec(this.name,this._assembleButton("share"));}Echo.Labels.set({"childrenMoreItems":"View More Replies"},"Echo.StreamServer.Controls.Stream.Item");};a.config={"thisContainer":"#echo_container","includeshare":true,"ignoreuser":true,"verifiedUserMarkers":"verified_preferred","editConfig":{"editMarker":"edited","editText":'<span class="edited"> [Edited]</span>'}};a.labels={"share":"Share","ignore_user":"Ignore User","verification_complete":"verification_approved"};a.events={"Echo.StreamServer.Controls.Stream.Item.onAdd":function(d,e){a.methods._markNew(e);},"Echo.UserSession.onInit":function(d,e){},"Echo.StreamServer.Controls.Stream.Item.Plugins.CommunityFlag.onFlagComplete":function(d,e){if(e&&e.response.result=="success"&&e.response.skipped.length==0){a.methods._processFlag(d,e);}}};a.ignoreUserTemplate=function(){return'<div class="{plugin.class:wrapper} {class:buttons} {class:ignore_user}">'+'<a class="{class:button}  {plugin.class:ignore_user}"><span class=" {class:buttonCaption} ignore-user">Ignore User</span></a>'+"</div>";};a.component.renderers.authorName=function(e){var f=this.component;this.parentRenderer("authorName",arguments);var d=f.config.get("thisContainer");if(a.methods._isVerifiedCommenter(d,f)){b(e).html("<span>"+wp_e2[d].verifiedcommenteridlist.userArray[f.data.actor.id].name+" ("+f.data.actor.title+")"+"</span>");}};a.component.renderers.date=function(j){var m=this;var p=this.component;this.parentRenderer("date",arguments);var k=p.config.get("thisContainer");var i=new Date();var h=(typeof p.data.object.markers!="undefined")?p.data.object.markers.join(","):"";i.setISO8601(p.data.object.published);var l=i.format("h:MM TT Z");var n=i.format("m/d/yyyy h:MM TT Z");var g=p.data.object.id;g=g.replace("http://","");var f=wp_e2[k].commentpermalinkurlfacet+"?commentID="+g;if(wp_e2[k]&&wp_e2[k].includepermalink&&(p.data.target.id!=p.data.target.conversationID&&p.data.target.id==p.data.object.context[0].uri)){var e='<a href="'+f+'">'+l+"</a>";var o='<a href="'+f+'">'+n+"</a>";(i.format("m/d/yyyy")==new Date().format("m/d/yyyy"))?b(j).html(e):b(j).html(o);}else{(i.format("m/d/yyyy")==new Date().format("m/d/yyyy"))?b(j).html(l):b(j).html(n);f=wp_e2[k].commentpermalinkurlfacet+"?commentID="+p.data.targets[0].id;}var d=this.config.get("editConfig");if(h.indexOf(d.editMarker)>=0){b(j).append(d.editText);}return j;};a.component.renderers.children=function(d){var e=this.component;this.parentRenderer("children",arguments);if(!TWP.isSignedIn()||(TWP.isSignedIn()&&wapoIdentity&&!wapoIdentity.isMemberOfCommentingGroup())){c(e.view.get("plugin-Reply-replyForm")).find("echo-streamserver-controls-submit-body").remove();}};a.component.renderers.expandChildrenLabel=function(d){var e=this.component;this.parentRenderer("expandChildrenLabel",arguments);return d.append('<span class="fa fa-chevron-down"></span>');};a.renderers.ignore_user=function(e){var g=this,f=this.component;var d=f.config.get("thisContainer");return e.on("click",function(){var h={};h.actionData={};h.actionData.user_id=wp_e2.echo_user.get("identityUrl");h.actionData.action="Ignore";h.actionData.target_user_id=f.data.actor.id;h.actionData.target_user_name=f.data.actor.title;h.actionData.ignoring_date=(new Date).getTime();var i={};i.config={"action":"post","remoteUrl":wp_e2.mongoUserActionUrl,"data":h.actionData};TWP.Util.updateMongoDb(i);if(!wp_e2.ignoredUsers){wp_e2.ignoredUsers=[];}wp_e2.ignoredUsers.push(f.data.actor.id);g._IgnoreOmniture();g._removeIgnoredComments(f,d);});};a.methods._assembleButton=function(e){var g=this,f=this.component;var d=f.config.get("thisContainer");switch(e){case"share":return function(){var h=this;return{"name":e,"label":g.labels.get(e),"visible":g._shareVisible()};};break;case"ignore_user":return function(){var h=this;var i=function(){var j={};j.actionData={};j.actionData.user_id=wp_e2.echo_user.get("identityUrl");j.actionData.action="Ignore";j.actionData.target_user_id=h.data.actor.id;j.actionData.target_user_name=h.data.actor.title;j.actionData.ignoring_date=(new Date).getTime();var k={};k.config={"action":"post","remoteUrl":wp_e2.mongoUserActionUrl,"data":j.actionData};TWP.Util.updateMongoDb(k);if(!wp_e2.ignoredUsers){wp_e2.ignoredUsers=[];}wp_e2.ignoredUsers.push(h.data.actor.id);g._IgnoreOmniture();g._removeIgnoredComments(h,d);};return{"name":e,"label":g.labels.get(e),"template":'<a class="{class:button} {class:ignore_user}"><span class="ignore-user">Ignore User</span></a>',"visible":g._ignoreVisible(),"callback":i};};break;}};a.component.renderers.container=function(g){var i=this,q=this.component;this.parentRenderer("container",arguments);var h=q.config.get("thisContainer");var m=wp_e2[h]&&wp_e2[h].markerDisplay||{};var f=[];var d=[];b.map(q.data.actor.roles||[],function(r){if(r!=""){f.push("echo-item-user-role-"+r);}});var k="";b.map(q.data.actor.markers||[],function(r){if(r!=""){if(r==i.config.get("verifiedUserMarkers")&&!i._isVerifiedCommenter(h,q)){}else{f.push("echo-item-user-marker-"+r);k=m[r]||"";d.push('<div class="marker" title="'+k+'..."><span class="marker echo-item-user-'+r+'" rel="#echo-'+r+'" ></span></div>');}}});if(f.length){b(g).addClass(f.join(" "));}var o=q.view.get("plugin-CardUIShim-header-box");if(o&&o.length>0){b("div.marker",o).remove();o.prepend(d.join(" "));q.view.get("avatar-wrapper").after(o);}var e=false;if(wp_e2&&typeof wp_e2.ignoredUsers!=="undefined"&&wp_e2.ignoredUsers.length>0){for(var n=0;n<wp_e2.ignoredUsers.length;n++){if(wp_e2.ignoredUsers[n]==q.data.actor.id){e=true;break;}}}if(e){b(g).addClass("ignored-comment");if(q.children.length>0){b(g).html('<div class="ignored-comment">You are ignoring a comment from '+q.data.actor.title+" that has these replies.</div>");}else{b(g).empty();}return g;}if(wp_e2[h].includevoteofftopic){var l="flag-offtopic";var j=i.methods._markerCheck(q,l),p=wp_e2["voteSettings_"+l]||{};if(j){if(b(g).find("."+p.markClass+".comment-item-hidden").length==0){b(q.view.get("date")).after('<div class="'+p.markClass+' comment-item-hidden">'+p.markText+"</div>");
}}}return g;};a.component.renderers.content=function(h){var i=this.component;this.parentRenderer("content",arguments);var f=i.config.get("thisContainer");if(wp_e2[f].includevoteofftopic){var d="flag-offtopic",g=[],j=wp_e2["voteSettings_"+d]||{};var e=a.methods._markerCheck(i,d);if(e){g.push(j.markClass);if(g.length){b(h).addClass(g.join(" "));}}}};a.component.renderers.body=function(h){var i=this.component;this.parentRenderer("body",arguments);var d=i.config.get("thisContainer");var g=["img",".echo-item-files"],f=["object","embed","iframe",".echo-item-files"],e=["a"];if(!wp_e2[d].allow_photos){b.each(g,function(j,k){b(k,h).not(".echo-streamserver-controls-stream-item-smiley-icon").remove();});}if(!wp_e2[d].allow_videos){b.each(f,function(j,k){b(k,h).remove();});}if(!wp_e2[d].allow_links){b.each(e,function(j,k){b(k,h).remove();});}};a.component.renderers.buttons=function(e){var f=this.component;this.parentRenderer("buttons",arguments);var d=this;wp_e2._shareRender(e,d);if(e.find(".echo-streamserver-controls-stream-item-button-Edit").length>0){if(!a.methods._editVisible(f)){e.find(".echo-streamserver-controls-stream-item-button-Edit").remove();}else{if(f.itemsRefreshInterval){clearInterval(f.itemsRefreshInterval);}f.itemsRefreshInterval=setInterval(function(){a.methods._refreshItems(f);},30000);}}return e;};a.component.renderers.inlineButtons=function(e){var f=this.component;this.parentRenderer("buttons",arguments);var d=this;wp_e2._shareRender(e,d);if(e.find(".echo-streamserver-controls-stream-item-button-Edit").length>0){if(!a.methods._editVisible(f)){e.find(".echo-streamserver-controls-stream-item-button-Edit").remove();}else{if(f.itemsRefreshInterval){clearInterval(f.itemsRefreshInterval);}f.itemsRefreshInterval=setInterval(function(){a.methods._refreshItems(f);},30000);}}return e;};a.component.renderers.footer=function(d){var e=this.component;this.parentRenderer("footer",arguments);var f=e.view.get("buttons");d.find(".echo-streamserver-controls-stream-item-plugin-LikeCardUI-likesArea").insertAfter(f);return d;};a.component.renderers.avatar=function(f){var g=this.component;this.parentRenderer("avatar",arguments);var d=f.find("div");var e=d.css("background-image");if(e){e.split(",")[0];d.css("background-image",e.replace("'",'"'));}return f;};a.methods._removeIgnoredComments=function(f,e){if(typeof e=="undefined"||typeof f=="undefined"){return;}var d=f.data.actor.title;var g=b(".echo-streamserver-controls-stream-item-authorName:contains('"+d+"')").closest(".echo-streamserver-controls-stream-item-container");b.each(g,function(i,j){var h=b(j);if(h.hasClass("echo-streamserver-controls-stream-item-container-root-thread")){h.addClass("ignored-comment");h.html('<div class="ignored-comment">You are ignoring a comment from '+d+" that has these replies.</div>");}else{h.closest(".echo-streamserver-controls-stream-item ").remove();}});};a.methods._publishEventComplete=function(d){var e=this.component;this.events.publish({"topic":d.topic,"data":d.data});};a.methods._markerCheck=function(f,d){var g=wp_e2.markerSettings,h=wp_e2["voteSettings_"+d]||{},e=false;b.map(f.data.object.markers||[],function(i,j){if(i.indexOf(g.modPrefix+g.delimiter+h.flag)>=0||i.indexOf(g.userPrefix+g.delimiter+h.flag)>=0){e=true;}});return e;};a.methods._markNew=function(d){var e=b(d.item.target);e.mouseenter(function(f){e.animate({"border-left-color":"#ffffff","border-left-width":"0"},800,function(){e.removeClass("newComment");e.unbind("mouseenter");});});e.addClass("newComment");};a.methods._editVisible=function(d){var f=wp_e2.editTime*60*1000;var e=new Date();return wp_e2.allowEdit==true&&(e-(new Date(d.data.postedTime))<f);};a.methods._IgnoreOmniture=function(){var d=wp_e2.debug;var e={};e.eVar26="ignore - user";sendDataToOmniture("echo.ignorecomplete","event74",e);e.eVar26="";};a.methods._shareVisible=function(){var d=this.component;return d.data.target.id!=d.data.target.conversationID;};a.methods._ignoreVisible=function(f){if(typeof f=="undefined"){f=this.component;}var h=wp_e2&&wp_e2.echo_user&&wp_e2.echo_user.get("identityUrl");var e=false;var g=f.data.actor.markers||[];for(var d=0;d<g.length;d++){if((g[d].indexOf("staff")>=0)||(g[d].indexOf("contrib")>=0)){e=true;}}return(wp_e2.echo_user.is("logged")&&(f.data.provider.name!="Arktan")&&(f.data.provider.name!="jskit")&&(h&&h!=f.data.actor.id)&&!e);};a.methods._refreshItems=function(d){if(!a.methods._editVisible(d)){d.view.render({"name":"buttons"});clearInterval(d.itemsRefreshInterval);}};a.methods._isVerifiedCommenter=function(d,f){var e=false;if(wp_e2[d].includeverifiedcommenters==true){if(wp_e2[d].verifiedcommenteridlist&&wp_e2[d].verifiedcommenteridlist.userArray&&wp_e2[d].verifiedcommenteridlist.userArray[f.data.actor.id]&&wp_e2[d].verifiedcommenteridlist.userArray[f.data.actor.id].verification_status==a.labels.verification_complete){e=true;}}return e;};a.methods._processFlag=function(j,i){var n=i.item,f=i.response,l=f.markers;var e="",g="",h=[],k=false;var d=wp_e2.markerSettings,m=wp_e2["voteSettings_"+l]||{};b.each(n.data.object.markers||[],function(o,q){if(q.indexOf(d.counterPrefix+d.delimiter+l)==0){k=true;e=q;var r=q.split(d.delimiter);var p=(parseInt(r[2])||0)+1;h.push(d.counterPrefix+d.delimiter+l+d.delimiter+p);if(p>=m.threshold){h.push(d.votedPrefix+d.delimiter+l);}}});if(k){var i='{"verb": "unmark","target": "'+n.data.object.id+'","markers": "'+e+'"}';b.ajax({"url":wp_e2.metaUrl,"data":{"appkey":wp_e2.appkey,"content":i,"sessionID":wp_e2.echo_user&&wp_e2.echo_user.get("sessionID","")},"dataType":"jsonp"});}else{h.push(d.counterPrefix+d.delimiter+l+d.delimiter+"1");}b.each(h||[],function(o,q){var p='{"verb": "mark","target": "'+n.data.object.id+'","markers": "'+q+'"}';b.ajax({"url":wp_e2.metaUrl,"data":{"appkey":wp_e2.appkey,"content":p,"sessionID":wp_e2.echo_user&&wp_e2.echo_user.get("sessionID","")},"dataType":"jsonp"});});};Echo.Plugin.create(a);})(Echo.jQuery);(function(c){var b=c;var a=Echo.Plugin.manifest("TWP_Stream_Item_Top","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(a)){return;}a.init=function(){var d=this,f=this.component;var e=this.config.get("thisContainer");f.config.set("thisContainer",e);};a.config={"thisContainer":"#echo_container","showCollapsed":true,"includeShowConversation":true};a.component.renderers.content=function(e){var g=this,f=this.component,h=g.config.get("itemId"),d=g.config.get("thisContainer");this.parentRenderer("content",arguments);if(g.config.get("includeShowConversation")!==false){if(f.data.parentUnique.indexOf(f.data.object.context[0].uri)<0&&f.depth==0){b(e).addClass("has-reply-conversation");}}return e;};a.component.renderers.container=function(e){var h=this,g=this.component,i=h.config.get("itemId"),d=h.config.get("thisContainer");this.parentRenderer("container",arguments);if(g.data.object.id==i){b(e).parent(".echo-streamserver-controls-stream-item-plugin-CardUIShim-wrapper").addClass("current-comment");}if(h.config.get("includeShowConversation")!==false){if(g.data.parentUnique.indexOf(g.data.object.context[0].uri)<0&&g.depth==0){var j=(g.data.object.tags&&g.data.object.tags[0]&&g.data.object.tags[0].split("_")[1])?g.data.object.tags[0].split("_")[1]:"in reply to ";var f=' <div class="replyto-link">'+'<a class="replyto" ><span class="replyto-text">Show conversation</span>'+"</a>"+"</div>";b(e).prepend(f);b(".replyto",b(e)).on("click",function(){h._loadReplyConversation(d,h,e,g.data.object.id);});}}return e;};a.component.renderers.authorName=function(e){var h=this,g=this.component,i=h.config.get("itemId"),d=h.config.get("thisContainer");this.parentRenderer("authorName",arguments);if(g.data.object.id==i){b(e).parent(".echo-streamserver-controls-stream-item-plugin-CardUIShim-wrapper").addClass("current-comment");}if(h.config.get("includeShowConversation")!==false){if(g.data.parentUnique.indexOf(g.data.object.context[0].uri)<0){var j=(g.data.object.tags&&g.data.object.tags[0]&&g.data.object.tags[0].split("_")[1])?g.data.object.tags[0].split("_")[1]:"in reply to ";
var f=' <div class="replyto-text">'+'<span class="fa fa-share"> '+j+"</span>"+"</div>";b(e).append(f);}}return e;};a.component.renderers.subwrapper=function(f){var h=this,g=this.component,e=g.config.get("thisContainer");this.parentRenderer("subwrapper",arguments);if(h.config.get("showCollapsed")===false){return;}var i=g.view.get("content");if(g.depth==0&&g.children.length>0){if(!i.hasClass("collapsed")&&!i.hasClass("expanded")){i.addClass("collapsible collapsed");}var d=g.view.get("subwrapper");d.append('<div class="view-replies collapsed">See Replies<span class="fa fa-chevron-down icon-chevron-down"></span></div>');d.append('<div class="view-replies expanded">Hide Replies<span class="fa fa-chevron-up icon-chevron-up"></span></div>');b(".view-replies",d).on("click",function(){if(b(this).hasClass("collapsed")){b(this).closest(".echo-streamserver-controls-stream-item-content.collapsible").addClass("expanded").removeClass("collapsed");}else{b(this).closest(".echo-streamserver-controls-stream-item-content.collapsible").addClass("collapsed").removeClass("expanded");}});}};a.methods._loadReplyConversation=function(j,k,i,m){var n=k.component;var j=k.config.get("thisContainer");var d='<div class="reply-conversation expanded" style="display:none;">'+'<div class="reply-conversation-buffer"></div>'+'<div class="reply-conversation-close">Hide conversation</div>'+'<div class="reply-conversation-container"></div>'+"</div>";var h=b(d);var f=[];f=f.concat([{"name":"Like"},{"name":"CommunityFlagCardUI","showUserList":false},{"name":"CardUIShim","collapsedContentHeight":280,"labels":{"seeMore":"See More"}}]);f=f.concat(wp_e2[j].plugins.streamPluginArray);f=f.concat([{"name":"TWP_Stream_Item_Top","thisContainer":j,"showCollapsed":false,"itemId":m,"includeShowConversation":false}]);var e=b.extend({},wp_e2[j].streamSettings,wp_e2[j].streamSettings.top,{"target":h.find(".reply-conversation-container"),"query":wp_e2.getQuery(wp_e2[j].guid,j,n.data.targets[0].id,wp_e2[j].verifiedcommenteridlist.idlist,"top"),"apiBaseURL":wp_e2.apiBaseURL+"/v1/","plugins":f,"state":{"label":{"icon":false,"text":false}}});var g=new Echo.StreamServer.Controls.Stream(e);var l={"replyStream":g,"thisContainer":j,"element":i};h.find(".reply-conversation-close").on("click",l,function(o){b(this).parent(".reply-conversation.expanded").slideUp("fast",function(){o.data.element.parents(".echo-streamserver-controls-stream-item-content").slideDown("slow");o.data.replyStream.destroy();b(this).remove();});});b(i).parents(".echo-streamserver-controls-stream-item-content").slideUp("slow",function(){b(i).parents(".echo-streamserver-controls-stream-item").prepend(h);h.slideDown("slow");});};Echo.Plugin.create(a);})(Echo.jQuery);(function(c){var b=c;var a=Echo.Plugin.manifest("TWP_My_Comments","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(a)){return;}a.init=function(){var d=this,f=this.component;var e=this.config.get("thisContainer");this.extendTemplate("insertBefore","buttons",a.templates.accumulators);f.config.set("thisContainer",e);if(e&&wp_e2[e]&&wp_e2[e].includeshare){f.addButtonSpec(this.name,this._assembleButton("share"));}};a.config={"thisContainer":"#echo_container","includeshare":true,"ignoreuser":true,"zebraCount":0};a.labels={"share":"Share"};a.events={"Echo.StreamServer.Controls.Stream.Item.onAdd":function(d,e){},"Echo.StreamServer.Controls.Stream.Item.onButtonClick":function(d,e){},"Echo.UserSession.onInit":function(d,e){}};a.templates.accumulators=function(){return'<div class="echo-flag-container" style="display:inline;">'+'<div class="{plugin.class:likesIndicator}"></div>'+'<div class="{plugin.class:childrenIndicator}"></div>'+"</div>";};a.component.renderers.avatar=function(d){b(d).remove();};a.component.renderers.authorName=function(d){var e=this.component;this.parentRenderer("authorName",arguments);if(e.data.actor.title==wp_e2.echo_user.get("username")){b(d).html("You");}if(e.depth===0){b(d).remove();}};a.component.renderers.buttons=function(e){var f=this.component;this.parentRenderer("buttons",arguments);var d=this;wp_e2._shareRender(e,d);if(e.find(".echo-streamserver-controls-stream-item-button-Edit").length>0){if(!a.methods._editVisible(f)){e.find(".echo-streamserver-controls-stream-item-button-Edit").remove();}else{if(f.itemsRefreshInterval){clearInterval(f.itemsRefreshInterval);}f.itemsRefreshInterval=setInterval(function(){a.methods._refreshItems(f);},30000);}}return e;};a.component.renderers.children=function(d){var e=this.component;this.parentRenderer("children",arguments);if(!TWP.isSignedIn()||(TWP.isSignedIn()&&wapoIdentity&&!wapoIdentity.isMemberOfCommentingGroup())){c(e.view.get("plugin-Reply-replyForm")).find("echo-streamserver-controls-submit-body").remove();}};a.component.renderers.expandChildrenLabel=function(e){var f=this.component;this.parentRenderer("expandChildrenLabel",arguments);var d=f.data.object.accumulators.repliesCount;if(d>0){e.css("display","none");}};a.renderers.childrenIndicator=function(h){var i=this.component;if(!i.data.object.accumulators.repliesCount){h.remove();return;}var e=i.data.object.accumulators.repliesCount;if(e>0){var g=i;var d=d||{};d.state=d.state||"regular";var f={"loading":{"css":"echo-item-message-loading","label":"loading"},"regular":{"css":"echo-linkColor echo-message-icon","label":"childrenMoreItems"}};h.html(e+((e>1)?" Replies":" Reply"));h.html('<a href="javascript:void();">'+e+((e>1)?" Replies <span class='children-arrow'>&#9660;</span>":" Reply <span class='children-arrow'>&#9660;</span></a>"));h.addClass("closed").removeClass("open");h.find(".children-arrow").html("&#9660;");h.closest(".echo-streamserver-controls-stream-item-content").find(".echo-streamserver-controls-stream-item-children").hide();h.closest(".echo-streamserver-controls-stream-item-content").find(".echo-streamserver-controls-stream-item-expandChildren").hide();h.bind("click",function(j){j.stopPropagation();if(h.hasClass("open")){h.addClass("closed").removeClass("open");h.find(".children-arrow").html("&#9660;");h.closest(".echo-streamserver-controls-stream-item-content").find(".echo-streamserver-controls-stream-item-children").hide();h.closest(".echo-streamserver-controls-stream-item-content").find(".echo-streamserver-controls-stream-item-expandChildren").hide();}else{if(h.hasClass("closed")){h.addClass("open").removeClass("closed");h.find(".children-arrow").html("&#9650;");h.closest(".echo-streamserver-controls-stream-item-content").find(".echo-streamserver-controls-stream-item-children").show();h.closest(".echo-streamserver-controls-stream-item-content").find(".echo-streamserver-controls-stream-item-expandChildren").show();h.closest(".echo-streamserver-controls-stream-item-content").find(".echo-streamserver-controls-stream-item-expandChildrenLabel").show();h.closest(".echo-streamserver-controls-stream-item-content").find(".echo-streamserver-controls-stream-item-expandChildrenLabel.echo-streamserver-controls-stream-item-message-loading").hide();}}});}else{h.remove();}};a.renderers.likesIndicator=function(d){var g=this,f=this.component;if(!f.data.object.accumulators.likesCount){d.remove();return;}var e=f.data.object.accumulators.likesCount;if(e>0){d.css("display","block");d.html(e+((e>1)?" Likes":" Like"));}else{d.remove();}};a.component.renderers.container=function(d){var e=this.component;if(e.depth==1){d.find(".echo-item-footer").prepend('<div class="echo-item-authorname">'+e.data.actor.title+"</div> responded on ");}};a.component.renderers.content=function(d){var e=this.component;this.parentRenderer("content",arguments);};a.component.renderers.date=function(i){var n=this.component;this.parentRenderer("date",arguments);var j=n.config.get("thisContainer");var g=(typeof n.data.object.markers!="undefined")?n.data.object.markers.join():"";var h=new Date();h.setISO8601(n.data.object.published);var k=h.format("h:MM TT Z");var l=h.format("m/d/yyyy h:MM TT Z");var o=(typeof n.data.object.markers!="undefined"&&g.indexOf("photo")>=0);if(wp_e2[j].includepermalink&&!o&&(n.data.target.id!=n.data.target.conversationID&&n.data.target.id==n.data.object.context[0].uri)){var f=n.data.object.id;
f=f.replace("http://","");var e=n.data.object.context[0].uri.replace(/_story.html|_blog.html/,"_comment.html");var d='<a href="'+e+"?commentID="+f+'">'+k+"</a>";var m='<a href="'+e+"?commentID="+f+'">'+l+"</a>";(h.format("m/d/yyyy")==new Date().format("m/d/yyyy"))?b(i).html(d):b(i).html(m);}else{(h.format("m/d/yyyy")==new Date().format("m/d/yyyy"))?b(i).html(k):b(i).html(l);}this.component.view.get("data").after(i);i.after(this.component.view.get("re"));return i;};a.component.renderers.re=function(f){var g=this.component;var d=this.parentRenderer("re",arguments);if(typeof d!="undefined"){if(g.data.parentUnique.indexOf(g.data.object.context[0].uri)<0){var e=g.data.target.id;e=e.replace("http://","");var h=g.data.object.context[0].uri.replace(/_.*html/,"_comment.html");d.html(" in reply to "+'<div class="echo-streamserver-controls-stream-item-re-container"><a href="'+h+"?commentID="+e+'">this comment</a></div>');}else{d.html(" on "+d.html());}}return f;};a.component.renderers.text=function(d){var e=this.component;this.parentRenderer("text",arguments);d.find(".echo-item-photo img").each(function(f,i){var g=b(i);g.attr("src",g.attr("data-src-preview"));d.find(".echo-item-files").append('<div class="photo-caption">'+g.attr("alt")+"</div>");var h=d.find(".echo-item-photo");h.attr("rel","#simple-overlay");h.attr("href",g.attr("data-src-web"));h.find("a").remove();h.append(g);});};a.methods._assembleButton=function(d){var f=this,e=this.component;switch(d){case"share":return function(){var g=this;return{"name":d,"label":f.labels.get(d),"visible":f._shareVisible()};};break;}};a.methods._editVisible=function(d){var f=wp_e2.editTime*60*1000;var e=new Date();return wp_e2.allowEdit==true&&(e-(new Date(d.data.postedTime))<f);};a.methods._shareVisible=function(){var d=this.component;return d.data.target.id!=d.data.target.conversationID;};Echo.Plugin.create(a);})(Echo.jQuery);(function(b){var a=Echo.Plugin.manifest("TWP_Conversations_App","Echo.Apps.Conversations");a.init=function(){var c=this,e=this.component;var d=this.config.get("thisContainer");e.config.set("thisContainer",d);Echo.Labels.set({"live":"Pause live updates","paused":"Resume live updates"},"Echo.Apps.Conversations");};a.config={"thisContainer":"#echo_container"};a.events={"Echo.Apps.Conversations.onRender":function(d,f){var e=this.component;var c=e.view.get("container");}};a.component.renderers.container=function(e){var c=this,f=this.component;this.parentRenderer("postComposer",arguments);var d=this.component.config.get("thisContainer");if(wp_e2[d].includeverifiedcommenters===true){b(e).addClass("verified-commenters");}e.off("TWP.Comments.RequestRefresh");e.on("TWP.Comments.RequestRefresh",function(h,k){try{h.stopPropagation();h.stopImmediatePropagation();if(wp_e2[d].guid!==k.url){wp_e2[d].guid=k.url;wp_e2[d].allow_comments=(k.allow_comments||false);var g=b("#"+d);wp_e2._getNotes(g);wp_e2.renderCommentCount(g);var n=f.getComponent("allPosts");if(typeof n!="undefined"){n.destroy();}var j=f.getComponent("topPosts");if(typeof j!="undefined"){j.destroy();}var m=f.config.get("postComposer");m.visible=wp_e2[d].allow_comments;var i=f.config.get("allPosts").queryOverride;f.config.get("allPosts").queryOverride=i.replace(/childrenof: \S+/,"childrenof: "+k.url);i=f.config.get("topPosts").queryOverride;f.config.get("topPosts").queryOverride=i.replace(/scope: \S+/,"scope: "+k.url);f.config.set("targetURL",k.url);f.config.remove("data");f.refresh();}jQuery(window.document).trigger("TWP.Comments.RefreshComplete");}catch(l){}});};a.component.renderers.postComposer=function(d){this.parentRenderer("postComposer",arguments);var c=this.component.config.get("thisContainer");if(wp_e2[c].allow_comments!=true&&!b("#"+c).hasClass("permalink")){b(d).prepend(b('<div class="closed"> <span>Comments are closed.</span></div>'));}return d;};a.component.renderers.streamingStateContainer=function(d){var c=this.component.config.get("thisContainer");if(wp_e2[c].includepause!==true){b(d).remove();return;}this.parentRenderer("streamingStateContainer",arguments);return d;};a.component.renderers.streamingState=function(d){var c=this.component.config.get("thisContainer");if(wp_e2[c].includepause!==true){b(d).remove();return;}this.parentRenderer("streamingState",arguments);if(this.component.get("streamingState")=="live"){d.append('<span class="fa fa-pause"></span>');}else{d.append('<span class="fa fa-play"></span>');}return d;};a.component.renderers.topPostsHeader=function(c){this.parentRenderer("topPostsHeader",arguments);b(c).find(".echo-apps-conversations-streamHeader").append('<li class="pull-right"><span><a class="fa fa-info-circle" href="http://www.washingtonpost.com/blogs/ask-the-post/wp/2014/02/27/comments-what-is-a-preferred-commenter/" target="_new"></a></span></li>');};a.component.renderers._streamSorter=function(d,c){this.parentRenderer("_streamSorter",arguments);if(d.find(".dropdown-toggle .fa").length==0){d.find(".dropdown-toggle").append('<i class="fa fa-caret-down icon-chevron-down"></i>');}d.find(".dropdown-menu").removeClass("pull-right").addClass("pull-left");d.removeClass("pull-right").addClass("pull-left");return d;};a.component.renderers.allPostsContainer=function(g){this.parentRenderer("allPostsContainer",arguments);var e=this.component.config.get("thisContainer");if(wp_e2[e].includevoteofftopic===true){var c="flag-offtopic",f=b(g);var h=wp_e2["voteSettings_"+c]||{},d=wp_e2._getCookie(h.cookie);if(b("#"+e+" .control-"+c).length==0){if(d=="hiding"){b("#"+e+" .echo-streamserver-controls-stream").addClass(h.markClass+"-hidden");}f.prepend('<div class="control-'+c+'">'+'<span class="comment-'+h.markClass+"-state "+d+'">'+((d=="hiding")?h.controlTextHiding:h.controlTextShowing)+"</span>");f.find(".comment-"+h.markClass+"-state").bind("click",function(i){i.stopPropagation();var j=b(i.target);e=b(this).closest(".echo_container").attr("id");if(j.hasClass("hiding")){j.removeClass("hiding").html(h.controlTextShowing);b("#"+e+" .echo-streamserver-controls-stream").removeClass(h.markClass+"-hidden");var k={expires:-1,domain:"."+window.document.domain,path:"/"};wp_e2._setCookie(h.cookie,null,k);}else{j.addClass("hiding").html(h.controlTextHiding);b("#"+e+" .echo-streamserver-controls-stream").addClass(h.markClass+"-hidden");var k={domain:"."+window.document.domain,path:"/"};wp_e2._setCookie(h.cookie,"hiding",k);}});}}return g;};a.component.renderers.streamHeader=function(e){this.parentRenderer("streamHeader",arguments);var c=this.component.config.get("thisContainer");var d=this.component.view.get("streamingStateContainer");var f=b('<li class="pull-right"></li>').prepend(d);b(e).append(f);return e;};Echo.Plugin.create(a);})(Echo.jQuery);(function(b){var a=Echo.Plugin.manifest("PageVisibilityDetector","Echo.StreamServer.Controls.Stream");if(Echo.Plugin.isDefined(a)){return;}a.events={"Echo.Control.onDestroy":function(){clearInterval(this.component.itemsRefreshInterval);},"Echo.StreamServer.Controls.Stream.onReady":function(){var c=this,e=this.component,d;this._reactOnPageVisibilityChanges(function(){var f=c._getTS();if(f-d<10*60){e.request.liveUpdates.start();}else{clearInterval(e.itemsRefreshInterval);e.refresh();}},function(){d=c._getTS();e.request.liveUpdates.stop();});}};a.methods._getTS=function(){return Math.round((new Date()).valueOf()/1000);};a.methods._reactOnPageVisibilityChanges=function(g,e){var d=this;var f=this._getHiddenProp();if(f){var c=f.replace(/[H|h]idden/,"")+"visibilitychange";document.addEventListener(c,function(){if(d._isHidden()){e();}else{g();}});}};a.methods._getHiddenProp=function(){var d=["webkit","moz","ms","o"];if("hidden" in document){return"hidden";}for(var c=0;c<d.length;c++){if((d[c]+"Hidden") in document){return d[c]+"Hidden";}}return null;};a.methods._isHidden=function(){var c=this._getHiddenProp();return c?document[c]:false;};Echo.Plugin.create(a);})(Echo.jQuery);(function(c){var b=c;var a=Echo.Plugin.manifest("TWP_Share","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(a)){return;}a.init=function(){var e=this.component;
var d=this.config.get("thisContainer");e.config.set("thisContainer",d);if(d&&wp_e2[d].includeshare&&e.config.get("intentID")!="Reply"&&typeof FB=="object"){this.extendTemplate("insertBefore","postButton",a.templates.share);}};a.config={"thisContainer":"#echo_container","includeshare":false};a.templates.share=function(){if(wp_e2&&wp_e2.echo_user&&wp_e2.echo_user.is("logged")&&b("#ugc-photo-gallery").length==0){return'<div class="echo_share-text"><p>Sharing Off</p></div>'+'<div class="echo_share-fb-button {plugin.class:share}" id="social-share-fb"><div class="share-click-div"><div class="fa-facebook"></div></div></div>';}else{return"";}};a.events={"Echo.StreamServer.Controls.Submit.onPostComplete":function(f,e){var d=b(e.target).closest(".echo_container").attr("id");if(b("#"+d+" .echo_share-fb-button.active").length>0&&!e.inReplyTo){if(typeof window.FB=="object"){var g={method:"feed",link:wp_e2[d].guid,name:document.title,picture:(typeof b("meta[property=og\\:image]").attr("content")!="undefined")?b("meta[property=og\\:image]").attr("content"):"",caption:"I just commented on washingtonpost.com: ",description:'"'+e.postData.content[0].object.content+'"'};if(wp_e2[d].display_ugc_photos===true){g.caption=b(e.postData.content[0].object.content).find("img").attr("alt");g.description="";}a.config.fb_callback_container=d;FB.ui(g,a.methods._FBCallback);}}},"Echo.StreamServer.Controls.Submit.onRender":function(e,d){},"Echo.StreamServer.Controls.Submit.onRerender":function(e,d){}};a.renderers.share=function(d){var e=this,f=e.component;d.click(function(h){var g=b(".share-click-div",d);if(g.hasClass("active")){d.removeClass("active");g.removeClass("active");d.parent().find(".echo_share-text").empty().html("<p>Sharing Off</p>");}else{d.addClass("active");g.addClass("active");d.parent().find(".echo_share-text").empty().html("<p>Sharing On</p>");}});};a.methods._FBCallback=function(){var e={},d=a.config.fb_callback_container;e.eVar26=(wp_e2[d].display_ugc_photos===true)?"submit - ugc":"submit - comments";sendDataToOmniture("echo.fbsharecomplete","event29",e);debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Post COmplete: omniture event3");e.eVar26="";a.config.fb_callback_container=null;};Echo.Plugin.create(a);})(Echo.jQuery);(function(c){var b=c;var a=Echo.Plugin.manifest("TWP_formAuth","Echo.StreamServer.Controls.CardUIAuth");a.init=function(){var d=this,f=this.component;var e=this.config.get("thisContainer");f.config.set("thisContainer",e);};a.labels={"viewProfile":"View Profile","viewMyComments":"View My Comments","ignoreUsers":"Stop Ignoring Users","logout":"Sign Out","login":"Sign In","anonUserMessage":'<span><a class="signin" href="">Please Sign In to Comment</a></span>',"notCommenterUserMessage":'<span>Your profile is incomplete. Please <a class="verify" href="">update it in order to comment</a>.</span>'};a.config={"dropdownEntries":[{"visible":true,"title":a.labels["viewProfile"],"handler":function(){window.location.href=wp_e2.profileURL+encodeURIComponent((window.location.href.split("?")[0]))+"&commenting=1";}},{"visible":true,"title":a.labels["viewMyComments"],"handler":function(){window.location.href="http://"+window.location.hostname+"/mycomments";}},{"visible":true,"title":a.labels["ignoreUsers"],"handler":function(){window.location.href="http://"+window.location.hostname+"/mycomments#myignoredusers";}},{"visible":true,"title":a.labels["logout"],"handler":function(){Backplane.resetCookieChannel();window.location.href=TWP.signin.logouturl_page;}}]};a.component.renderers.userAnonymous=function(e){var f=this,d=this.component;this.parentRenderer("userAnonymous",arguments);this.component.view.get("or").hide();this.component.view.get("signup").hide();this.component.view.get("login").remove();if(wp_e2._isUserSynced()){if(TWP.isSignedIn()&&wapoIdentity&&!wapoIdentity.isMemberOfCommentingGroup()){e.prepend(f.labels.get("notCommenterUserMessage"));}else{e.prepend(f.labels.get("anonUserMessage"));}e.on("click","a",function(g){var h=b(g.target);if(h.hasClass("signin")){window.location.href=wp_e2.logInURL+encodeURIComponent(window.location.href);return false;}if(h.hasClass("register")){window.location.href=wp_e2.registerURL+encodeURIComponent(window.location.href);return false;}if(h.hasClass("verify")){window.location.href=wp_e2.profileURL+encodeURIComponent((window.location.href.split("?")[0]))+"&commenting=1";return false;}});}};a.component.renderers.name=function(g){var e=this,f=this.component;this.parentRenderer("name",arguments);var h='<span class="{class:dropdown}"></span>';var d=this.config.get("dropdownEntries");new Echo.GUI.Dropdown({"target":g,"title":f.user.get("name","")+e.substitute({"template":h}),"extraClass":"nav","entries":b.grep(d,function(i){return !!i.visible;})});g.find(".echo-streamserver-controls-carduiauth-dropdown").addClass("caret");return g;};a.component.renderers.via=function(d){d.remove();};a.component.renderers.userLogged=function(f){var d=this,e=this.component;this.parentRenderer("userLogged",arguments);f.find(".echo-clear").remove();};Echo.Plugin.create(a);})(Echo.jQuery);(function(c){var b=c;var a=Echo.Plugin.manifest("TextCounter","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(a)){return;}a.init=function(){this.extendTemplate("insertAfter","postContainer",a.templates.counter);};a.events={"Echo.StreamServer.Controls.Submit.onPostComplete":function(e,d){this.view.render({"name":"counterLabel"});}};a.labels={"limited":"{typed}/{left}","unlimited":"{typed}"};a.templates.counter='<div class="{plugin.class:counterLabel} echo-primaryFont echo-primaryColor"></div><div class="controls-divider"><div class="controls-inner-divider"></div></div>';a.component.renderers.text=function(e){var g=this;g.parentRenderer("text",arguments);var d=g.config.get("limit",0);var f=function(){if(d){var h=e.val();if(h.length<=d){g.set("text",h);}else{if(h.length>d){e.val(g.get("text"));return;}}}g.view.render({"name":"counterLabel"});};return e.on("blur focus keyup keypress",f);};a.renderers.counterLabel=function(f){var g=this,h=this.component;var d=g.config.get("limit",0);var i=(h.view.get("text")&&h.view.get("text").val())?h.view.get("text").val().length:0;var e=g.labels.get(g.config.get("label",d?"limited":"unlimited"),{"typed":i,"left":Math.max(d-i,0),"limit":d});return f.text(e);};Echo.Plugin.create(a);})(Echo.jQuery);(function(c){var b=c;var a=Echo.Plugin.manifest("TWP_Submit","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(a)){return;}a.init=function(){var d=this,f=this.component;var e=this.config.get("thisContainer");f.config.set("thisContainer",e);if(e&&wp_e2[e].includevoteofftopic){this.extendTemplate("insertAsFirstChild","controls",a.templates.usermarkOfftopic);}f.addPostValidator(function(){});};a.config={"thisContainer":"#echo_container","includeshare":false,"overlayConfig":{mask:{color:"#000000",loadSpeed:200,opacity:0.5},top:"10%",left:"center",closeOnClick:true,closeOnEsc:true,onBeforeLoad:function(){b(this.getTrigger().attr("rel")).find("iframe").attr("src",this.getTrigger().attr("href"));}},"verification_status":{"display_warning":false,"notCommenterUserWarning":'<div class="echo-feature-notification">Your profile is incomplete. Please  <a class="verify" href="'+wp_e2.profileURL+(window.location.href.split("?")[0])+'&commenting=1">update it in order to comment.</a>.<div class="echo-close"></div></div>',"verified_commenter_cookie":"commenting_verified"}};a.labels={"usermark_offtopic_text":"Off-topic","usermark_offtopic_value":"user__flag-offtopic","marker_photo":"photo","marker_video":"video","marker_link":"link"};a.templates.usermarkOfftopic=function(){if(wp_e2&&wp_e2.echo_user&&wp_e2.echo_user.is("logged")&&b("#ugc-photo-gallery").length==0&&this.component.config.get("name")!=="Reply"){return'<div class="{plugin.class:userMarkOfftopic}">'+'<input type="checkbox" name="usermark" value="'+a.labels.usermark_offtopic_value+'">'+a.labels.usermark_offtopic_text+"</div>"+'<div class="controls-divider"><div class="controls-inner-divider"></div></div>';
}else{return"";}};a.events={"Echo.StreamServer.Controls.Submit.onPostComplete":function(e,d){b(d.target).find("input").prop("checked",false);},"Echo.StreamServer.Controls.Submit.onPostInit":function(e,d){},"Echo.StreamServer.Controls.Submit.onRender":function(h,g){var f=this.config.get("thisContainer");var e=b(".utils .echo-feature-notification");if(wp_e2[f].includefeaturenotification!==false&&e.length>0&&(typeof g.inReplyTo=="undefined")&&b(".echo-apps-conversations-postComposer .echo-feature-notification").length===0){var d=e.clone().insertAfter(b(".echo-streamserver-controls-submit-container",g.target));d.find(" .echo-close").click(function(){b(this).parent().fadeOut("slow");});}if(wp_e2[f].includefeaturenotification!==false&&wp_e2._isUserSynced()&&TWP.isSignedIn()&&wapoIdentity&&!wapoIdentity.isMemberOfCommentingGroup(a.config["verification_status"]["verified_commenter_cookie"])&&(typeof g.inReplyTo=="undefined")&&a.config["verification_status"]["display_warning"]===true){var d=b(a.config["verification_status"]["notCommenterUserWarning"]).insertAfter(b(".echo-streamserver-controls-submit-container",g.target));d.find(" .echo-close").click(function(){b(this).parent().fadeOut("slow");});}if(wp_e2[f].allow_comments!=true&&!b("#"+f).hasClass("permalink")){b('<div class="closed"> <span>Comments are closed.</span></div>').insertAfter(b(".echo-streamserver-controls-submit-container",g.target));}},"Echo.StreamServer.Controls.Submit.onRerender":function(e,d){}};a.component.renderers.container=function(h){var k=this,n=this.component;this.parentRenderer("container",arguments);var i=n.config.get("thisContainer");if(!wp_e2._isUserSynced()||!TWP.isSignedIn()||(TWP.isSignedIn()&&wapoIdentity&&!wapoIdentity.isMemberOfCommentingGroup())||wp_e2.echo_user.userSuspended||(!(b("#"+i).hasClass("submitbox")||b("#"+i).hasClass("permalink"))&&n.config.get("name")!="Reply")){n.view.get("body").remove();n.view.get("controls").remove();}else{var e=b('<div class="submit-controls-outer-wrapper"></div>');n.view.get("header").after(e);e.append(n.view.get("body"));e.append(n.view.get("controls"));e.after('<div class="clearfix"></div>');}if(wp_e2.echo_user.userSuspended){var g=wp_e2["suspend_user_markers"]||{},j=wp_e2["suspend_type_text"]||{},d=false,l="",f="";var p=(wp_e2._isUserSynced()&&wp_e2.echo_user.is("logged")&&wp_e2.echo_user.get("markers")||[]);b.each(g,function(q,r){if(b.inArray(q,p)>=0){l=q;return;}});b.each(j,function(q,r){if(b.inArray(q,p)>=0){f=q;return;}});var m=j[f];var o='<div class="echo-feature-notification suspended"><i class="fa fa-exclamation"></i>'+'<div class="notification-text"><p>'+((typeof m!="undefined")?m:j["default"])+wp_e2["suspend_core_text"]+"</p>"+"<p>"+g[l]+"</p></div>"+"</div>";n.view.get("header").after(o);}};a.component.renderers.text=function(f){var g=this,e=this.component;if(e.data&&e.data.object&&e.data.object.content){e.data.object.content="";}this.parentRenderer("text",arguments);var d=this.config.get("thisContainer");e.view.get("text").on({focus:function(){b(this).closest(".submit-controls-outer-wrapper").addClass("active");}});};a.component.renderers.markers=function(f){var g=this,e=this.component;this.parentRenderer("markers",arguments);var d=this.config.get("thisContainer");this.component.view.get("markers").val(this.component.view.get("markers").val()+","+wp_e2[d].submitMarkers.join(","));};a.component.renderers.tags=function(f){var g=this,e=this.component;this.parentRenderer("tags",arguments);if(e.config.get("name")&&e.config.get("name").indexOf("Reply")>=0){var d=e.view.get("tags").val().split(",");d.push("replyto_"+g.component._prepareEventParams().inReplyTo.actor.title);e.view.get("tags").val(d.join(","));}};a.renderers.userMarkOfftopic=function(d){var f=this,e=this.component;d.find("input").on("change",e,function(j){var g=this.value,k=e.view.get("markers").val(),i=[];if(this.checked){var h=k.split(",");h.push(g);}else{k=k.replace(new RegExp(g,"g"),"").trim();var h=k.split(",");}b.each(h,function(l,m){if(m!==""){i.push(m);}});e.view.get("markers").val(i.join(","));});};Echo.Plugin.create(a);})(Echo.jQuery);(function(c){var b=c;var a=Echo.Plugin.manifest("TWP_Edit","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(a)){return;}a.init=function(){var d=this,f=this.component;var e=this.config.get("thisContainer");f.config.set("thisContainer",e);};a.config={"thisContainer":"#echo_container","editMarker":["edited"]};a.events={"Echo.StreamServer.Controls.Submit.onPostComplete":function(g,f){var d=this;var e=d.config.get("thisContainer");var h=d.config.get("editMarker");b.each(h||[],function(i,k){var j='{"verb": "mark","target": "'+f.targetURL+'","markers": "'+k+'"}';b.ajax({"url":wp_e2.metaUrl,"data":{"appkey":wp_e2.appkey,"content":j,"sessionID":wp_e2.echo_user&&wp_e2.echo_user.get("sessionID","")},"dataType":"jsonp"});});}};Echo.Plugin.create(a);})(Echo.jQuery);(function(c){var b=c;var a=Echo.Plugin.manifest("TWP_Submit_VerifiedCommenter","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(a)){return;}a.init=function(){var d=this,h=this.component;var e=this.config.get("thisContainer");d.config.set("thisContainer",e);var g=document.createElement("input");d.config.set("isPlaceholder",("placeholder" in g));var f=(typeof d.config.get("userMarkers")=="undefined "||d.config.get("userMarkers")==null)?d.config.get("userMarkers"):d.config.get("userMarkers");if(d.config.get("isVerifiedCommenterForm")===true){this.extendTemplate("replace","textArea",a.contentTemplate);h.validators=[];h.addPostValidator(function(){var k=h.config.get("thisContainer"),m=h.view.get("text"),j=false;var l=h.view.get("content").find(".echo-streamserver-controls-submit-plugin-TWP_Submit_VerifiedCommenter-topCommenterForm");l.find("input").removeClass("echo-streamserver-controls-submit-mandatory");if(l.find('input[name="fullName"]').val().length==0){l.find('input[name="fullName"]').addClass("echo-streamserver-controls-submit-mandatory");j=true;}else{l.find('input[name="fullName"]').removeClass("echo-streamserver-controls-submit-mandatory");}if(l.find('input[name="phoneNumber"]').val().length==0){l.find('input[name="phoneNumber"]').addClass("echo-streamserver-controls-submit-mandatory");j=true;}else{l.find('input[name="phoneNumber"]').removeClass("echo-streamserver-controls-submit-mandatory");}if(l.find('textarea[name="address"]').val().length==0){l.find('textarea[name="address"]').addClass("echo-streamserver-controls-submit-mandatory");j=true;}else{l.find('textarea[name="address"]').removeClass("echo-streamserver-controls-submit-mandatory");}if(l.find('input[name="email"]').val().length==0){l.find('input[name="email"]').addClass("echo-streamserver-controls-submit-mandatory");j=true;}else{l.find('input[name="email"]').removeClass("echo-streamserver-controls-submit-mandatory");}if(!l.find('input[name="agreetopolicy"]').prop("checked")){l.find("div.agreetopolicy").addClass("echo-streamserver-controls-submit-mandatory");j=true;}else{l.find("div.agreetopolicy").removeClass("echo-streamserver-controls-submit-mandatory");}if(j){return false;}var i="";b.each(l.find("input, textarea"),function(n,o){i=i+o.getAttribute("name")+":  "+o.value+"\n";});m.val(i);return true;},"high");}else{this.extendTemplate("insertAsFirstChild","container",a.templates.verifiedCommenterCheckbox);}};Echo.Events.subscribe({"topic":"TWP.Badge.Request.Complete","context":"global","handler":function(g,i){if(i&&i.echocontainer){var f=i.echocontainer;if(wp_e2[f].includeverifiedcommenters===true&&wp_e2.echo_user){if(wp_e2[f].verifiedcommenteridlist&&(wp_e2[f].verifiedcommenteridlist.userArray&&wp_e2[f].verifiedcommenteridlist.userArray[wp_e2.echo_user.get("identityUrl")])){var e=wp_e2[f].verifiedcommenteridlist.userArray[wp_e2.echo_user.get("identityUrl")].verification_status;var d=b("#"+f+" .echo-streamserver-controls-submit-container.original-submit");var h=d.find(".echo-streamserver-controls-submit-plugin-TWP_Submit_VerifiedCommenter-verifiedCommenterRequest");h.find("a").remove();h.append('<span class="verification-status">'+a.labels[e]+"</span>");
}}}}});a.config={"thisContainer":"#echo_container","userMarkers":"verified_preferred","addVerifiedCommenterRequest":true,"isVerifiedCommenterForm":false,"verifiedCommenterRequestTarget":"echo-apps-conversations-postComposer","verifiedCommenterSubmitTarget":"echo-topcommenter-form","overlayConfig":{mask:{color:"#000000",loadSpeed:200,opacity:0.5},top:"10%",left:"center",closeOnClick:true,closeOnEsc:true,onBeforeLoad:function(){b(this.getTrigger().attr("rel")).find("iframe").attr("src",this.getTrigger().attr("href"));}}};a.labels={"topComments":"Top Comments","verifiedinput_value":"verified_manual_request","verifiedinput_text":'<span>Mentioned in this story and want to comment? <strong>Click here</strong> <i class="caret"></i></span>',"verifiedinput_text_anon":'<span>Mentioned in this story and want to comment? <a href="http://www.washingtonpost.com/blogs/ask-the-post/wp/2014/02/27/comments-what-is-a-preferred-commenter/" target="_policy">Learn more</a></span>',"verifiedinput_description":"<p><b>Are you mentioned in this story?</b></p><p>We need to verify your identity. Please provide the following info: </p>","verification_request":"Your verification request has been received.","verification_processing":"Your verification request is being reviewd.","verification_approved":"Your verification request has been approved.","verification_denied":"Your verification request has not been approved.","none":""};a.events={"Echo.StreamServer.Controls.Submit.onRender":function(d,e){},"Echo.StreamServer.Controls.Submit.onPostInit":function(d,e){},"Echo.StreamServer.Controls.Submit.onPostComplete":function(f,g){var d=this;var e=d.config.get("thisContainer");if(b(g.target).hasClass(d.config.get("verifiedCommenterSubmitTarget"))){b(g.target).slideUp("fast",function(){d.component.destroy();var h=b("#"+e+" .echo-streamserver-controls-submit-container.original-submit");var i=h.find(".echo-streamserver-controls-submit-plugin-TWP_Submit_VerifiedCommenter-verifiedCommenterRequest");i.find("a").remove();i.append('<span class="verification-status">'+a.labels.verification_request+"</span>");h.slideDown("slow");});}}};a.templates.verifiedCommenterCheckbox=function(){var d=(wp_e2&&wp_e2.echo_user&&wp_e2.echo_user.is("logged"))?'<a class="submit-request-form">'+a.labels.verifiedinput_text+"</a>":a.labels.verifiedinput_text_anon;if(wp_e2&&wp_e2.echo_user&&(wp_e2.echo_user.get("state")!="ModeratorBanned"&&wp_e2.echo_user.get("state")!="ModeratorDeleted")&&!wp_e2.echo_user.userSuspended&&b("#ugc-photo-gallery").length==0&&(!this.component.config.get("name")||(this.component.config.get("name")&&this.component.config.get("name").indexOf("Reply")<0))){return'<div class="{plugin.class:verifiedCommenterRequest}">'+d+"</div>";}else{return"";}};a.contentTemplate='<div class="{plugin.class:topCommenterForm}">'+'<div class="echo-close">&#215;</div>'+'<div class="description">'+a.labels.verifiedinput_description+"</div>"+'<input type="text" name="fullName" placeholder="Full Name" maxlength="50">'+'<input type="text" name="phoneNumber" placeholder="Phone number" maxlength="20">'+'<input type="text" name="affiliation" placeholder="Affiliation (if relevant)" maxlength="100">'+'<input type="text" name="twitterHandle"  placeholder="Twitter handle (optional)"  maxlength="30">'+'<textarea rows="2" cols="50"  name="address"  placeholder="Street address" maxlength="100"/>'+'<input type="text" name="email"  placeholder="E-mail address" maxlength="50">'+'<input type="text" name="fbPage"  placeholder="Facebook page (optional)" maxlength="30">'+'<div class="agreetopolicy"><input type="checkbox" name="agreetopolicy" value="agreedtopolicy"><p>I have read and understood The Washington Post\'s '+'<span class="discussion-policy"><a href="http://www.washingtonpost.com/blogs/ask-the-post/discussion-and-submission-guidelines/" target="_policy">discussion policy</a></span>'+" and "+'<span class="discussion-policy"><a href="http://www.washingtonpost.com/blogs/ask-the-post/discussion-and-submission-guidelines/#preferred-commenters" target="_policy">guidelines on preferred comment placement</a></span>.</p></div>'+"</div>"+'<textarea class="{class:text} {class:textArea} echo-primaryFont echo-primaryColor" style="display:none;"></textarea>';a.component.renderers.container=function(g){var h=this.component,f=this.config.get("thisContainer");this.parentRenderer("container",arguments);if(this.config.get("addVerifiedCommenterRequest")===true){g.addClass("original-submit");}if(wp_e2[f].verifiedcommenteridlist&&(wp_e2[f].verifiedcommenteridlist.userArray&&wp_e2[f].verifiedcommenteridlist.userArray[wp_e2.echo_user.get("identityUrl")])){var e=wp_e2[f].verifiedcommenteridlist.userArray[wp_e2.echo_user.get("identityUrl")].verification_status;var d=b(g).find(".echo-streamserver-controls-submit-plugin-TWP_Submit_VerifiedCommenter-verifiedCommenterRequest");d.find("a").remove();d.append('<span class="verification-status">'+a.labels[e]+"</span>");}};a.component.renderers.userInfoWrapper=function(d){var e=this.component;this.parentRenderer("userInfoWrapper",arguments);b(d).hide();};a.renderers.topCommenterForm=function(g){var i=this,h=this.component;var f=i.config.get("thisContainer");var d=b("#comment_policy_overlay");d.hide();b("body").prepend(d);try{window.$(g).find("a").overlay(i.config.get("overlayConfig"));}catch(j){}g.find(".echo-close").on("click",i,function(k){var e=i.config.get("thisContainer");if(b("#"+e+" ."+i.config.get("verifiedCommenterSubmitTarget")).length>0){b("#"+e+" ."+i.config.get("verifiedCommenterSubmitTarget")).slideUp("fast",function(){i.component.destroy();var l=b("#"+e+" .echo-streamserver-controls-submit-container.original-submit");l.find(".echo-streamserver-controls-submit-plugin-TWP_Submit_VerifiedCommenter-verifiedCommenterRequest a").removeClass("open");l.slideDown("slow");});}});};a.renderers.verifiedCommenterRequest=function(d){var f=this,e=this.component;d.find("a.submit-request-form").on("click",f,function(g){if(!b(this).hasClass("open")){b(this).addClass("open");f._startTopCommentsSubmit(f);}});return d;};a.methods._publishEventComplete=function(d){var e=this.component;this.events.publish({"topic":d.topic,"data":d.data});};a.methods._startTopCommentsSubmit=function(h){var g=h.component;var f=h.config.get("thisContainer"),e=wp_e2[f].guid;if(b("#"+f).find("."+h.config.get("verifiedCommenterSubmitTarget")).length==0){b("."+h.config.get("verifiedCommenterRequestTarget")).prepend('<div class="'+h.config.get("verifiedCommenterSubmitTarget")+'"></div>');}var j=[{"name":"CardUIShim","submitPermissions":"forceLogin","displaySharingOnPost":false,"nestedPlugins":[{"name":"TWP_formAuth","thisContainer":f}],"labels":{"post":"Submit","posting":"Submitting..."}},{"name":"TWP_Submit","thisContainer":f},{"name":"TWP_Submit_VerifiedCommenter","thisContainer":f,"addVerifiedCommenterRequest":false,"isVerifiedCommenterForm":true}];b("."+h.config.get("verifiedCommenterSubmitTarget")).css("display","none");var d={"target":b("."+h.config.get("verifiedCommenterSubmitTarget")),"targetURL":e,"markers":["verification_request"],"appkey":wp_e2.appkey,"type":"badge","plugins":j,"useSecureAPI":true,"labels":{"post":"Submit","posting":"Submitting..."}};var i=new Echo.StreamServer.Controls.Submit(d);h.config.set("topCommentsSubmit",i);b("#"+f+" .echo-streamserver-controls-submit-container.original-submit").slideUp("fast",function(){if(!h.config.get("isPlaceholder")){b(".echo-streamserver-controls-submit-plugin-TWP_Submit_VerifiedCommenter-topCommenterForm textarea").css({"width":"40%","margin-right":"20px"});b(".echo-streamserver-controls-submit-plugin-TWP_Submit_VerifiedCommenter-topCommenterForm").find("[placeholder]").each(function(){b(this).val(b(this).attr("placeholder"));b(this).on("focus",function(){if(b(this).attr("placeholder")==b(this).val()){b(this).val("");}});b(this).on("blur",function(){if(b(this).val()==""){b(this).val(b(this).attr("placeholder"));}});});}b("."+h.config.get("verifiedCommenterSubmitTarget")).slideDown("slow",function(){});
});};Echo.Plugin.create(a);})(Echo.jQuery);var wapoIdentity;function wapoIdentityInit(){function a(){var b=null;var c=null;a.echo_commenting_group="commenting_verified";}a.prototype.reconcileUsernames=function(){if(typeof(this.wapo_username)!=="undefined"&&this.wapo_username!==null&&typeof(this.echo_username)!=="undefined"&&this.echo_username!==null){if(this.wapo_username===this.echo_username){if(this.wapo_username){this.loginCallback();this.echoLoginCallback();}else{this.logoutCallback();this.echoLogoutCallback();}}else{if(this.wapo_username===""){this.logoutCallback();this.echoLogoutCallback();}else{if(this.wapo_username!==""&&this.echo_username!==""){this.callLogoutPortableContact();Backplane.resetCookieChannel();this.loginCallback();this.echoLoginCallback();}else{if(this.wapo_username!==""&&this.echo_username===""){this.loginCallback();this.echoLoginCallback();}}}}}};a.prototype.init=function(){var b,c;if(!$wpjQ.browser.msie){document.domain=wapoEnv.site_base_domain;}this.updateWapoUsername();this.updateEchoUsername();$wpjQ(document).bind(wapoEnv.event_name_logout,function(){wapoIdentity.wapo_username=null;wapoIdentity.echo_username=null;wapoIdentity.updateWapoUsername();wapoIdentity.updateEchoUsername();});$wpjQ(document).bind(wapoEnv.event_name_login,function(){wapoIdentity.wapo_username=null;wapoIdentity.echo_username=null;wapoIdentity.updateWapoUsername();wapoIdentity.updateEchoUsername();});$wpjQ(document).bind(wapoEnv.event_name_new_registration,function(){wapoIdentity.wapo_username=null;wapoIdentity.echo_username=null;wapoIdentity.updateWapoUsername();wapoIdentity.updateEchoUsername();});};a.prototype.updateWapoUsername=function(){var d=this.getIsMemberOfCommentingGroup();if(d===true){var b=wapoUtilities.Get_Cookie(wapoEnv.cookie_login_id);if(typeof(b)!=="undefined"&&b!==null){var e=wapoUtilities.Get_Cookie(wapoEnv.cookie_display);if(typeof(e)!="undefined"&&e!==null){var c=e.split("|");if(c.length>0){wapoIdentity.wapo_username=c[0];if(wapoIdentity.wapo_username.substr(0,1)==='"'){wapoIdentity.wapo_username=wapoIdentity.wapo_username.substring(1);}}}}}else{wapoIdentity.wapo_username="";wapoIdentity.reconcileUsernames();}};a.prototype.updateEchoUsername=function(){Echo.Events.subscribe({"topic":"Echo.UserSession.onInit","once":true,"handler":function(){wapoIdentity.echo_user.accounts=wapoIdentity.echo_user.get("activeIdentities");wapoIdentity.setEchoUsername();}});this.echo_user=new Echo.UserSession({"appkey":wapoEnv.jskit_consumer_key});};a.prototype.setEchoUsername=function(){if(typeof(this.echo_user)!=="undefined"&&typeof(this.echo_user.accounts)!=="undefined"&&this.echo_user.accounts.length>0){this.echo_username=this.echo_user.accounts[0].username;this.reconcileUsernames();}else{this.echo_username="";this.reconcileUsernames();}};a.prototype.loginCallback=function(){if(typeof(this.echo_user)==="undefined"||typeof(this.echo_user.accounts)==="undefined"||this.echo_user.accounts.length===0||this.echo_username!==this.wapo_username){this.callLoginPortableContact();}else{this.postComment();}var c=$wpjQ("#wapo_change_avatar");if(c!==null){var b=Backplane.getChannelName();c.html('<a id="wapoChangeAvatarLink" href="http:'+wapoEnv.wapo_site_url+"siteRegistration/changeProfilePic?jskit_channel="+b+"&previous_url="+encodeURIComponent(window.location)+'">Edit Avatar</a>');}};a.prototype.callLoginPortableContact=function(){var b=Backplane.getChannelName();var c={type:"GET",url:"http:"+wapoEnv.wapo_site_url+"public/visitor/login_portable_contact.json?jskit_channel="+b,dataType:"jsonp",cache:false,jsonp:wapoEnv.param_name_jsonp_callback,success:function(d){if(d!==null&&typeof d["response"]!=="undefined"&&d["response"]!==null){if(d["response"].indexOf("invalid")!==-1){wapoIdentity.echoLogoutCallback();}else{if(d["response"].indexOf("result=success")!==-1){wapoIdentity.echoLoginCallback();wapoIdentity.postComment();}}}},error:function(){}};$wpjQ.ajax(c);Backplane.expectMessagesWithin(10);};a.prototype.logoutCallback=function(){this.callLogoutPortableContact();var b=$wpjQ("#wapoChangeAvatarLink");if(b!==null){b.remove();}};a.prototype.callLogoutPortableContact=function(){var f=null;if(typeof(this.echo_user)!=="undefined"&&typeof(this.echo_user.accounts)!=="undefined"&&this.echo_user.accounts.length>0){for(var d=0;d<this.echo_user.accounts.length;d++){var e=this.echo_user.accounts[d];if(typeof(e)!=="undefined"){f=e.identityUrl;f=f.replace(/\%20/g,"%2B");}}}if(f!==null){var b=Backplane.getChannelName();var c={type:"GET",url:"http:"+wapoEnv.wapo_site_url+"public/visitor/logout_portable_contact.json?jskit_channel="+b+"&jskit_login="+f,dataType:"jsonp",cache:false,jsonp:wapoEnv.param_name_jsonp_callback,success:function(g){if(g!==null&&typeof g["response"]!=="undefined"&&g["response"]!==null){if(g["response"].indexOf("result=success")!==-1){}else{if(g["response"].indexOf("invalid")!==-1){}}}wapoIdentity.echoLogoutCallback();},error:function(){wapoIdentity.echoLogoutCallback();}};$wpjQ.ajax(c);Backplane.expectMessagesWithin(10);}else{this.echoLogoutCallback();}};a.prototype.echoLoginCallback=function(){$wpjQ(window).trigger("echoLoginStateChange",["login"]);if(typeof(Echo.LoginStateChange)==="function"){Echo.LoginStateChange("login");}};a.prototype.echoLogoutCallback=function(){$wpjQ(window).trigger("echoLoginStateChange",["logout"]);if(typeof(Echo.LoginStateChange)==="function"){Echo.LoginStateChange("logout");}};a.prototype.storeComment=function(f,g,e,b){var d=window.location;d=encodeURIComponent(d);wapoUtilities.Set_Cookie("wapo_jskit_comment",g.postData.content,1,wapoEnv.site_path,wapoEnv.site_base_domain,false);wapoUtilities.Set_Cookie("wapo_jskit_targetUrl",g.postData.target,1,wapoEnv.site_path,wapoEnv.site_base_domain,false);wapoUtilities.Set_Cookie("wapo_jskit_redirectUrl",d,1,wapoEnv.site_path,wapoEnv.site_base_domain,false);if(typeof(wapoVisitor.wapoLoginId)!=="undefined"&&wapoVisitor.wapoLoginId!==null&&wapoVisitor.wapoLoginId!==""){var c=null;if(typeof(wapoEnv.commenting_edit_profile_url)!=="undefined"&&wapoEnv.commenting_edit_profile_url!==null&&wapoEnv.commenting_edit_profile_url!==""){c=wapoEnv.commenting_edit_profile_url;}else{c=wapoEnv.wapo_secure_protocol+wapoEnv.wapo_site_url+"siteRegistration/editProfile?"+wapoEnv.param_name_no_cancel+"=true&";}wapoUtilities.Set_Cookie("wapo_jskit_loginUrl",c,1,wapoEnv.site_path,wapoEnv.site_base_domain,false);}else{wapoUtilities.Set_Cookie("wapo_jskit_loginUrl",wapoEnv.wapo_reg_url,1,wapoEnv.site_path,wapoEnv.site_base_domain,false);}};a.prototype.postComment=function(){var d=wapoUtilities.Get_Cookie("wapo_jskit_comment");var c=wapoUtilities.Get_Cookie("wapo_jskit_targetUrl");if(d!==null&&c!==null){d=encodeURIComponent(d);c=encodeURIComponent(c);var b={type:"GET",url:"http:"+wapoEnv.wapo_site_url+"public/visitor/submit_comment.json?jskit_comment="+d+"&jskit_targeturl="+c,dataType:"jsonp",cache:false,jsonp:wapoEnv.param_name_jsonp_callback};$wpjQ.ajax(b);wapoUtilities.Delete_Cookie("wapo_jskit_comment",wapoEnv.site_path,wapoEnv.site_base_domain);wapoUtilities.Delete_Cookie("wapo_jskit_targetUrl",wapoEnv.site_path,wapoEnv.site_base_domain);wapoUtilities.Delete_Cookie("wapo_jskit_redirectUrl",wapoEnv.site_path,wapoEnv.site_base_domain);wapoUtilities.Delete_Cookie("wapo_jskit_loginUrl",wapoEnv.site_path,wapoEnv.site_base_domain);}};a.prototype.getIsMemberOfCommentingGroup=function(b){b=(typeof b=="undefined"||b==null)?a.echo_commenting_group:b;var d=false;if(typeof(wapoVisitor)!=="undefined"&&wapoVisitor!==null&&typeof(b)!=="undefined"&&b!==null){var c=wapoVisitor.completedGroups;if(typeof(c)!=="undefined"&&c!==null&&c.indexOf(b)!==-1){d=true;}}return d;};a.prototype.isMemberOfCommentingGroup=function(b){var c=this.getIsMemberOfCommentingGroup(b);if(c==false){}return c;};wapoIdentity=new a();wapoIdentity.init();}function wapoLoginCallback(){wapoIdentity.loginCallback();}function wapoLogoutCallback(){wapoIdentity.logoutCallback();}var debug=wp_e2.debug;debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"starting twp_comments_echo2.js");
(function($){var isRendered=false;var userLoginState=null;var echo_user=null;var onPostCompleteVars={};var onMoreVars={};var isWashingtonpostDomain=true;wp_e2.isMobile=(typeof window.mobile_browser!=="undefined"&&window.mobile_browser===1)?true:false;wp_e2.initStatus={badge_init:false,wp_e2_init:false,user_init:false,canvas_init:false};wp_e2.wp_site_domain=["washingtonpost.com","digitalink.com"];wp_e2.USER_ROLE_ADMINISTRATOR="administrator";wp_e2.SORT_DESCENDING="reverseChronological";wp_e2.SORT_ASCENDING="chronological";wp_e2.MODERATION_REQUIRED="premodreq";wp_e2.MODERATOR_APPROVED="ModeratorApproved";wp_e2.MODERATOR_BANNED="ModeratorBanned";wp_e2.MODERATOR_DELETED="ModeratorDeleted";wp_e2.COMMUNITY_FLAGGED="CommunityFlagged";wp_e2.MODERATOR_FLAGGED="ModeratorFlagged";wp_e2.SYSTEM_FLAGGED="SystemFlagged";wp_e2.UNTOUCHED="Untouched";wp_e2.PHOTO="photo";wp_e2.WEBTYPE_PHOTO="ugc_photo_story";wp_e2.WEBTYPE_BLOG="blogstory";wp_e2.WEBTYPE_PROMO="promo_story";wp_e2.WEBTYPE_DISCUSSION_STORY="discussion_story";wp_e2.STREAM_BASE="http://www.washingtonpost.com";wp_e2.SUBMIT_BOX_CLASS="comment-box";wp_e2.STREAM_CLASS="echo-stream";wp_e2.COUNTER_CLASS="echo-counter";wp_e2.SUBMIT_BOX_TARGET="."+wp_e2.SUBMIT_BOX_CLASS;wp_e2.STREAM_TARGET="."+wp_e2.STREAM_CLASS;wp_e2.COUNTER_TARGET="."+wp_e2.COUNTER_CLASS;wp_e2.ECHO_CONTAINER=".echo_container";wp_e2.ECHO_CANVAS=".echo_container.echo-canvas";wp_e2.getQuery=function(guid,thisContainer,itemurl,userIdList,streamContainer){streamContainer=(typeof streamContainer=="undefined")?"all":streamContainer;var currContainer=(typeof thisContainer=="undefined")?wp_e2:wp_e2[thisContainer];var guid=(!guid)?currContainer.guid:guid;itemurl=(typeof itemurl=="undefined")?"":itemurl;userIdList=(typeof userIdList=="undefined")?"":userIdList;var webType=(typeof currContainer.webType!=="undefined")?currContainer.webType.toLowerCase():"";var parenturl=(typeof currContainer.parenturl=="undefined")?"":currContainer.parenturl;var includechildren=(typeof currContainer.includechildren!=="undefined")?currContainer.includechildren:true;if(includechildren){childrenLevelsToShow=currContainer.streamSettings.childrenMaxDepth;}else{childrenLevelsToShow=0;}var childrenToShow=currContainer.streamSettings[streamContainer].childrenItemsPerPage;var queryFilter=(userIdList!="")?"scope: ":"childrenof: ";var userQuery="";if((typeof wp_e2.echo_user!=="undefined"&&typeof wp_e2.echo_user.get("state")!=="undefined"&&wp_e2.echo_user.is("logged"))){if(wp_e2.echo_user.get("state")===wp_e2.UNTOUCHED||wp_e2.echo_user.get("state")===wp_e2.MODERATOR_BANNED||wp_e2.echo_user.get("state")===wp_e2.MODERATOR_DELETED||currContainer.moderationrequired===true){userQuery="OR (-state:"+wp_e2.SYSTEM_FLAGGED+","+wp_e2.MODERATOR_FLAGGED+" user.id:'"+wp_e2.echo_user.get("identityUrl")+"')";}}var itemMarkerQuery=((typeof currContainer.streamSettings.allowedItemMarkers!=="undefined")?" markers: "+currContainer.streamSetting.allowedItemMarkers.toString()+" ":"")+" -markers:ignore ";var userMarkerQuery=((typeof currContainer.streamSettings.allowedUserMarkers!=="undefined"&&currContainer.streamSettings.allowedUserMarkers.toString()!="")?" user.markers: "+currContainer.streamSetting.allowedUserMarkers.toString()+" ":"");var markerQuery="";if(itemMarkerQuery!=""&&userMarkerQuery!=""){markerQuery="("+itemMarkerQuery+" OR "+userMarkerQuery+") ";}else{if(itemMarkerQuery!=""){markerQuery="("+itemMarkerQuery+") ";}else{if(userMarkerQuery!=""){markerQuery="("+userMarkerQuery+")";}}}if(currContainer.display_ugc_photos){currContainer.streamSettings.allowedItemStates=[wp_e2.MODERATOR_APPROVED];}var stateQuery="";if(webType===wp_e2.WEBTYPE_PHOTO){stateQuery="(state:"+wp_e2.MODERATOR_APPROVED+" -user.state:"+wp_e2.MODERATOR_BANNED+","+wp_e2.MODERATOR_DELETED+") ";}else{if(currContainer.moderationrequired===true){stateQuery="(state:"+wp_e2.COMMUNITY_FLAGGED+","+wp_e2.MODERATOR_APPROVED+" -user.state:"+wp_e2.MODERATOR_BANNED+","+wp_e2.MODERATOR_DELETED+" ) ";}else{stateQuery="(state:Untouched user.state:"+wp_e2.MODERATOR_APPROVED+") "+"OR (state:"+wp_e2.COMMUNITY_FLAGGED+","+wp_e2.MODERATOR_APPROVED+","+wp_e2.MODERATOR_DELETED+" -user.state:"+wp_e2.MODERATOR_BANNED+","+wp_e2.MODERATOR_DELETED+") ";}}var streamStateQuery="";if(webType===wp_e2.WEBTYPE_PHOTO){streamStateQuery="(state:"+wp_e2.MODERATOR_APPROVED+" -user.state:"+wp_e2.MODERATOR_BANNED+","+wp_e2.MODERATOR_DELETED+") ";}else{if(currContainer.moderationrequired===true){streamStateQuery="(state:"+wp_e2.COMMUNITY_FLAGGED+","+wp_e2.MODERATOR_APPROVED+" -user.state:"+wp_e2.MODERATOR_BANNED+","+wp_e2.MODERATOR_DELETED+" ) ";}else{streamStateQuery="(state:Untouched user.state:"+wp_e2.MODERATOR_APPROVED+","+wp_e2.UNTOUCHED+") "+"OR (state:"+wp_e2.COMMUNITY_FLAGGED+","+wp_e2.MODERATOR_APPROVED+","+wp_e2.MODERATOR_DELETED+" -user.state:"+wp_e2.MODERATOR_BANNED+","+wp_e2.MODERATOR_DELETED+") ";}}var childrenStateQuery="";if(webType===wp_e2.WEBTYPE_PHOTO){childrenStateQuery="(state:"+wp_e2.MODERATOR_APPROVED+" -user.state:"+wp_e2.MODERATOR_BANNED+","+wp_e2.MODERATOR_DELETED+") ";}else{if(currContainer.moderationrequired===true){childrenStateQuery="(state:"+wp_e2.COMMUNITY_FLAGGED+","+wp_e2.MODERATOR_APPROVED+" -user.state:"+wp_e2.MODERATOR_BANNED+","+wp_e2.MODERATOR_DELETED+" ) ";}else{childrenStateQuery="(state:Untouched user.state:"+wp_e2.MODERATOR_APPROVED+") "+"OR (state:"+wp_e2.COMMUNITY_FLAGGED+","+wp_e2.MODERATOR_APPROVED+" -user.state:"+wp_e2.MODERATOR_BANNED+","+wp_e2.MODERATOR_DELETED+") ";}}var numDisplayItems=0;if(typeof currContainer.streamSettings[streamContainer].maxitems!=="undefined"){numDisplayItems=currContainer.streamSettings[streamContainer].maxitems;}var filterQuery=" (("+stateQuery+userQuery+") "+(markerQuery!=""?" AND "+markerQuery:"")+")  ";var twitterQuery="";if((typeof currContainer.source!=="undefined"&&currContainer.source.indexOf("Twitter")>=0)){twitterQuery="("+currContainer.streamSettings.request+": "+guid+" ("+streamStateQuery+")"+" "+markerQuery+" source:Twitter"+") ";}var washpostQuery="";if((typeof currContainer.source!=="undefined"&&currContainer.source.indexOf("washpost.com")>=0)){washpostQuery="("+currContainer.streamSettings.request+": "+guid+" source:"+currContainer.source.toString()+filterQuery+" )";}var streamIdQuery="";if(typeof currContainer.streamid!=="undefined"&&currContainer.streamid!=""){streamIdQuery="("+currContainer.streamSettings.request+": "+currContainer.streamid+((typeof currContainer.streamSettings.allowedItemMarkers!=="undefined"&&currContainer.streamSettings.allowedItemMarkers.toString()!="")?" markers: "+currContainer.streamSettings.allowedItemMarkers.toString():"")+" ("+streamStateQuery+")"+")";}var query=(washpostQuery!="")?washpostQuery:"";if(typeof wp_e2[thisContainer]!=="undefined"&&wp_e2[thisContainer].displayuserstream){query=queryFilter+guid+" user.id:'"+wp_e2.echo_user.get("identityUrl")+"'"+" itemsPerPage: "+numDisplayItems+" sortOrder:"+currContainer.streamSettings.sortorder+" safeHTML: permissive"+" type:comment"+" -markers: ignore "+" children: "+childrenLevelsToShow+" childrenSortOrder:"+currContainer.streamSettings.childrenSortOrder+" childrenItemsPerPage:"+childrenToShow+" "+" ("+childrenStateQuery+userQuery+") ";}else{if(parenturl!=""){query=queryFilter+parenturl+" itemsPerPage: "+numDisplayItems+" sortOrder:"+currContainer.streamSettings.sortorder+" safeHTML:"+currContainer.streamSettings.safeHTML+" type:comment"+" childrenItemsPerPage:"+childrenToShow+" children: "+childrenLevelsToShow+" childrenSortOrder:"+currContainer.streamSettings.childrenSortOrder+" "+" (("+childrenStateQuery+userQuery+") "+(markerQuery!=""?" AND "+markerQuery:"")+") ";}else{if(itemurl!=""){query="url: "+itemurl+" itemsPerPage: "+numDisplayItems+" sortOrder:"+currContainer.streamSettings.sortorder+" safeHTML:"+currContainer.streamSettings.safeHTML+" children: "+childrenLevelsToShow+" childrenSortOrder:"+currContainer.streamSettings.childrenSortOrder+" childrenItemsPerPage:"+childrenToShow+" "+" (("+childrenStateQuery+userQuery+") "+(markerQuery!=""?" AND "+markerQuery:"")+") ";
}else{if(userIdList!=""){query=queryFilter+guid+" user.id:"+userIdList+" itemsPerPage: "+numDisplayItems+" sortOrder: "+currContainer.streamSettings.sortorder+" safeHTML: "+currContainer.streamSettings.safeHTML+" type:comment"+" -markers: ignore "+" children: "+childrenLevelsToShow+" childrenSortOrder:"+currContainer.streamSettings.childrenSortOrder+" childrenItemsPerPage:"+childrenToShow+" "+" ("+childrenStateQuery+userQuery+") ";}else{query=query+((streamIdQuery!=""&&query!=="")?" OR "+streamIdQuery:streamIdQuery);query=query+((twitterQuery!=""&&query!=="")?" OR "+twitterQuery:twitterQuery);query="("+query+")"+" itemsPerPage: "+numDisplayItems+" sortOrder:"+currContainer.streamSettings.sortorder+" safeHTML:"+currContainer.streamSettings.safeHTML+" children: "+childrenLevelsToShow+" childrenSortOrder:"+currContainer.streamSettings.childrenSortOrder+" childrenItemsPerPage:"+childrenToShow+" "+" (("+childrenStateQuery+userQuery+") "+(markerQuery!=""?" AND "+markerQuery:"")+") ";}}}}debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - query - "+thisContainer+": "+query);return query;};wp_e2.init=function(){wp_e2._initOmnitureVariables();if(typeof(Echo)!=="undefined"){if(typeof Backplane!=="undefined"){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - initializing backplane");if(!TWP.Util.User.getAuthentication()){Backplane.resetCookieChannel();}Backplane.init(wp_e2.backplaneSettings);}else{debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - no backplane");}if(typeof wapoIdentityInit==="function"){wapoIdentityInit();}Echo.LoginStateChange=function(loginState){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Echo.LoginStateChange triggered for login state: "+loginState);userLoginState=loginState;$(".comment-stream").trigger("wp_e2Init.Complete");};}else{debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - no echo present");}debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - init complete");Echo.Events.subscribe({"topic":"Echo.UserSession.onInit","context":"global","handler":function(topic,data,contextId){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Echo.UserSession.onInit triggered - "+(wp_e2.echo_user&&wp_e2.echo_user.get("activeIdentities")[0]&&wp_e2.echo_user.get("activeIdentities")[0].username)+" - synced: "+wp_e2._isUserSynced());wp_e2.echo_user=new Echo.UserSession({"appkey":wp_e2.appkey,"apiBaseURL":wp_e2.apiBaseURL});var accounts=wp_e2.echo_user.get("activeIdentities");wp_e2._getIgnoredUsers();wp_e2.initStatus.user_init=true;$(document).trigger("TWP.Echo.User.InitComplete");$(document).trigger("TWP.Apps.Init.Complete");}});Echo.Events.subscribe({"topic":"Echo.UserSession.onInvalidate","context":"global","handler":function(topic,data,contextId){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Echo.UserSession.onInvalidate triggered "+(wp_e2.echo_user&&wp_e2.echo_user.get("activeIdentities")[0]&&wp_e2.echo_user.get("activeIdentities")[0].username)+" - synced: "+wp_e2._isUserSynced());wp_e2.echo_user=new Echo.UserSession({"appkey":wp_e2.appkey,"apiBaseURL":wp_e2.apiBaseURL});var accounts=wp_e2.echo_user.get("activeIdentities");wp_e2.initStatus.user_init=true;$(document).trigger("TWP.Echo.User.InitComplete");$(document).trigger("TWP.Apps.Init.Complete");}});Echo.Events.subscribe({"topic":"Echo.StreamServer.Controls.Stream.onMoreButtonPress","context":"global","handler":function(topic,data,contextId){var thisContainer=$(data.target).closest(wp_e2.ECHO_CONTAINER).attr("id");if(typeof sendDataToOmniture==="function"){try{sendDataToOmniture("echo.onmore","event5",onMoreVars);debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - MORE: omniture event5");}catch(err){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - MORE: omniture event5"+err);}}}});Echo.Events.subscribe({"topic":"Echo.StreamServer.Controls.Submit.onPostComplete","context":"global","handler":function(topic,data,contextId){var thisContainer=$(data.target).closest(wp_e2.ECHO_CONTAINER).attr("id");if(typeof sendDataToOmniture==="function"){try{onPostCompleteVars.eVar26=(wp_e2[thisContainer].display_ugc_photos===true)?"submit - ugc":"submit - comments";sendDataToOmniture("echo.onpostcomplete","event3",onPostCompleteVars);debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Post COmplete: omniture event3");onPostCompleteVars.eVar26="";}catch(err){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Post COmplete: omniture event3 - "+err);}}}});Echo.Events.subscribe({"topic":"Echo.StreamServer.Controls.Stream.onRender","context":"global","handler":function(topic,data,contextId){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Stream.onRender");window.wp_pb&&wp_pb.report&&wp_pb.report("global","domChangedQueue");}});Echo.Events.subscribe({"topic":"Echo.StreamServer.Controls.Stream.onRerender","context":"global","handler":function(topic,data,contextId){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Stream.onRerender");window.wp_pb&&wp_pb.report&&wp_pb.report("global","domChangedQueue");}});Echo.Events.subscribe({"topic":"Echo.StreamServer.Controls.Stream.onReady","context":"global","handler":function(topic,data,contextId){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Stream.onReady");window.wp_pb&&wp_pb.report&&wp_pb.report("global","domChangedQueue");window.wp_pb&&wp_pb.report&&wp_pb.report("comments","commentsReady");if(typeof sendDataToOmniture==="function"){try{sendDataToOmniture("echo.commentsLoaded","event29",{"eVar26":"comments loaded"});debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - LOADED: omniture event29");}catch(err){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - LOADED: omniture event29"+err);}}if(typeof $.lockfixed=="function"&&$(".lockfix").length>0){$.lockfixed(".echo-apps-conversations-allPostsContainer .echo-apps-conversations-streamHeader",{"fixClass":"lockfixed"});}}});Echo.Events.subscribe({"topic":"Echo.StreamServer.Controls.Stream.Item.onRender","context":"global","handler":function(topic,data,contextId){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Stream.Item.onRender");window.wp_pb&&wp_pb.report&&wp_pb.report("global","domChangedQueue");}});Echo.Events.subscribe({"topic":"Echo.StreamServer.Controls.Stream.Item.onRerender","context":"global","handler":function(topic,data,contextId){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Stream.Item.onRerender");window.wp_pb&&wp_pb.report&&wp_pb.report("global","domChangedQueue");}});Echo.Events.subscribe({"topic":"Echo.StreamServer.Controls.Submit.onReady","context":"global","handler":function(topic,data,contextId){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Submit.onReady");
}});Echo.Events.subscribe({"topic":"Echo.StreamServer.Controls.Submit.onRender","context":"global","handler":function(topic,data,contextId){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Submit.onRender");window.wp_pb&&wp_pb.report&&wp_pb.report("global","domChanged");}});Echo.Events.subscribe({"topic":"Echo.StreamServer.Controls.Submit.onRerender","context":"global","handler":function(topic,data,contextId){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Submit.onRerender");window.wp_pb&&wp_pb.report&&wp_pb.report("global","domChanged");}});Echo.Events.subscribe({"topic":"Echo.IdentityServer.Controls.Auth.onRender","context":"global","handler":function(topic,data,contextId){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Echo.IdentityServer.Controls.Auth.onRender triggered - "+(wp_e2.echo_user&&wp_e2.echo_user.get("activeIdentities")[0]&&wp_e2.echo_user.get("activeIdentities")[0].username)+" - synced: "+wp_e2._isUserSynced());}});Echo.Events.subscribe({"topic":"Echo.IdentityServer.Controls.Auth.onRerender","context":"global","handler":function(topic,data,contextId){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Echo.IdentityServer.Controls.Auth.onRerender triggered - "+(wp_e2.echo_user&&wp_e2.echo_user.get("activeIdentities")[0]&&wp_e2.echo_user.get("activeIdentities")[0].username)+" - synced: "+wp_e2._isUserSynced());}});Echo.Events.subscribe({"topic":"Echo.Canvas.onRender","context":"global","handler":function(topic,data,contextId){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - Canvas.onReady");}});wp_e2.initStatus.wp_e2_init=true;$(document).trigger("TWP.Apps.Init.Complete");};wp_e2._getIgnoredUsers=function(){if(typeof wp_e2!=="undefined"&&(wp_e2.echo_user&&wp_e2.echo_user.is("logged"))&&!wp_e2.ignoredUsers){var current_user_id=encodeURI(wp_e2.echo_user.get("identityUrl"));var ignoredUsers=$.getJSON(wp_e2.mongoUserActionUrl+"?jsonp=?",'q={"user_id":"'+current_user_id+'","action":"Ignore"}',function(data){wp_e2.ignoredUsers=[];$.each(data.q_results[0].rows,function(index,row){wp_e2.ignoredUsers.push(row.target_user_id);});});}};wp_e2._initOmnitureVariables=function(){var commonVars={};try{commonVars={"eVar1":s.eVar1,"eVar2":s.eVar2,"eVar8":s.eVar8,"eVar17":s.eVar17,"eVar33":s.eVar33};}catch(err){}$.extend(onPostCompleteVars,commonVars);onMoreVars={"eVar26":"load more comments"};$.extend(onMoreVars,commonVars);};wp_e2.setSubmitMarkers=function(thisContainer){var newMarker=(wp_e2[thisContainer].sectionid!==""&&typeof wp_e2[thisContainer].sectionid!=="undefined")?wp_e2[thisContainer].sectionid:"";newMarker+=(wp_e2[thisContainer].moderationrequired===true)?", "+wp_e2.MODERATION_REQUIRED:"";newMarker+=(wp_e2[thisContainer].display_ugc_photos===true)?", "+wp_e2.PHOTO:"";wp_e2[thisContainer].submitMarkers=newMarker.split(", ");};wp_e2._getTimeoutValue=function(classType,webType,thisContainer){if(typeof thisContainer!=="undefined"&&wp_e2[thisContainer].allow_comments==false){webType="closed";}else{if(typeof webType=="undefined"||webType==""){webType="no_webtype";}}var timeout=(typeof wp_e2.liveUpdatesTimeout[classType][webType]!=="undefined")?wp_e2.liveUpdatesTimeout[classType][webType]:wp_e2.liveUpdatesTimeout[classType]["default"];return timeout;};wp_e2._toString=function(myObj,key){for(myKey in myObj){console.log("config"+((typeof key==="undefined"||key===-1)?"":"["+key+"]")+"["+myKey+"] = "+myObj[myKey]);if(typeof myObj[myKey]==="object"){wp_e2.toString(myObj[myKey],myKey);}}};wp_e2._isUserSynced=function(){var userSynced=false;if(typeof userLoginState!=="undefined"&&userLoginState!==null&&typeof wp_e2.echo_user!=="undefined"&&((userLoginState==="login"&&wp_e2.echo_user.is("logged"))||(userLoginState==="logout"&&!wp_e2.echo_user.is("logged")))){userSynced=true;}return userSynced;};wp_e2._shareRender=function(element,thisConfig){element.find(".echo-streamserver-controls-stream-item-button-share").on("mouseenter",thisConfig,function(event){var shareOverlay;var thisConfig=event.data;var thisContainer=thisConfig.config.get("thisContainer");var thisComment=thisConfig.component;event.stopPropagation();if($(this).find(".more").length==0){var FBappId=(TWP&&TWP.Data&&TWP.Data.environment&&(TWP.Data.environment=="prod"||TWP.Data.environment=="stage"))?"41245586762":"98319225937";var shareControl=$(".comment-share-info").html();var thisCommentURL=thisComment.data.object.id;thisCommentURL=thisCommentURL.replace("http://","");var thisCommentPermalink=((wp_e2[thisContainer]&&wp_e2[thisContainer].commentpermalinkurlfacet)||thisComment.data.object.context[0].uri.replace(/_story.html|_blog.html/,"_comment.html"));var thisCommentPermalinkURL=thisCommentPermalink+"?commentID="+thisCommentURL;var conversationHeadline='"'+(thisComment.data.object.context[0].title||$("h1.headline").text()||(document.title&&document.title.split(" - ")[0]))+'"';var thisAuthorAvatar=thisComment.data.actor.avatar;var FBImageCheck=thisAuthorAvatar.indexOf("facebook");var FBCDNImageCheck=thisAuthorAvatar.indexOf("fbcdn");if(FBImageCheck>0||FBCDNImageCheck>0){thisAuthorAvatar="http://www.washingtonpost.com/rw/sites/twpweb/img/echo2/core/avatar-default.png";}var thisCommentAuthor=thisComment.data.actor.title;var thisFBHeadline=thisCommentAuthor+" commented on ";var thisCommentPermalinkHeadline=thisFBHeadline+conversationHeadline;var thisFBHeadline=thisFBHeadline+"...";thisCommentPermalinkHeadline=encodeURI(thisCommentPermalinkHeadline);var thisFBConversationHeadline=conversationHeadline;conversationHeadline=encodeURI(conversationHeadline);var thisCommentContent=thisComment.data.object.content;if(thisComment.data.object.content.length>100){thisCommentContent=thisCommentContent.substr(0,100)+"...";}var thisFBCommentContent=thisCommentContent;thisCommentContent=escape(thisCommentContent);shareControl=shareControl.replace(/{shareURL}/g,thisCommentPermalinkURL);shareControl=shareControl.replace(/{headline}/g,thisCommentPermalinkHeadline);shareControl=shareControl.replace(/{summaryText}/g,thisCommentContent);shareControl=shareControl.replace(/{FBCaption}/g,conversationHeadline);shareControl=shareControl.replace(/{FBHeadline}/g,thisFBHeadline);shareControl=shareControl.replace(/{readerAvatar}/g,thisAuthorAvatar);shareControl=shareControl.replace(/{appKey}/g,FBappId);var obj=$(shareControl);obj.appendTo($(this));shareOverlay=$(this).find(".more");$(shareOverlay).show();}else{$(this).find("#newsharebar").show();}});element.find(".echo-streamserver-controls-stream-item-button-share").on("mouseleave",thisConfig,function(event){event.stopPropagation();$(this).find("#newsharebar").hide();});};wp_e2._getCookie=function(cookieName){var cookieValue=$.cookie(cookieName);return((cookieValue!=null)?cookieValue:"");};wp_e2._setCookie=function(cookieName,cookieValue,options){$.cookie(cookieName,cookieValue,options);};wp_e2.renderCommentCount=function(elm){if(wp_e2._isUserSynced()){var thisElm=(elm&&elm.hasClass(wp_e2.COUNTER_CLASS))?elm:(elm&&elm.find(wp_e2.COUNTER_TARGET));thisElm.each(function(){var guid="";var thisContainer=$(this).closest(wp_e2.ECHO_CONTAINER).attr("id");if(typeof $(this).attr("guid")!=="undefined"){guid=$(this).attr("guid");}if(typeof guid=="undefined"||guid==""){guid=(typeof thisContainer!=="undefined")?wp_e2[thisContainer].guid:wp_e2.guid;}var element=$(this);try{var request=Echo.StreamServer.API.request({"endpoint":"count","apiBaseURL":wp_e2.apiBaseURL+"/v1/","data":{"q":wp_e2.getQuery(wp_e2[thisContainer].guid,thisContainer,wp_e2[thisContainer].itemurl),"appkey":wp_e2.appkey},"liveUpdatesTimeout":wp_e2._getTimeoutValue("counter","default",thisContainer),"recurring":true,"onError":function(data,extra){},"onData":function(data,extra){if(data.count){var count=parseInt(data.count);
}else{if(data.errorMessage===5000){var count="5000+";}}element.html(count||0);Echo.Events.publish({"topic":"onCommentCount","data":{"repliesCount":count,"rsp":data,"el":element}});},"onError":function(data,extra){if(data.count){var count=parseInt(data.count);}else{if(data.errorMessage===5000){var count="5000+";}}element.html(count||0);Echo.Events.publish({"topic":"onCommentCount","data":{"repliesCount":count,"rsp":data,"el":element}});}});request.send();}catch(e){}debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"echo2/v2/core/twp_comments_echo2.js - started counter and attached to .echo-counter for stream: ["+thisContainer+"]");});}};wp_e2.refreshComments=function(data){Echo.jQuery(data.id+" .echo-apps-conversations-container").trigger("TWP.Comments.RequestRefresh",{"url":data.url,"allow_comments":data.allow_comments});$(window.document).on("TWP.Comments.RefreshComplete",function(event,data){});};wp_e2._getNotes=function(elm){elm.each(function(){var thisContainer=$(this).attr("id");wp_e2[thisContainer].verifiedcommenteridlist={};wp_e2[thisContainer].verifiedcommenteridlist.idlist="";if(wp_e2[thisContainer].includeverifiedcommenters==true){var requestData={};requestData.echocontainer=thisContainer;requestData.targetUrl=wp_e2[thisContainer].guid;requestData.usermarkers=wp_e2[thisContainer].userMarkersTop;(wp_e2.echo_user)?requestData.userid=wp_e2.echo_user.get("identityUrl"):"";$.ajax({"url":wp_e2.commentBadgesUrl,"cache":true,"data":requestData,"timeout":3000,"dataType":"jsonp"}).always(function(data,status){var temp={};if(status=="success"&&data&&data.content!=""){temp=eval(data.content);var thisContainer=temp.echocontainer;wp_e2[thisContainer].verifiedcommenteridlist.userArray={};$.each(temp.userSet,function(key,obj){wp_e2[thisContainer].verifiedcommenteridlist.userArray[obj.id]={"name":obj.name,"verification_status":obj.verification_status};});wp_e2[thisContainer].verifiedcommenteridlist.idlist=temp.verifiedidlist;}wp_e2.initStatus.badge_init=true;$(document).trigger("TWP.Apps.Init.Complete");if(Echo&&Echo.Events){Echo.Events.publish({"topic":"TWP.Badge.Request.Complete","data":temp});}});}else{wp_e2.initStatus.badge_init=true;$(document).trigger("TWP.Apps.Init.Complete");}});};wp_e2.initCanvas=function(elm){var pluginArray=[];var canvasConfig=wp_e2.initConfig(elm);var thisContainer=elm.attr("id");var thisCanvasId=wp_e2[thisContainer]["data-canvas-id"];var thisCanvasApp=wp_e2[thisContainer]["data-app-instance"];var thisCanvasTarget=$("#"+thisContainer+" .echo-canvas");thisCanvasTarget.attr({"data-app-instance":thisCanvasApp,"data-canvas-id":thisCanvasId});Echo.Loader.override(thisCanvasId,thisCanvasApp,canvasConfig);Echo.Loader.init({"canvases":thisCanvasTarget});};wp_e2.initConfig=function(elm){var thisContainer=elm.attr("id");wp_e2.setSubmitMarkers(thisContainer);var tmpSortOrder=(wp_e2&&wp_e2[thisContainer].streamSettings&&wp_e2[thisContainer].streamSettings.defaultsort)?wp_e2[thisContainer].streamSettings.defaultsort:"reverseChronological";tmpSortOrder=(wp_e2._getCookie("allPosts.sortOrder"))?wp_e2._getCookie("allPosts.sortOrder"):tmpSortOrder;var conversationsPluginArray=[{"name":"TWP_Conversations_App","thisContainer":thisContainer}];var canvasConfig={"targetURL":wp_e2&&wp_e2[thisContainer].guid,"streamingControl":{"pauseOnHover":false,"displayStreamingStateHeader":true,"enablePausePlayToggle":true},"dependencies":{"StreamServer":{"apiBaseURL":wp_e2.apiBaseURL+"/v1/","appkey":wp_e2&&wp_e2.appkey,"openLinksInNewWindow":true,"liveUpdates":(wp_e2.isMobile)?wp_e2.liveUpdates.mobile:wp_e2.liveUpdates.desktop,"item":{}}},"auth":{"plugins":[{"name":"TWP_formAuth","thisContainer":thisContainer}]},"postComposer":{"visible":(($("#"+thisContainer).hasClass("submitbox"))&&wp_e2[thisContainer].allow_comments===true)?true:false,"displaySharingOnPost":false,"displayCompactForm":true,"plugins":wp_e2[thisContainer].plugins.submitboxPluginArray},"replyComposer":{"visible":(($("#"+thisContainer).hasClass("submitbox")||$("#"+thisContainer).hasClass("permalink"))&&wp_e2[thisContainer].allow_comments===true&&!wp_e2.echo_user.userSuspended)?true:false,"displayCompactForm":false,"displaySharingOnPost":false,"plugins":wp_e2[thisContainer].plugins.submitboxPluginArray},"topPosts":{"visible":(wp_e2&&typeof wp_e2[thisContainer].itemurl=="undefined"&&((wp_e2[thisContainer].includetabs&&wp_e2[thisContainer].defaulttab=="top"&&wp_e2[thisContainer].itemMarkersTop!="")||(wp_e2[thisContainer].includeverifiedcommenters===true&&wp_e2[thisContainer].verifiedcommenteridlist.idlist!=""))),"label":((wp_e2[thisContainer].includeverifiedcommenters===true)?"Commenters mentioned in this story":"Top Comments"),"queryOverride":wp_e2.getQuery(wp_e2[thisContainer].guid,thisContainer,wp_e2[thisContainer].itemurl,wp_e2[thisContainer].verifiedcommenteridlist.idlist,"top"),"plugins":wp_e2[thisContainer].plugins.streamPluginArray.concat([{"name":"Edit","nestedPlugins":[{"name":"TextCounter","limit":wp_e2[thisContainer].commentmaxlength},{"name":"TWP_Edit","thisContainer":thisContainer}]},{"name":"CardUIShim","collapsedContentHeight":280,"labels":{"seeMore":"See More"}},{"name":"TWP_Stream_Item_Top","thisContainer":thisContainer}]),"displaySharingIntent":false,"initialItemsPerPage":wp_e2[thisContainer].streamSettings.top.maxitems,"initialSortOrder":wp_e2[thisContainer].streamSettings.sortorder,"displaySortOrderPulldown":false,"displayCounter":false,"displayTopPostHighlight":false,"displaySharingIntent":false,"displayLikeIntent":wp_e2[thisContainer].recommend,"displayReplyIntent":wp_e2[thisContainer].includereply,"displayCommunityFlagIntent":wp_e2[thisContainer].includereport,"replyNestingLevels":2,"itemTypes":["comment"],"maxItemBodyCharacters":750,"labels":{"seeMore":"See Morexxx","childrenMoreItems":"See More Replies"},"sortOrderEntries":[{"title":"Newest First ","value":"reverseChronological"},{"title":"Oldest First ","value":"chronological"},{"title":"Most Replies ","value":"repliesDescending"},{"title":"Most Liked ","value":"likesDescending"}]},"allPosts":{"visible":($("#"+thisContainer).hasClass("stream")),"label":(($("#"+thisContainer).hasClass("permalink"))?"":"All Comments"),"queryOverride":wp_e2.getQuery(wp_e2[thisContainer].guid,thisContainer,wp_e2[thisContainer].itemurl).replace(/sortOrder:\S+/,"sortOrder:"+tmpSortOrder),"displaySharingIntent":false,"plugins":wp_e2[thisContainer].plugins.streamPluginArray.concat([{"name":"Edit","nestedPlugins":[{"name":"TextCounter","limit":2000},{"name":"TWP_Edit","thisContainer":thisContainer}]},{"name":"CardUIShim","collapsedContentHeight":500,"labels":{"seeMore":"See More"}}]),"initialItemsPerPage":wp_e2[thisContainer].streamSettings.all.maxitems,"initialSortOrder":wp_e2[thisContainer].streamSettings.sortorder,"displaySortOrderPulldown":wp_e2[thisContainer].includesorts,"displayCounter":false,"displayTopPostHighlight":false,"displaySharingIntent":false,"displayLikeIntent":wp_e2[thisContainer].recommend,"displayReplyIntent":wp_e2[thisContainer].includereply,"displayCommunityFlagIntent":wp_e2[thisContainer].includereply,"replyNestingLevels":2,"itemTypes":["comment"],"maxItemBodyCharacters":750,"itemsRefreshInterval":60,"sortOrderEntries":[{"title":"Newest First ","value":"reverseChronological"},{"title":"Oldest First ","value":"chronological"},{"title":"Most Replies ","value":"repliesDescending"},{"title":"Most Liked ","value":"likesDescending"}]},"plugins":wp_e2[thisContainer].plugins.streamPluginArray.concat(wp_e2[thisContainer].plugins.submitPluginArray,conversationsPluginArray),"query":wp_e2.getQuery(wp_e2[thisContainer].guid,thisContainer,wp_e2[thisContainer].itemurl)};return canvasConfig;};wp_e2.initContainers=function(elms){wp_e2.initStatus.canvas_init=true;elms.each(function(){var elm=$(this);if(elm.hasClass("canvas")){wp_e2.initCanvas(elm);wp_e2.renderCommentCount(elm);}else{wp_e2.renderCommentCount(elm);}});};$(window.document).on("TWP.Apps.Init.Complete",function(){if(wp_e2.initStatus&&wp_e2.initStatus.badge_init===true&&wp_e2.initStatus.wp_e2_init===true&&wp_e2.initStatus.user_init===true&&wp_e2.initStatus.canvas_init===false){wp_e2.initContainers($(wp_e2.ECHO_CONTAINER));
wp_e2._getNotes($(wp_e2.ECHO_CONTAINER+".stream"));}});$(window.document).on("TWP.Echo.User.InitComplete",function(){var bannedTimes=wp_e2["suspend_user_markers"]||{},currBanTime="";var userMarkers=(wp_e2._isUserSynced()&&wp_e2.echo_user.is("logged")&&wp_e2.echo_user.get("markers")||[]);$.each(bannedTimes,function(key,value){if($.inArray(key,userMarkers)>=0){wp_e2.echo_user.userSuspended=true;return;}});});Echo.Loader.config.errorTimeout=15000;Echo.Loader.initEnvironment(function(){var jsUrl=TWP.Data.enviro.server+"/rw/sites/twpweb/js";debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"starting loader.download");Echo.Loader.download([],function(){debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]"+"starting wp_e2.init");wp_e2&&wp_e2.init();$(window.document).trigger("TWP.Apps.Init.Complete");});});wp_e2._getNotes($(wp_e2.ECHO_CONTAINER+".stream"));})(jQuery);