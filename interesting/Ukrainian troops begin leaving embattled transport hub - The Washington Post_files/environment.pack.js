/**
 * Copyright 2012-2015 Echo.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Version: 3.0.29 (2015-01-22 11:45:29 UTC)
 */
!function(a){"use strict";var b=a;window.Echo||(window.Echo={}),Echo.Utils||(Echo.Variables||(Echo.Variables={}),Echo.Utils={},Echo.Utils.cache={},Echo.Utils.regexps={templateSubstitution:"{([0-9a-z\\.]+)(?:\\:((?:[0-9a-z_-]+\\.)*[0-9a-z_-]+))?}",mobileUA:/mobile|midp-|opera mini|iphone|ipad|blackberry|nokia|samsung|docomo|symbian|windows ce|windows phone|android|up\.browser|ipod|netfront|skyfire|palm|webos|audiovox/i,w3cdtf:/^(\d{4})(?:-(\d\d)(?:-(\d\d))?(?:(?:T(\d\d):(\d\d):(\d\d))(?:\.(\d{1,3}))?(?:Z|(?:(\+|-)(\d\d):(\d\d))))?)?$/,parseURL:/^(?:(?:([^:\/\?#]+):)?\/\/)?([^:\/\?#]*)?(?::(\d+))?([^\?#]*)(?:\?([^#]*))?(?:#(.*))?/,stripTags:/<!--[\s\S]*?-->|<\/?[a-z][a-z0-9]*\b[^>]*>/gi},Echo.Utils.addCSS=function(a,c){"undefined"==typeof this.cache.cssStyles&&(this.cache.cssStyles={anchor:void 0,index:1,processed:{}});var d=this.cache.cssStyles;if(c){if(Echo.Utils.hasCSS(c))return!1;d.processed[c]=!0}var e="",f=d.anchor;f&&f.length&&(e=f.html()),e.length+a.length>1e5&&(d.index++,f=null,e="");var g=b('<style id="echo-css-rules-'+d.index+'" type="text/css">'+e+"\n"+a+"</style>");return f&&f.length?f.replaceWith(g):d.anchor?d.anchor.after(g):b(document.getElementsByTagName("head")[0]||document.documentElement).prepend(g),d.anchor=g,!0},Echo.Utils.hasCSS=function(a){return this.cache.cssStyles?!!this.cache.cssStyles.processed[a]:!1},Echo.Utils.foldl=function(a,c,d){var e;return b.each(c,function(b,c){e=d(c,a,b),void 0!==e&&(a=e)}),a},Echo.Utils.get=function(a,b,c,d){var e=Echo.Utils._prepareFieldAccessKey(b);if(!e||!a)return c;var f=!0,g=function(a,b){return d&&d(b,a),"undefined"!=typeof b[a]?b[a]:void(f=!1)},h=1===e.length?g(e.pop(),a):Echo.Utils.foldl(a,e,g);return f?h:c},Echo.Utils.remove=function(a,b){var c=Echo.Utils._prepareFieldAccessKey(b);if(!c||!a)return!1;var d=c.pop(),e=Echo.Utils.get(a,c,a);return null===e||"undefined"==typeof e[d]?!1:delete e[d]},Echo.Utils.set=function(a,b,c){var d=Echo.Utils._prepareFieldAccessKey(b);if(!d||!a)return!1;var e=d.pop(),f=a;return d.length>0&&(f=Echo.Utils.get(a,d,void 0,function(a,b){"undefined"==typeof a[b]&&(a[b]={})})),f[e]=c,!0},Echo.Utils._prepareFieldAccessKey=function(a){return a?"string"==typeof a?a.split("."):a instanceof Array&&a.length?a:!1:!1},Echo.Utils.htmlize=function(a){return"string"==typeof a?b("<div>").text(a).html():a},Echo.Utils.objectToJSON=function(a){if(window.JSON&&JSON.stringify)return JSON.stringify(a);var c,d,e=function(a){var b={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return a.replace(/[\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff\\]/g,function(a){return b.hasOwnProperty(a)?b[a]:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})};switch(typeof a){case"number":d=isFinite(a)?a:"null";break;case"string":d='"'+e(a)+'"';break;case"boolean":d=a.toString();break;default:if(a instanceof Array)c=b.map(a,function(a){return Echo.Utils.objectToJSON(a)}),d="["+c.join(",")+"]";else if(a instanceof Object){var f=a.exportProperties||a;c=Echo.Utils.foldl([],f,function(b,c,d){f instanceof Array&&(d=b,b=a[d]),c.push('"'+d+'":'+Echo.Utils.objectToJSON(b))}),d="{"+c.join(",")+"}"}else d="null"}return d},Echo.Utils.htmlTextTruncate=function(a,b,c,d){if(!b||a.length<b)return a;var e,f=[],g=0,h=0,i=/(\w)+/,j=/^(\S)+;/;for(this.cache.standaloneTags||(this.cache.standaloneTags=Echo.Utils.foldl({},"br hr input img area param base link meta option".split(" "),function(a,b){b[a]=!0})),e=0;e<a.length;e++){var k=a.charAt(e);if("<"===k){var l=a.indexOf(">",e);if(0>l)return a;var m=a.substring(e+1,l),n="",o=!1;if("/"===m.charAt(0)&&(o=!0,m=m.substring(1)),n=m.match(i)[0],o){var p=f.pop();if(!p||p!==n)return a}else this.cache.standaloneTags[n]||f.push(n);e=l}else if("&"===k&&a.substring(e).match(j))e=a.indexOf(";",e),g++;else{if(g>=b){h=e;break}g++}}if(h||d){if(h){var q=a.substring(h-1,a.length-1).match(/^\w+/);q&&(h+=q[0].length-1),h!==a.length-1&&(a=a.substring(0,h)+(c||""))}for(e=f.length-1;e>=0;e--)a+="</"+f[e]+">"}return a},Echo.Utils.stripTags=function(a){if("string"!=typeof a)return a;for(var b="";a!==b;)b=a,a=a.replace(Echo.Utils.regexps.stripTags,"");return a},Echo.Utils.sanitize=function(a,b){if("number"===b)return a=+a,isNaN(a)?void 0:a;if("plainText"===b)return Echo.Utils.stripTags(a);if("html"===b)return a.replace(/(<[^>]+?\bon)([^>]+>)/gi,"$1_$2");if("url"===b){if(a=a.replace(/^[\x00-\x20]+/,""),"/"!==a.charAt(0)||"/"!==a.charAt(1))for(var c="";;){if(c=a.substring(0,11),!/\s/.test(c))break;a=c.replace(/\s/g,"")+a.substring(11)}if(/^(?:java|vb)script:/i.test(a))return void 0}return a},Echo.Utils.parseURL=function(a){"undefined"==typeof this.cache.parsedURLs&&(this.cache.parsedURLs={});var b=this.cache.parsedURLs;if(!b.hasOwnProperty(a)){var c=a.match(Echo.Utils.regexps.parseURL);b[a]=c?{scheme:c[1]||"",domain:c[2]||"",port:c[3]||"",path:c[4]||"/",query:c[5]||"",fragment:c[6]||""}:void 0}return b[a]},Echo.Utils.getVisibleColor=function(a){var c;do{if(c=a.css("backgroundColor"),""!==c&&"transparent"!==c&&!/rgba\((0,\s*){3}0\)/.test(c)||b.nodeName(a.get(0),"body"))break;a=a.parent()}while(a);return c||"transparent"},Echo.Utils.timestampFromW3CDTF=function(a){var b=Date.parse(a);if(isNaN(b)){var c=["year","month","day","hours","minutes","seconds","milliseconds"],d=a.match(Echo.Utils.regexps.w3cdtf);if(!d)return void 0;var e=Echo.Utils.foldl({},c,function(a,b,c){b[a]=+d[c+1]||0}),f=d.slice(c.length+1);return f[0]&&(e.hours=e.hours-(f[0]+f[1]),e.minutes=e.minutes-(f[0]+f[2])),b=Date.UTC(e.year,e.month?e.month-1:e.month,e.day||1,e.hours,e.minutes,e.seconds,e.milliseconds),isNaN(b)?void 0:b/1e3}return b/1e3},Echo.Utils.isMobileDevice=function(){return"undefined"==typeof this.cache.isMobileDevice&&(this.cache.isMobileDevice=this.regexps.mobileUA.test(navigator.userAgent)),this.cache.isMobileDevice},Echo.Utils.getUniqueString=function(){return(new Date).valueOf()+Math.random().toString().substr(2)},Echo.Utils.inherit=function(a,b){var c=function(){};return b=b||function(){},c.prototype=a.prototype,b.prototype=new c,b.prototype.constructor=b,b.parent=a.prototype,b},Echo.Utils.getComponent=function(a){return Echo.Utils.get(window,a)},Echo.Utils.isComponentDefined=function(a){return!!Echo.Utils.getComponent(a)},Echo.Utils.loadImage=function(a){var c=a.image||a.defaultImage,d=b("<img>");return d.one({error:a.onerror||function(){a.defaultImage&&c!==a.defaultImage&&d.attr("src",a.defaultImage)},load:a.onload||b.noop}),d.attr("src",c)},Echo.Utils.hyperlink=function(a,c){a=b.extend({},a),c=b.extend({},c);var d=a.caption||"";delete a.caption,c.openInNewWindow&&!a.target&&(a.target="_blank"),c.skipEscaping||(a.href=Echo.Utils.htmlize(a.href)),a.href=a.href||"javascript:void(0)";var e=Echo.Utils.foldl([],a,function(a,b,c){b.push(c+'="'+a+'"')});return"<a "+e.join(" ")+">"+d+"</a>"},Echo.Utils.log=function(a){window.console&&console.log&&a&&a.message&&console.log("["+(a.component||"Echo SDK")+"]",a.type||"info",":",a.message," | args: ",a.args)},Echo.Utils.parallelCall=function(a,c){if(!a||!a.length)return void(c&&c());var d=a.length;b.map(a,function(a){a(function(){--d||c&&c()})})},Echo.Utils.sequentialCall=function(a,b){return a&&a.length?void a.shift()(function(){Echo.Utils.sequentialCall(a,b)}):void(b&&b())},Echo.Utils.capitalize=function(a){return a.replace(/\b[a-z]/g,function(a){return a.toUpperCase()})},Echo.Utils.substitute=function(a){var c=this,d=a.template,e={data:function(b,d){return c.get(a.data,b,d)}},f=a.instructions?b.extend(e,a.instructions):e;if("undefined"==typeof c.cache.regexps){var g=c.regexps.templateSubstitution;c.cache.regexps={strict:new RegExp("^"+g+"$","i"),single:new RegExp(g,"i"),multiple:new RegExp(g,"ig")}}if(a.strict&&c.cache.regexps.strict.test(d)){var h=c.cache.regexps.single.exec(d);if(h&&h[1]&&f[h[1]])return f[h[1]](h[2])}var i=a.normalizer||function(a){return a};return d.replace(c.cache.regexps.multiple,function(a,b,c,d,e){if(!f[b])return a;var g=f[b](c,""),h={number:!0,string:!0,"boolean":!0};return h[typeof g]?i(g,e,d):""})},Echo.Utils.invoke=function(a,c){return b.isFunction(a)?c?a.call(c):a():a},Echo.Utils.debounce=function(a,b,c){var d,e,f,g,h,i=Date.now||function(){return(new Date).getTime()},j=function(){var k=i()-g;b>k&&k>0?d=setTimeout(j,b-k):(d=null,c||(h=a.apply(f,e),d||(f=e=null)))};return function(){f=this,e=arguments,g=i();var k=c&&!d;return d||(d=setTimeout(j,b)),k&&(h=a.apply(f,e),f=e=null),h}},Echo.Utils.safelyExecute=function(a,c,d){d=d||null,c=b.isArray(c)?c:"undefined"==typeof c?[]:[c];try{return a.apply(d,c)}catch(e){Echo.Utils.log({type:"error",message:e.message||e,component:d instanceof Echo.Control?d.name:""})}},Echo.Utils.random=function(a,b){return a+Math.floor(Math.random()*(b-a+1))},Echo.Utils.deepEqual=function(a,c){var d=[],e=[],f=function(a,c){var f=b.type(a),g=b.type(c),h=~b.inArray(a,d),i=~b.inArray(c,e);return f!==g?!1:h||i?a===c||h&&i:this[f]&&!this[f](a,c)?!1:!0},g=function(a,b){return a===b},h={number:g,string:g,"boolean":g,array:function(a,b){var c=a.length;if(c!==b.length)return!1;d.push(a),e.push(b);for(var g=0;c>g;g++)if(!f.call(this,a[g],b[g]))return!1;return!0},object:function(a,b){var c,g=[],h=[];d.push(a),e.push(b);for(c in a)if(a.hasOwnProperty(c)&&(g.push(c),!f.call(this,a[c],b[c])))return!1;for(c in b)b.hasOwnProperty(c)&&h.push(c);return this.array(g.sort(),h.sort())}};return f.call(h,a,c)},Echo.Utils.retry=function(a,c,d,e){c=c||{},e=e||[];var f=c.times||1,g=c.ratio;return function h(c){return a.apply(d,e).then(null,function(){var a,d=b.Deferred(),e=function(){h(c+1).then(d.resolve,d.reject)};return f>c?"undefined"!=typeof g?(a=g*Echo.Utils.random(0,Math.pow(2,c)),setTimeout(e,1e3*a)):e():d.reject(arguments),d})}(0)},Echo.Utils.promisify=function(a,c){return function(){var d=Array.prototype.slice,e=d.call(arguments,0,a.length-1),f=b.Deferred();return e.push(function(){var a=d.call(arguments),b=a.shift();b?f.reject(b):f.resolve.apply(f,a)}),a.apply(c,e),f}},Echo.Utils.pipe=function(){var a,c;1===arguments.length&&b.isArray(arguments[0])?(a=b.Deferred().resolve(),c=arguments[0]):(a=arguments[0],c=arguments[1]||[]);for(var d=0,e=c.length;e>d;d++)a=a.then(c[d]);return a},"BackCompat"===document.compatMode&&Echo.Utils.log({type:"error",message:"Quirks mode is not supported by JS SDK. Please make sure that the page has a valid doctype."}))}(Echo.jQuery);
!function(a){"use strict";var b=a;if(!Echo.Utils.isComponentDefined("Echo.Events")){Echo.Events={},Echo.Events.subscribe=function(a){var b=Echo.Utils.getUniqueString(),c=e(a.topic,a.context);if(a.once){var g=a.handler;a.handler=function(){Echo.Events.unsubscribe({handlerId:b}),g.apply(this,arguments)}}return f(a.topic,c,function(c,d){c[d].handlers.push({id:b,handler:a.handler})}),d[b]={context:c,topic:a.topic},b},Echo.Events.unsubscribe=function(a){var c=!1;if(a.handlerId){if(!d[a.handlerId])return!1;a.topic=d[a.handlerId].topic,a.context=d[a.handlerId].context}else a.context=e(a.topic,a.context);return a.handlerId||a.topic?f(a.topic,a.context,function g(e,h,i){b.isEmptyObject(e)||(a.handlerId?(b.each(e[h].handlers,function(b,f){return f.id===a.handlerId?(e[h].handlers.splice(b,1),delete d[f.id],c=!0,!1):void 0}),e[h].handlers.length||b.isEmptyObject(e[h].contexts)&&delete e[h],i.length&&f(a.topic,i.join("/"),g)):(b.each(e[h].handlers,function(a,b){delete d[b.id]}),delete e[h],c=!0))}):b.each(Echo.Events._subscriptions,function(e){f(e,a.context,function(a,e){b.isEmptyObject(a)||(b.each(a[e].handlers,function(a,b){delete d[b.id]}),delete a[e],c=!0)})}),c},Echo.Events.publish=function(a){a=b.extend({bubble:!0,propagation:!0,global:!0,context:"global"},a),delete c[a.topic],f(a.topic,a.context,function(b,c,d){h(b[c],a,d)}),a.global&&"global"!==a.context&&(a.context="global",Echo.Events.publish(a))},Echo.Events.newContextId=function(a){return(a?a+"/":"")+Echo.Utils.getUniqueString()};var c={},d={};Echo.Events._subscriptions={};var e=function(a,c){if(c=c||"global",a){var d=Echo.Events._subscriptions[a]=Echo.Events._subscriptions[a]||{};b.each(c.split("/"),function(a,b){d[b]||(d[b]={contexts:{},handlers:[]}),d=d[b].contexts})}return c},f=function(a,c,d){var e=c.split("/"),f=e.pop(),g=Echo.Events._subscriptions[a];g&&(b.each(e,function(a,b){g=g[b]&&g[b].contexts||{}}),d(g,f,e))},g=function(a,d){var e=c[d]&&c[d].stop;return e?"bubble"===a?~b.inArray("bubble",e):~b.inArray("propagation",e)||~b.inArray(a,e):!1},h=function(a,d,e){var f,i=(a&&a.handlers||[]).slice(0);b.each(i,function(a,b){return c[d.topic]=b.handler(d.topic,d.data),g("propagation.siblings",d.topic)?!1:void 0}),d.bubble&&e.length&&!g("bubble",d.topic)&&(f=b.extend({},d),f.context=e.join("/"),f.global=!1,f.propagation=!1,Echo.Events.publish(f)),d.propagation&&!g("propagation.children",d.topic)&&(f=b.extend({},d),f.global=!1,f.bubble=!1,b.each(a&&a.contexts||{},function(a,b){return h(b,f,[]),g("propagation.siblings",f.topic)?!1:void 0}))}}}(Echo.jQuery);
!function(a){"use strict";var b=a;Echo.Utils.isComponentDefined("Echo.Labels")||(Echo.Labels=function(a,c){var d=this;this.storage={},this.namespace=c,b.each(a,function(a,b){d.storage[Echo.Labels._key(a,d.namespace)]=b})},Echo.Labels.prototype.get=function(a,b){var c=Echo.Labels._key(a,this.namespace);return this.storage[c]?Echo.Labels._substitute(this.storage[c],b):Echo.Labels.get(a,this.namespace,b)},Echo.Labels.prototype.set=function(a){var c=this;b.each(a,function(a,b){var d=Echo.Labels._key(a,c.namespace);c.storage[d]=b})},Echo.Labels.set=function(a,c,d){b.each(a,function(a,b){var e=Echo.Labels._key(a,c);Echo.Labels._storage[d?"general":"custom"][e]=b})},Echo.Labels.get=function(a,b,c){var d=Echo.Labels._key(a,b),e=Echo.Labels._storage.custom[d]||Echo.Labels._storage.general[d]||a;return Echo.Labels._substitute(e,c)},Echo.Labels._storage={general:{},custom:{}},Echo.Labels._key=function(a,b){return(b?b+".":"")+a},Echo.Labels._substitute=function(a,c){return b.each(c||{},function(b,c){a=a.replace(new RegExp("{"+b+"}","g"),c)}),a})}(Echo.jQuery);
!function(a){"use strict";var b=a;Echo.Utils.isComponentDefined("Echo.Configuration")||(Echo.Configuration=function(a,c,d,e){this.data={},this.cache={},this.normalize=d||function(a,b){return b},b.each(this._merge(a,c,e),b.proxy(this._set,this))},Echo.Configuration.prototype.get=function(a,b){return"string"!=typeof a&&(a=a.join(".")),this.cache.hasOwnProperty(a)||(this.cache[a]=Echo.Utils.get(this.data,a)),"undefined"==typeof this.cache[a]?b:this.cache[a]},Echo.Configuration.prototype.set=function(a,b){delete this.cache[a],"object"==typeof b&&this._clearCacheByPrefix(a),this._set(a,b)},Echo.Configuration.prototype.remove=function(a){var b=a.split("."),c=b.pop(),d=Echo.Utils.get(this.data,b,this.data);Echo.Utils.set(this.cache,a,void 0),delete this.cache[a],delete d[c]},Echo.Configuration.prototype.extend=function(a){b.each(a,b.proxy(this.set,this))},Echo.Configuration.prototype.getAsHash=function(){return b.extend({},this.data)},Echo.Configuration.prototype._set=function(a,b){Echo.Utils.set(this.data,a,this.normalize(a.split(".").pop(),b))},Echo.Configuration.prototype._clearCacheByPrefix=function(a){var c=this;a+=".",b.each(this.cache,function(b){b.indexOf(a)||delete c.cache[b]})},Echo.Configuration.prototype._merge=function(a,c,d){for(var e,f,g,h=this,i=[a,c],j=function(a,c){f=e[a],d&&d[a]?e.hasOwnProperty(a)||(e[a]=c):b.isPlainObject(f)?e[a]=h._merge(f,c):e.hasOwnProperty(a)||(e[a]=h._merge(c))},k=function(a){return h._merge(a)},l=0;l<i.length;l++)g=i[l],b.isPlainObject(g)?(e=e||{},b.each(g,j)):b.isArray(g)?e=b.map(g,k):"undefined"==typeof e&&"undefined"!=typeof g&&(e=g);return e})}(Echo.jQuery);
!function(a){"use strict";var b=a;if(!Echo.API||!Echo.API.Transport){Echo.API={Transports:{},Request:{}};var c=Echo.Utils;if(Echo.API.Transport=function(a){this.config=new Echo.Configuration(a,{data:{},uri:"",secure:!1,settings:{crossDomain:!0,dataType:"json"},onData:function(){},onOpen:function(){},onClose:function(){},onError:function(){}}),this._connect()},Echo.API.Transport.prototype._connect=function(){this.transportObject=this._getTransportObject()},Echo.API.Transport.prototype._wrapErrorResponse=function(a){return{result:"error",errorCode:"connection_failure",errorMessage:"",transportError:a||""}},Echo.API.Transport.prototype._prepareURL=function(){return this._getScheme()+"//"+this.config.get("uri")},Echo.API.Transports.WebSockets=c.inherit(Echo.API.Transport,function(a){return a&&a.uri?(a=b.extend(!0,{settings:{maxConnectRetries:3,serverPingInterval:30,closeSocketTimeout:10,protocols:["liveupdate.ws.echoenabled.com"]}},a||{}),this.timers={ping:null,pong:null,close:null},this.subscriptionIds={},this.unique=Echo.Utils.getUniqueString(),void Echo.API.Transports.WebSockets.parent.constructor.call(this,a)):void Echo.Utils.log({type:"error",component:"Echo.API.Transports.WebSockets",message:"Unable to initialize WebSockets transport, config is invalid",args:{config:a}})}),Echo.API.Transports.WebSockets.socketByURI={},Echo.API.Transports.WebSockets.prototype.connecting=function(){return this.transportObject&&0===this.transportObject.readyState},Echo.API.Transports.WebSockets.prototype.connected=function(){return this.transportObject&&1===this.transportObject.readyState&&Echo.API.Transports.WebSockets.isSocketReady(this.config.get("uri"))},Echo.API.Transports.WebSockets.prototype.closing=function(){return this.transportObject&&2===this.transportObject.readyState},Echo.API.Transports.WebSockets.prototype.closed=function(){return this.transportObject&&3===this.transportObject.readyState},Echo.API.Transports.WebSockets.prototype.subscribe=function(a,c){var d=Echo.Events.subscribe(b.extend(!0,{topic:"Echo.API.Transports.WebSockets."+a,context:this._context(this.unique)},c));return this.subscriptionIds[a]=this.subscriptionIds[a]||[],this.subscriptionIds[a].push(d),d},Echo.API.Transports.WebSockets.prototype.unsubscribe=function f(a){var c,d=this;"string"==typeof a?(c=this.subscriptionIds[a],c?(b.map(c,function(a){Echo.Events.unsubscribe({handlerId:a})}),this.subscriptionIds[a]=[]):b.each(this.subscriptionIds,function(b,c){d.subscriptionIds[b]=Echo.Utils.foldl([],c,function(b,c){b.toString()===a.toString()?Echo.Events.unsubscribe({handlerId:b}):c.push(b)})})):(b.each(this.subscriptionIds,b.proxy(f,this)),this.subscriptionIds={})},Echo.API.Transports.WebSockets.prototype.abort=function(a){var c=this,d=Echo.API.Transports.WebSockets.socketByURI[this.config.get("uri")];d&&(delete d.subscribers[this.unique],this._clearTimers(),this.subscribe("onClose",{once:!0,handler:function(){c.unsubscribe()}}),(b.isEmptyObject(d.subscribers)||a)&&this.connected()&&(this.timers.close=setTimeout(b.proxy(this._onCloseHandler,this),1e3*this.config.get("settings.closeSocketTimeout")),this.transportObject.close()))},Echo.API.Transports.WebSockets.prototype.send=function(a){return a.subscription=a.subscription||this.unique,this.transportObject.send(Echo.Utils.objectToJSON(a))},Echo.API.Transports.WebSockets.prototype.keepConnection=function(){var a=1e3*this.config.get("settings.serverPingInterval");this.timers.ping=setInterval(b.proxy(this._ping,this),a)},Echo.API.Transports.WebSockets.prototype.publish=function(a,b){this._publish(a,b,this.unique)},Echo.API.Transports.WebSockets.prototype._getScheme=function(){return this.config.get("secure")?"wss:":"ws:"},Echo.API.Transports.WebSockets.prototype._context=function(a){return this.config.get("uri").replace(/\//g,"-")+(a?"/"+a:"")},Echo.API.Transports.WebSockets.prototype._getTransportObject=function(){var a=this,c=this.config.get("uri"),d=Echo.API.Transports.WebSockets.socketByURI;return b.map(["onOpen","onClose","onError","onData"],function(b){a.subscribe(b,{handler:function(c,d){a.config.get(b)(d),"onClose"===b&&(clearTimeout(a.timers.close),a._clearTimers())},context:a._context("onData"===b?a.unique:void 0)})}),d[c]||(d[c]={socket:this._prepareTransportObject(),state:"in-progress",subscribers:{}}),d[c].subscribers[this.unique]=!0,d[c].socket},Echo.API.Transports.WebSockets.prototype._prepareTransportObject=function(){var a=this;if(!this.connecting()&&!this.connected()){this._clearTimers();var c=window.WebSocket||window.MozWebSocket,d=new c(this._prepareURL(),this.config.get("settings.protocols"));return d.onopen=function(){a._ping(function(){Echo.API.Transports.WebSockets.setSocketState(a.config.get("uri"),"ready"),a._publish("onOpen")}),a.keepConnection()},d.onmessage=function(c){if(c&&c.data){var d=b.parseJSON(c.data);a._publish("onData",d,d&&d.subscription)}},d.onclose=function(){a._onCloseHandler()},d.onerror=function(b){a._publish("onError",a._wrapErrorResponse(b))},d}},Echo.API.Transports.WebSockets.prototype._resetRetriesAttempts=function(){this.attemptsRemaining=this.config.get("settings.maxConnectRetries")},Echo.API.Transports.WebSockets.prototype._clearTimers=function(){this.timers.ping&&clearInterval(this.timers.ping),this.timers.pong&&clearTimeout(this.timers.pong),this.timers={}},Echo.API.Transports.WebSockets.prototype._onCloseHandler=function(){this._clear(),this._publish("onClose")},Echo.API.Transports.WebSockets.prototype._clear=function(){delete Echo.API.Transports.WebSockets.socketByURI[this.config.get("uri")]},Echo.API.Transports.WebSockets.prototype._publish=function(a,b,c){Echo.Events.publish({topic:"Echo.API.Transports.WebSockets."+a,data:b||{},propagation:!c,global:!1,context:this._context(c)})},Echo.API.Transports.WebSockets.prototype._ping=function(a){var b=this,c=Echo.Events.subscribe({topic:"Echo.API.Transports.WebSockets.onData",handler:function(d,e){e&&"pong"===e.event&&(clearTimeout(b.timers.pong),Echo.Events.unsubscribe({handlerId:c}),b._resetRetriesAttempts(),a&&a())},context:this._context()});this.send({event:"ping"}),this.timers.pong=setTimeout(function(){Echo.Events.unsubscribe({handlerId:c}),b._tryReconnect()},1e3*this.config.get("settings.serverPingInterval"))},Echo.API.Transports.WebSockets.prototype._tryReconnect=function(){this.attemptsRemaining--,0===this.attemptsRemaining&&this.abort(!0)},Echo.API.Transports.WebSockets.getSocketState=function(a){return this.socketByURI[a].state},Echo.API.Transports.WebSockets.setSocketState=function(a,b){return this.socketByURI[a].state=b,this.socketByURI[a]},Echo.API.Transports.WebSockets.isSocketReady=function(a){return"ready"===this.getSocketState(a)},Echo.API.Transports.WebSockets.available=function(){return!(!window.WebSocket&&!window.MozWebSocket)},Echo.API.Transports.AJAX=c.inherit(Echo.API.Transport,function(a){return a=b.extend({method:"get"},a||{}),Echo.API.Transports.AJAX.parent.constructor.call(this,a)}),Echo.API.Transports.AJAX.prototype._getScheme=function(){return this.config.get("secure")?"https:":"http:"},Echo.API.Transports.AJAX.prototype._getTransportObject=function(){var a=this;return b.extend(!0,{url:this._prepareURL(),type:this.config.get("method"),error:function(b,c){b=a._wrapErrorResponse(b),b.transportError&&"abort"===b.transportError.statusText&&(b.errorCode="connection_aborted"),a.config.get("onError")(b,c)},success:this.config.get("onData"),complete:this.config.get("onClose"),beforeSend:function(b){a.transportObject=b,a.config.get("onOpen").apply(null,arguments)}},this.config.get("settings"))},Echo.API.Transports.AJAX.prototype._wrapErrorResponse=function(a){var c=Echo.API.Transports.AJAX.parent._wrapErrorResponse.apply(this,arguments);if(a&&a.responseText){var d;try{d=b.parseJSON(a.responseText)}catch(e){}return d||c}return c},Echo.API.Transports.AJAX.prototype.send=function(a){var c=this.config.get("data");a="string"==typeof a?a:"string"==typeof c?c:b.extend({},c,a||{}),"undefined"==typeof this.transportObject.status?(this.transportObject=this._getTransportObject(),this.transportObject.data=a,this.transportObject=b.ajax(this.transportObject)):b.ajax(b.extend(this._getTransportObject(),{data:a}))},Echo.API.Transports.AJAX.prototype.abort=function(){this.transportObject&&this.transportObject.abort&&this.transportObject.abort()},Echo.API.Transports.AJAX.available=function(){return b.support.cors},Echo.API.Transports.XDomainRequest=c.inherit(Echo.API.Transports.AJAX,function(){return Echo.API.Transports.XDomainRequest.parent.constructor.apply(this,arguments)}),!a.support.cors&&window.XDomainRequest){var d=/\/json/i,e=/\/xml/i;a.ajaxTransport("text html xml json",function(a,c){var f=null,g=(c.dataType||"").toLowerCase();return{send:function(h,i){f=new XDomainRequest,/^\d+$/.test(c.timeout)&&(f.timeout=c.timeout),f.ontimeout=function(){i(500,"timeout")},f.onload=function(){var a="Content-Length: "+f.responseText.length+"\r\nContent-Type: "+f.contentType,c={code:200,message:"success"},h={text:f.responseText};try{if("json"===g||"text"!==g&&d.test(f.contentType))try{h.json=b.parseJSON(f.responseText)}catch(j){c.code=500,c.message="parseerror"}else if("xml"===g||"text"!==g&&e.test(f.contentType)){var k=new ActiveXObject("Microsoft.XMLDOM");k.async=!1;try{k.loadXML(f.responseText)}catch(j){k=void 0}if(!k||!k.documentElement||k.getElementsByTagName("parsererror").length)throw c.code=500,c.message="parseerror","Invalid XML: "+f.responseText;h.xml=k}}catch(l){throw l}finally{i(c.code,c.message,h,a)}},f.onerror=function(){i(500,"error",{text:f.responseText})};var j="";b.isPlainObject(c.data)||b.isArray(c.data)?j=b.param(c.data):"string"==typeof c.data&&(j=c.data),f.open(a.type,a.url),f.send(j)},abort:function(){f&&f.abort()}}})}Echo.API.Transports.XDomainRequest.prototype._getTransportObject=function(){var a=Echo.API.Transports.XDomainRequest.parent._getTransportObject.call(this),d=c.parseURL(document.location.href).domain,e=c.parseURL(this.config.get("uri")).domain;return d===e?a:b.extend(a,{cache:!1})},Echo.API.Transports.XDomainRequest.available=function(a){a=a||{method:"",secure:!1};var b=a.secure?"https:":"http:",c=/^get|post$/i.test(a.method)&&/^https?/.test(b)&&document.location.protocol===b;return"XDomainRequest"in window&&c},Echo.API.Transports.JSONP=c.inherit(Echo.API.Transports.AJAX,function(){return Echo.API.Transports.JSONP.parent.constructor.apply(this,arguments)}),Echo.API.Transports.JSONP.prototype.send=function(a){return"get"===this.config.get("method").toLowerCase()?Echo.API.Transports.JSONP.parent.send.apply(this,arguments):(this._pushPostParameters(b.extend({},this.config.get("data"),a)),this.transportObject.form.submit(),void this.config.get("onData")())},Echo.API.Transports.JSONP.prototype.abort=function(){return this.transportObject.form&&this.transportObject.iframe?(this.transportObject.form.remove(),void this.transportObject.iframe.remove()):Echo.API.Transports.JSONP.parent.abort.call(this)},Echo.API.Transports.JSONP.prototype._getTransportObject=function(){var a=Echo.API.Transports.JSONP.parent._getTransportObject.call(this);return"post"===this.config.get("method").toLowerCase()?this._getPostTransportObject({url:a.url}):(delete a.xhr,a.dataType="jsonp",a)},Echo.API.Transports.JSONP.prototype._getPostTransportObject=function(a){var c="echo-post-"+Math.random(),d=b("#echo-post-request").length?b("#echo-post-request").empty():b('<div id="echo-post-request"/>').css({height:0}).prependTo("body");this.iframe=this.iframe||b('<iframe id="'+c+'" name="'+c+'" width="0" height="0" frameborder="0" border="0"></iframe>').appendTo(d);var e=b("<form/>",{target:c,method:"POST",enctype:"application/x-www-form-urlencoded",acceptCharset:"UTF-8",action:a.url}).appendTo(d);return this._pushPostParameters(a.data),{form:e,iframe:this.iframe}},Echo.API.Transports.JSONP.prototype._pushPostParameters=function(a){var c=this;return b.each(a||{},function(a,d){b("<input/>",{type:"hidden",name:a,value:d}).appendTo(c.transportObject.form)}),c.transportObject},Echo.API.Transports.JSONP.available=function(){return!0},Echo.API.Request=function(a){var c=this;return a&&a.endpoint?(this.config=new Echo.Configuration(a,{onData:b.noop,onError:b.noop,onOpen:b.noop,onClose:b.noop,apiBaseURL:"//api.echoenabled.com/v1/",data:{},transport:"ajax",method:"GET",secure:!1,timeout:30},function(a,b){return c._configNormalizers[a]?c._configNormalizers[a].call(c,b):b}),this.deferred={transport:b.Deferred()},void(this.transport=this._getTransport())):(Echo.Utils.log({type:"error",component:"Echo.API",message:"Unable to initialize API request, config is invalid",args:{config:a}}),{})},Echo.API.Request.prototype._configNormalizers={transport:function(a){return"string"==typeof a?this._normalizeTransportName(a)||this._normalizeTransportName("ajax"):this._normalizeTransportName("ajax")}},Echo.API.Request.prototype._isSecureRequest=function(a){var b,d=this.config.get("secure"),e=/https|wss/;return d?d:(b=c.parseURL(a),e.test(window.location.protocol)||e.test(b.scheme))},Echo.API.Request.prototype.send=function(a){var b=!1;a&&(b=a.force,delete a.force,this.config.extend(a),this.transport.config.extend(a));var c=this["_"+this.config.get("endpoint")];return c&&c.call(this,b),this.deferred.transport.promise()},Echo.API.Request.prototype.request=function(a){var c=this,d=this.config.get("timeout");return this.transport&&(this.transport.config.extend(b.extend(!0,this.transport.config.getAsHash(),this._getTransportConfig())),d&&this.config.get("onError")&&(this._timeoutId=setTimeout(function(){c.config.get("onError")({result:"error",errorCode:"network_timeout"},{critical:!0}),c.transport.abort()},1e3*d)),this.transport.send(a)),this.deferred.transport.promise()},Echo.API.Request.prototype.abort=function(){this.transport&&this.transport.abort(),clearTimeout(this._timeoutId),this.deferred.transport&&this.deferred.transport.reject()},Echo.API.Request.prototype._normalizeTransportName=function(a){return c.foldl("",Echo.API.Transports,function(b,c,d){return a.toLowerCase()===d.toLowerCase()?d:void 0})},Echo.API.Request.prototype._getTransport=function(){var a=this,c=this._isSecureRequest(this._prepareURL()),d=this.config.get("transport"),e=Echo.API.Transports[d]&&Echo.API.Transports[d].available()?d:function(){var d;return b.each(["WebSockets","AJAX","XDomainRequest","JSONP"],function(b,e){var f=Echo.API.Transports[e].available({secure:c,method:a.config.get("method")});return f?(d=e,!1):void 0}),d}();return new Echo.API.Transports[e](this._getTransportConfig())},Echo.API.Request.prototype._getTransportConfig=function(){var a=this._prepareURL();return b.extend(this._getHandlersByConfig(),{uri:a.replace(/^(?:(?:http|ws)s?:)?\/\//,""),data:this.config.get("data"),method:this.config.get("method"),secure:this._isSecureRequest(a),settings:this.config.get("settings")})},Echo.API.Request.prototype._getHandlersByConfig=function(){var a=this;return c.foldl({},this.config.getAsHash(),function(c,d,e){var f;/^on[A-Z]/.test(e)&&b.isFunction(c)&&(f="onOpen"!==e?function(){var d=Array.prototype.slice.call(arguments);clearTimeout(a._timeoutId),c.apply(null,arguments),(a.deferred.transport[{onData:"notifyWith",onError:"rejectWith",onClose:"resolveWith"}[e]]||b.noop).call(a.deferred.transport,null,d),("onClose"===e||"onError"===e)&&(a.deferred.transport=b.Deferred())}:c,d[e]=f)})},Echo.API.Request.prototype._prepareURL=function(){return this.config.get("apiBaseURL")+this.config.get("endpoint")}}}(Echo.jQuery);
!function(a){"use strict";var b=a;Echo.StreamServer&&Echo.StreamServer.API||(Echo.StreamServer||(Echo.StreamServer={}),Echo.StreamServer.API={},Echo.StreamServer.API.Request=Echo.Utils.inherit(Echo.API.Request,function(a){var c=a&&a.liveUpdates&&a.liveUpdates.timeout||a.liveUpdatesTimeout,d=a&&a.liveUpdates&&a.liveUpdates.enabled||a.recurring;a=b.extend(!0,{liveUpdates:{transport:"polling",enabled:d,polling:{timeout:c||10},websockets:{maxConnectRetries:3,serverPingInterval:30,resetPeriod:60,maxResetsPerPeriod:2,fallback:{timeout:10,divergence:5},waitingForConnection:5,URL:"//live.echoenabled.com/v1/"}},skipInitialRequest:!1,itemURIPattern:void 0,onData:b.noop,onError:b.noop,onOpen:b.noop,onClose:b.noop,submissionProxyURL:"https://apps.echoenabled.com/v2/esp/activity"},a),a=this._wrapTransportEventHandlers(a),this.requestType="initial",Echo.StreamServer.API.Request.parent.constructor.call(this,a)}),Echo.StreamServer.API.Request.prototype.abort=function(){var a=this;Echo.StreamServer.API.Request.parent.abort.call(this),this.liveUpdates&&(this.liveUpdates.on("close",function(){delete a.liveUpdates}),this.liveUpdates.stop())},Echo.StreamServer.API.Request.prototype._count=Echo.StreamServer.API.Request.prototype._search=function(a){var b=this,c=function(c){b.config.get("liveUpdates.enabled")&&(b.liveUpdates||b._initLiveUpdates(c||{}),b.liveUpdates.start(a)),b.requestType="secondary"};!this.config.get("skipInitialRequest")||this.config.get("skipInitialRequest")&&"initial"!==this.requestType?this.request().progress(c):c()},Echo.StreamServer.API.Request.prototype._submit=function(){this.request(b.extend({},this.config.get("data"),{content:Echo.Utils.objectToJSON(this._AS2KVL(this.config.get("data.content")))}))},Echo.StreamServer.API.Request.prototype._mux=function(){this.request(b.extend({},this.config.get("data"),{requests:Echo.Utils.objectToJSON(this.config.get("data.requests"))}))},Echo.StreamServer.API.Request.prototype._wrapTransportEventHandlers=function(a){var c=this,d=b.extend({},a);return b.extend({},a,{onOpen:function(a){d.onOpen(a,{requestType:c.requestType}),clearInterval(c.retryTimer),delete c.retryTimer},onData:function(a){c._onData(a,{requestType:c.requestType},d)},onError:function(a,b){c._onError(a,b,d)}})},Echo.StreamServer.API.Request.prototype._onData=function(a,b,c){return a=a||{},"error"===a.result?void this._handleErrorResponse(a,{callback:c.onError}):(c.onData(a,b),this.requestType="secondary",void this._cleanupErrorHandlers(!0))},Echo.StreamServer.API.Request.prototype._onError=function(a,b,c){this._handleErrorResponse(a,{callback:c.onError})},Echo.StreamServer.API.Request.prototype._prepareURL=function(){var a=this.config.get("endpoint");if("submit"===a)return this.config.get("submissionProxyURL");var b=this.constructor.parent._prepareURL.call(this);return"mux"===a?b.replace("v1","v2"):b},Echo.StreamServer.API.Request.prototype._initLiveUpdates=function(a){var c,d=Echo.StreamServer.API.Polling.init(b.extend(!0,this._getLiveUpdatesConfig("polling"),{request:{data:{since:(a||{}).nextSince}}}));"websockets"===this.config.get("liveUpdates.transport")&&Echo.API.Transports.WebSockets.available()?(c=this.liveUpdates=Echo.StreamServer.API.WebSockets.init(b.extend(!0,this._getLiveUpdatesConfig("websockets"),{request:{data:{since:(a||{}).nextSince}}})),this._liveUpdatesWatcher(d,c)):this.liveUpdates=d},Echo.StreamServer.API.Request.prototype._getLiveUpdatesConfig=function(a){var b=this,c={polling:{timeout:"liveUpdates.polling.timeout","request.onOpen":"liveUpdates.onOpen","request.onData":"liveUpdates.onData","request.onError":"liveUpdates.onError","request.onClose":"liveUpdates.onClose","request.endpoint":"endpoint","request.data":"data","request.apiBaseURL":"apiBaseURL","request.secure":"secure"},websockets:{"request.onOpen":"liveUpdates.onOpen","request.onData":"liveUpdates.onData","request.onError":"liveUpdates.onError","request.onClose":"liveUpdates.onClose","request.endpoint":"endpoint","request.data":"data","request.secure":"secure","request.apiBaseURL":"liveUpdates.websockets.URL","resubscribe.resetPeriod":"liveUpdates.websockets.resetPeriod","resubscribe.maxResetsPerPeriod":"liveUpdates.websockets.maxResetsPerPeriod","request.settings.maxConnectRetries":"liveUpdates.websockets.maxConnectRetries","request.settings.serverPingInterval":"liveUpdates.websockets.serverPingInterval","request.settings.closeSocketTimeout":"liveUpdates.websockets.closeSocketTimeout"}},d=Echo.Utils.foldl({},c[a],function(a,c,d){var e=function f(a){var c=b.config.get(a);return"undefined"==typeof c&&a?f(a.split(".").slice(1).join(".")):c}(a);Echo.Utils.set(c,d,e)});return d},Echo.StreamServer.API.Request.prototype._liveUpdatesWatcher=function(a,b){var c,d,e=this,f=this.config.get("liveUpdates.websockets"),g=function(a){return function(){e.liveUpdates.connected()&&e.liveUpdates.stop(),e.liveUpdates=a,e.liveUpdates.start()}};return b.on("close",function(){var b,h=f.fallback;clearTimeout(d),e.liveUpdates&&"abort"!==e.liveUpdates.closeReason&&(b=1e3*Echo.Utils.random(h.timeout-h.divergence,h.timeout+h.divergence),c=setTimeout(function(){g(a)()},b))}),b.on("quotaExceeded",g(a)),d=setTimeout(function(){clearTimeout(c),g(a)()},1e3*f.waitingForConnection),b.connected()?void clearTimeout(d):void b.on("open",function(){e.liveUpdates instanceof Echo.StreamServer.API.WebSockets||g(b)(),clearTimeout(d)})},Echo.StreamServer.API.Request.prototype._isWaitingForData=function(a){var c=["busy","waiting","timeout","view_limit","view_update_capacity_exceeded","connection_failure","network_timeout"];return a&&"submit"!==this.config.get("endpoint")&&~b.inArray(a.errorCode,c)},Echo.StreamServer.API.Request.prototype._handleErrorResponse=function(a,b){var c=this;b=b||{};var d=b.callback,e=function(){return c.waitingTimeoutStep>0?c.waitingTimeoutStep<7&&c.waitingTimeoutStep++:c.waitingTimeoutStep=1,1e3*Math.pow(c.waitingTimeoutStep,2)};if(this._isWaitingForData(a)){var f=e();this.waitingTimer=setInterval(function(){c._cleanupErrorHandlers();var a=function(a){c.liveUpdates||c._initLiveUpdates(a),c.liveUpdates.start()};"initial"===c.requestType?c.request().progress(a):a()},f),d(a,{requestType:c.requestType,critical:!1,retryIn:f})}else this.waitingTimeoutStep=0,this.liveUpdates&&this.liveUpdates.stop(),d(a,{requestType:c.requestType,critical:"connection_aborted"!==a.errorCode});this.error=a},Echo.StreamServer.API.Request.prototype._cleanupErrorHandlers=function(a){a&&(this.waitingTimeoutStep=0,delete this.error),this.waitingTimer&&clearInterval(this.waitingTimer)},Echo.StreamServer.API.Request.prototype._AS2KVL=function(a){var c=this;a=b.isArray(a)?a:[a];var d,e=function(a){return a.replace("http://activitystrea.ms/schema/1.0/","").replace("http://js-kit.com/spec/e2/v1/","")},f=function(a,d){var e={avatar:a.actor&&a.actor.avatar,content:a.object&&a.object.content,markers:d.markers?b.trim(d.markers):void 0,name:a.actor&&(a.actor.name||a.actor.title),source:a.source,tags:d.tags?b.trim(d.tags):void 0,title:a.object&&a.object.title,target:a.targets[0].id,verb:g(a),type:h(a),itemURIPattern:c.config.get("itemURIPattern"),author:a.author};return"update"===g(a)?(e={verb:g(a),target:a.targets[0].id},b.each(a.object,function(a,b){return"objectTypes"!==a?(e.field=a,e.value=b,!1):void 0})):/tag/.test(g(a))?e={tags:a.object&&a.object.content,verb:g(a),target:a.targets[0].id}:/mark/.test(g(a))&&(e={markers:a.object&&a.object.content,verb:g(a),target:a.targets[0].id}),e},g=function(a){return e(a.verbs[0])},h=function(a){return a.object&&a.object.objectTypes?a.object.objectTypes[0]:void 0},i={markers:"",tags:""};return b.map(a,function(a){/tag|mark/.test(g(a))&&/tag|marker/.test(h(a))&&(i[e(h(a))+"s"]=a.object.content),"post"===g(a)&&(d=a)}),d?f(d,i):b.map(a,function(a){return f(a,i)})},Echo.StreamServer.API.request=function(a){return new Echo.StreamServer.API.Request(a)})}(Echo.jQuery),function(a){"use strict";var b=a;Echo.StreamServer.API&&Echo.StreamServer.API.Polling||(Echo.StreamServer.API.Polling=function(a){this.config=new Echo.Configuration(a,{timeout:10,request:{endpoint:"search",onData:b.noop,onOpen:b.noop,onError:b.noop,onClose:b.noop}}),this.timers={},this.timeouts=[],this.closeReason="unknown",this.originalTimeout=this.config.get("timeout"),this.requestObject=this.getRequestObject()},Echo.StreamServer.API.Polling.prototype.getRequestObject=function(){var a=this,c=this.config.get("request"),d=c.onData||b.noop;return b.extend(c,{onData:function(b){"error"!==b.type&&(a._changeTimeout(b),a.config.set("request.data.since",b.nextSince),a.start()),d(b)}}),new Echo.API.Request(c)},Echo.StreamServer.API.Polling.prototype.stop=function(){clearTimeout(this.timers.regular),this.closeReason="abort",this.requestObject.abort()},Echo.StreamServer.API.Polling.prototype.start=function(a){var b=this;this.stop(),a&&(this.timeouts=[0,1,3]);var c=this.timeouts.length?this.timeouts.shift():this.config.get("timeout");this.timers.regular=setTimeout(function(){b.requestObject.request({since:b.config.get("request.data.since")})},1e3*c)},Echo.StreamServer.API.Polling.prototype.on=function(a,c){a="on"+Echo.Utils.capitalize(a);var d=this.requestObject.transport.config.get(a,b.noop);this.requestObject.transport.config.set(a,function(){d.apply(null,arguments),c.apply(null,arguments)})},Echo.StreamServer.API.Polling.prototype.connected=function(){return!0},Echo.StreamServer.API.Polling.prototype._changeTimeout=function(a){var b=this;"string"==typeof a&&(a={liveUpdatesTimeout:a}),a.liveUpdatesTimeout=+a.liveUpdatesTimeout;var c=function(a){a||b.originalTimeout===b.config.get("timeout")?a&&a>b.config.get("timeout")&&b.config.set("timeout",a):b.config.set("timeout",b.originalTimeout)},d=function(a){return!(!a.entries||!a.entries.length)};if(!this.config.get("request.data.since"))return void c(a.liveUpdatesTimeout);var e=this.config.get("timeout"),f=this.config.get("request.data.since"),g=Math.floor((new Date).getTime()/1e3),h=d(a)?g-f>e?Math.min(3,this.originalTimeout):e+1:e+2;h>this.originalTimeout&&(h=this.originalTimeout),this.config.set("timeout",h),h===this.originalTimeout&&c(a.liveUpdatesTimeout)},Echo.StreamServer.API.WebSockets=Echo.Utils.inherit(Echo.StreamServer.API.Polling,function(a){this.config=new Echo.Configuration(a,{resubscribe:{maxResetsPerPeriod:2,resetPeriod:60},request:{apiBaseURL:"//live.echoenabled.com/v1/",transport:"websockets",timeout:null,onOpen:b.noop,onData:b.noop,onError:b.noop,onClose:b.noop,endpoint:"ws"}},function(a,c){if("request"===a){var d=c.endpoint;return b.extend({},c,{endpoint:"ws",wsMethod:d})}return c}),this.queue=[],this.subscribed=!1,this.closeReason="unknown",this.subscriptionResets={count:0,time:(new Date).getTime()},this.requestObject=this.getRequestObject(),this.requestObject&&this.connected()&&this.requestObject.config.get("onOpen")()}),Echo.StreamServer.API.WebSockets.prototype.getRequestObject=function(){var a=this,c=this.config.get("request"),d=b.extend({},c,{onData:function(b){if(b&&b.event){if(~b.event.indexOf("failed"))return void("quota_exceeded"===b.errorCode?(a.closeReason="server_overload",a.requestObject.transport.publish("onQuotaExceeded")):c.onError(b,{critical:!1}));if(~b.event.indexOf("reset"))return a.subscribed=!1,b.data&&b.data.nextSince&&a.config.set("request.data.since",b.data.nextSince),void(a._resubscribeAllowed()?a._updateConnection(a._resubscribe):(a.closeReason="server_overload",a.requestObject.transport.publish("onClose")));"subscribe/confirmed"===b.event&&(a.subscribed=!0,a._runQueue()),"unsubscribe/confirmed"===b.event&&(a.subscribed=!1),b.data&&(b.data.nextSince&&a.config.set("request.data.since",b.data.nextSince),b.subscription&&c.onData(b.data))}},onOpen:function(){a.subscribe(),c.onOpen.apply(null,arguments)},onError:function(b){a.closeReason="unknown",a.requestObject.transport.publish("onClose"),c.onError(b,{critical:!1})}});return new Echo.API.Request(d)},Echo.StreamServer.API.WebSockets.prototype.on=function(a,b){var c=this.requestObject.transport.subscribe("on"+Echo.Utils.capitalize(a),{handler:b});return c},Echo.StreamServer.API.WebSockets.prototype.start=b.noop,Echo.StreamServer.API.WebSockets.prototype.connected=function(){return this.requestObject.transport.connected()},Echo.StreamServer.API.WebSockets.prototype.stop=function(){var a=this;this.closeReason="abort",this.connected()&&(this.queue.push(function(){a.subscribed&&a.requestObject.request({event:"unsubscribe/request"}),a.requestObject.abort()}),this._runQueue())},Echo.StreamServer.API.WebSockets.prototype.subscribe=function(){var a={method:this.config.get("request.wsMethod")};this.requestObject.request({event:"subscribe/request",data:b.extend(a,this.config.get("request.data"))})},Echo.StreamServer.API.WebSockets.prototype._updateConnection=function(a){var c=this;a=a||b.noop;var d=b.extend(!0,{},this.config.get("request.data"));delete d.since;var e=new Echo.API.Request({endpoint:"search",data:d,secure:this.config.get("request.secure"),onData:function(){a.apply(c,arguments)},onError:function(){c.closeReason="unknown",c.requestObject.transport.publish("onClose")}});e.request()},Echo.StreamServer.API.WebSockets.prototype._reconnect=function(){var a=this;this.closeReason="reconnect",this.requestObject.abort(),this._close(function(){a.requestObject=a.getRequestObject(),a.connected()&&a.requestObject.config.get("onOpen")()})},Echo.StreamServer.API.WebSockets.prototype._resubscribe=function(){var a=this;this._close(function(){a.connected()&&a.requestObject.config.get("onOpen")()})},Echo.StreamServer.API.WebSockets.prototype._close=function(a){if(this.requestObject.transport.closing())var b=this.on("close",function(){a(),Echo.Events.unsubscribe({handlerId:b})});else a()},Echo.StreamServer.API.WebSockets.prototype._resubscribeAllowed=function(){var a=this.subscriptionResets,b=(new Date).getTime(),c=this.config.get("resubscribe"),d=Math.floor((b-a.time)/1e3);return d>c.resetPeriod?(this.subscriptionResets={count:0,time:(new Date).getTime()},!0):d<=c.resetPeriod?a.count+1<=c.maxResetsPerPeriod?(this.subscriptionResets={count:a.count+1,time:(new Date).getTime()},!0):!1:void 0},Echo.StreamServer.API.WebSockets.prototype._runQueue=function(){for(;this.queue.length;)this.queue.shift().call(this)},b.map(["WebSockets","Polling"],function(a){Echo.StreamServer.API[a].init=function(b){return new Echo.StreamServer.API[a](b)}}))}(Echo.jQuery);
!function(a){"use strict";var b=a;Echo.IdentityServer&&Echo.IdentityServer.API||(Echo.IdentityServer||(Echo.IdentityServer={}),Echo.IdentityServer.API={},Echo.IdentityServer.API.Request=Echo.Utils.inherit(Echo.API.Request,function(a){a=b.extend({submissionProxyURL:"https://apps.echoenabled.com/v2/esp/activity"},a),a=this._wrapTransportEventHandlers(a),Echo.IdentityServer.API.Request.parent.constructor.call(this,a)}),Echo.IdentityServer.API.Request.prototype._prepareURL=function(){return"whoami"===this.config.get("endpoint")?Echo.IdentityServer.API.Request.parent._prepareURL.call(this):this.config.get("submissionProxyURL")},Echo.IdentityServer.API.Request.prototype._wrapTransportEventHandlers=function(a){var c=this,d=b.extend({},a);return b.extend({},a,{onData:function(a){c._onData(a,d)}})},Echo.IdentityServer.API.Request.prototype._onData=function(a,b){return a&&"error"===a.result?void b.onError(a):void b.onData(a)},Echo.IdentityServer.API.Request.prototype._update=function(){var a=b.extend({},this.config.get("data.content"),{endpoint:"users/update"});this.request(b.extend({},this.config.get("data"),{content:Echo.Utils.objectToJSON(a)}))},Echo.IdentityServer.API.Request.prototype._whoami=function(a){this.request(a)},Echo.IdentityServer.API.request=function(a){return new Echo.IdentityServer.API.Request(a)})}(Echo.jQuery);
!function(a){"use strict";var b=a;Echo.Utils.isComponentDefined("Echo.UserSession")||(Echo.UserSession=function(a){return Echo.UserSession._construct(a)},Echo.UserSession.set=function(a,b){var c=this;c._maybeDelegate({action:"set",key:a,arg:[b],fallback:function(){c._attrLocation(a)[a]=b}})},Echo.UserSession.get=function(a,b){var c=this,d=c._maybeDelegate({action:"get",key:a,fallback:function(){return c._attrLocation(a)[a]}});return"undefined"==typeof d?b:d},Echo.UserSession.is=function(a){return this._maybeDelegate({action:"is",key:a})},Echo.UserSession.has=function(a,b){var c=this;return c._maybeDelegate({action:"has",key:a,arg:[b],fallback:function(){return c.any(a,[b])}})},Echo.UserSession.any=function(a,c){var d=this;return d._maybeDelegate({action:"any",key:a,arg:[c],fallback:function(){var e=!1;return d.identity?(b.each(c,function(c,f){var g=d.get(a,{});return"string"==typeof g&&g===f||b.isArray(g)&&b.inArray(f,g)>=0?(e=!0,!1):void 0}),e):!1}})},Echo.UserSession.logout=function(a){var b=this;return b.is("logged")?void b._logoutRequest({sessionID:b.get("sessionID")},function(){b._onInit(a),Backplane.expectMessages("identity/ack")}):(b._reset({}),void(a&&a()))},Echo.UserSession._construct=function(a){if(!a)return void Echo.Utils.log({type:"error",component:"Echo.UserSession",message:"Unable to initialize user session, config is invalid",args:{config:a}});var b=this,c=function(){a.ready&&a.ready.call(b)};switch(b.state=b.state||"init",!b._sessionID&&b.get("sessionID")&&(b._sessionID=b.get("sessionID"),b.state="ready"===b.state?"init":b.state),b.state){case"waiting":b._onInit(c);break;case"ready":c();break;default:b.data={},b.cache={},b.config=new Echo.Configuration(a,b._getDefaultConfig()),b._listenEvents(),b._init(c)}return b},Echo.UserSession._maybeDelegate=function(a){var b=this,c=Echo.Utils.capitalize(a.key),d=b["_"+a.action+c];return d?d.apply(this,a.arg||[]):a.fallback?a.fallback():void 0},Echo.UserSession._getDefaultConfig=function(){return{appkey:"",endpoints:{logout:"https://apps.echoenabled.com/v2/",whoami:"https://api.echoenabled.com/v1/users/"},useSecureAPI:!1,fakeIdentityURL:"http://js-kit.com/ECHO/user/fake_user"}},Echo.UserSession._logoutRequest=function(a,b){new Echo.API.Request({apiBaseURL:this.config.get("endpoints.logout"),secure:this.config.get("useSecureAPI"),endpoint:"logout",transport:"jsonp",onData:b,data:a}).request()},Echo.UserSession._whoamiRequest=function(a){Echo.IdentityServer.API.request({apiBaseURL:this.config.get("endpoints.whoami"),secure:this.config.get("useSecureAPI"),endpoint:"whoami",onData:a.onData,onError:a.onError,data:a.data}).send()},Echo.UserSession._listenEvents=function(){var a=this;a.backplaneSubscriptionID||(a.backplaneSubscriptionID=Backplane.subscribe(function(b){"identity/ack"===b.type&&a._init(function(){Echo.Events.publish({topic:"Echo.UserSession.onInvalidate",data:a.is("logged")?a.data:{}})})}))},Echo.UserSession._reset=function(a){var c=this;c.data=c._normalize(b.extend({},a)),c.identity={},c.cache={};var d=c.get("activeIdentities");c.identity=d&&d.length?d[0]:{}},Echo.UserSession._init=function(a){var b=this;b.state="waiting";var c=function(c){(!c||c.result&&"session_not_found"===c.result)&&(c={}),b.state="ready",b._reset(c),Echo.Events.publish({topic:"Echo.UserSession.onInit",data:c}),a&&a()};b.get("sessionID")?b._whoamiRequest({data:{appkey:b.config.get("appkey"),sessionID:b.get("sessionID")},onData:c,onError:function(a){Echo.Utils.log({type:"error",component:"Echo.UserSession",args:{response:a},message:"Unable to initialize user session, error response from IdentityServer API received"}),c()}}):c()},Echo.UserSession._normalize=function(a){return a=a||{},a.echo=a.echo||{},a.echo.state=a.echo.state||"Untouched",a.echo.roles=a.echo.roles||[],a.echo.markers=a.echo.markers||[],a.poco=a.poco||{entry:{}},a.identities=a.poco.entry.accounts||[],a},Echo.UserSession._onInit=function(a){a&&Echo.Events.subscribe({topic:"Echo.UserSession.onInit",once:!0,handler:a})},Echo.UserSession._attrLocation=function(a){return~b.inArray(a,["roles","state","markers"])?this.data.echo:this.identity},Echo.UserSession._extract=function(a,b,c){var d=this;return d.identity[a]="undefined"!=typeof d.identity[a]?d.identity[a]:Echo.Utils.foldl(void 0,d.identity[b]||[],c),d.identity[a]},Echo.UserSession._isLogged=function(){var a=this.get("activeIdentities");return!(!a||!a.length)},Echo.UserSession._isAdmin=function(){return this.any("roles",["administrator","moderator"])},Echo.UserSession._setName=function(a){this.identity.displayName=a},Echo.UserSession._getActiveIdentities=function(){var a=this;if(a.data.poco&&a.data.poco.entry){if(a.cache.activeIdentities)return a.cache.activeIdentities;var c=b.map(a.data.poco.entry.accounts||[],function(a){return"true"===a.loggedIn?a:void 0});return a.cache.activeIdentities=c,c}},Echo.UserSession._getAvatar=function(){return this._extract("avatar","photos",function(a){return"avatar"===a.type?a.value:void 0})},Echo.UserSession._getName=function(){var a=this.identity;return a?a.displayName||a.username:void 0},Echo.UserSession._getEmail=function(){return this._extract("email","emails",function(a){return"true"===a.primary?a.value:void 0})},Echo.UserSession._getSessionID=function(){return Backplane.getChannelID()},Echo.UserSession._hasIdentity=function(a){var c=this,d=!1;return b.each(c.data.identities,function(b,c){return c.identityUrl&&c.identityUrl===a?(d=!0,!1):void 0}),d},Echo.UserSession._anyMarker=function(a){return this.any("markers",a)},Echo.UserSession._anyRole=function(a){return this.any("roles",a)})}(Echo.jQuery);
!function(a){"use strict";var b=a;Echo.Utils.isComponentDefined("Echo.View")||(Echo.View=function(a){a=a||{},this.config=a,this.config.cssPrefix=this.config.cssPrefix||"",this.renderers=a.renderers||{},this._clear()},Echo.View.prototype.get=function(a){return this._elements[this._key(a)]},Echo.View.prototype.set=function(a,c){this._elements[this._key(a)]=b(c)},Echo.View.prototype.remove=function(a){var b="string"==typeof a?this._key(a):a.echo.name;this._elements[b].remove(),delete this._elements[b]},Echo.View.prototype.rendered=function(){return!!this._rendered},Echo.View.prototype.render=function(a){if(a=a||{},a.data=a.data||this.config.data||{},a.template=a.template||this.config.template,a.renderers&&b.extend(this.renderers,a.renderers),a.name){if(a.target=a.target||this.get(a.name),!a.target)return!1;var c=a.recursive?"recursive":"element";return this._render[c].call(this,a)}if(a.template){this._clear(),this._template="string"==typeof a.template?a.template:a.template.html();var d=this._render.template.call(this,a);return this._rendered=!0,d}return!1},Echo.View.prototype.fork=function(a){return new Echo.View(b.extend(!0,{},this.config,a))},Echo.View.prototype._render={},Echo.View.prototype._render.element=function(a){return this.config.renderer?this.config.renderer(a):this._hasRenderer(a.name)?this._getRenderer(a.name)(a.target,a.extra):a.target},Echo.View.prototype._render.recursive=function(a){var c=this.get(a.name);a.template=this._template;var d=this._compileTemplate(a);this._applyRenderers(b("."+this._key(a.name),d));var e=this.get(a.name);return c.replaceWith(e),e},Echo.View.prototype._render.template=function(a){var c=this._compileTemplate(a);return c.hasClass("echo-tmp-wrapper")&&(c=b(c.html())),this._applyRenderers(c)},Echo.View.prototype._key=function(a){return this.config.cssPrefix+a},Echo.View.prototype._clear=function(){this._elements={}},Echo.View.prototype._compileTemplate=function(a){if("string"!=typeof a.template)return a.template;var c=Echo.Utils.substitute({data:a.data,template:a.template,instructions:this.config.substitutions,normalizer:function(a,b,c){var d=b.substr(0,c);return d&&/<[^>]+=\s*"[^>"]*$/.test(d)?a.toString().replace(/"/g,"&quot;"):a}});return b('<div class="echo-tmp-wrapper"/>').html(c)},Echo.View.prototype._applyRenderers=function(a){var c=this,d=this._getRenderableElements(a);return b.each(d,function(a,b){c._hasRenderer(a)&&c.render({name:a,target:b})}),a},Echo.View.prototype._getRenderer=function(a){return this.renderers[a]},Echo.View.prototype._hasRenderer=function(a){return this.config.renderer?!0:!!this._getRenderer(a)},Echo.View.prototype._getRenderableElements=function(a){var c=this,d={},e=new RegExp(this.config.cssPrefix+"(.*)$");return a.find("*").addBack().each(function(a,f){if(f.className){var g=f.className.split(/[ ]+/);b.each(g,function(a,b){var g=b.match(e),h=g?g[1]:void 0;h&&(c.set(h,f),f=c.get(h),f.echo=f.echo||{},f.echo.name=b,d[h]=f)})}}),d})}(Echo.jQuery);
!function(a){"use strict";var b=a;Echo.Control=function(){},Echo.Control.create=function(a){var c=Echo.Utils.getComponent(a.name);if(Echo.Control.isDefined(a))return c;var d=this._merge(a,a.inherits&&a.inherits._manifest),e=Echo.Utils.inherit(this,function(a){return a&&a.target?(this.data=a.data||{},this.config=a,void this._init(this._initializers.get("init"))):(Echo.Utils.log({type:"error",component:d.name,message:"Unable to initialize control, config is invalid",args:{config:a}}),{})}),f=e.prototype;return d.methods&&b.extend(f,d.methods),f.templates=d.templates,f.renderers=d.renderers,f.name=d.name,e._manifest=d,a.inherits&&(e.parent=a.inherits.prototype),Echo.Labels.set(d.labels,d.name,!0),f.cssClass=d.name.toLowerCase().replace(/-/g,"").replace(/\./g,"-"),f.cssPrefix=f.cssClass+"-",Echo.Utils.set(window,d.name,b.extend(e,c)),e},Echo.Control.manifest=function(a){return{name:a,vars:{},config:{},labels:{},events:{},methods:{},renderers:{},templates:{},dependencies:[],init:function(){this.render(),this.ready()},destroy:function(){}}},Echo.Control.isDefined=function(a){var b="string"==typeof a?a:a.name,c=Echo.Utils.get(window,b);return!(!c||!c._manifest)},Echo.Control.prototype.templates={message:{}},Echo.Control.prototype.templates.message.compact='<span class="echo-control-message echo-control-message-icon echo-control-message-{data:type} {class:messageIcon} {class:messageText}" title="{data:message}">&nbsp;</span>',Echo.Control.prototype.templates.message.full='<div class="echo-control-message {class:messageText}"><span class="echo-control-message-icon echo-control-message-{data:type} {class:messageIcon}">{data:message}</span></div>',Echo.Control.prototype.get=function(a,b){return Echo.Utils.get(this,a,b)},Echo.Control.prototype.set=function(a,b){return Echo.Utils.set(this,a,b)},Echo.Control.prototype.remove=function(a){return Echo.Utils.remove(this,a)},Echo.Control.prototype.render=function(){var a=this.view,b=a.rendered()?"onRerender":"onRender";this.dependent()||a.rendered()||this.config.get("target").addClass("echo-sdk-ui");var c=a.render({template:this._compileTemplate()});return this.config.get("target").empty().append(c),this.events.publish({topic:b}),c},Echo.Control.prototype.substitute=function(a){var c=this._getSubstitutionInstructions();return a.data=a.data||this.get("data"),a.instructions=a.instructions?b.extend(c,a.instructions):c,a.normalizer=a.normalizer||function(a,b,c){var d=b.substr(0,c);return d&&/<[^>]+=\s*"[^>"]*$/.test(d)?a.toString().replace(/"/g,"&quot;"):a},Echo.Utils.substitute(a)},Echo.Control.prototype.invoke=function(a,b){return Echo.Utils.invoke(a,b||this)},Echo.Control.prototype.refresh=function(){this.destroy({self:!1}),this.set("data",this.config.get("data",{})),this._init(this._initializers.get("refresh"))},Echo.Control.prototype.destroy=function(a){Echo.Events.publish({topic:"Echo.Control.onDestroy",bubble:!1,context:this.config.get("context"),data:b.extend({producer:this,self:!0},a)})},Echo.Control.prototype.dependent=function(){return!!this.config.get("parent")},Echo.Control.prototype.showMessage=function(a){if(this.config.get("infoMessages.enabled")){var b=a.target||this.config.get("target"),c=a.layout||this.config.get("infoMessages.layout"),d=this.view.fork();b.empty().append(d.render({data:a,template:this.templates.message[c]}))}},Echo.Control.prototype.showError=function(a,b){var c=this;if("undefined"==typeof b.retryIn){var d=this.labels.get("error_"+a.errorCode),e=d==="error_"+a.errorCode?"("+a.errorCode+") "+(a.errorMessage||""):d;this.showMessage({type:b.critical?"error":"loading",message:e,target:b.target})}else if(!b.retryIn&&b.request.retryTimer)this.showMessage({type:"loading",message:this.labels.get("retrying"),target:b.target});else{var f=b.retryIn/1e3,g=function(){if(f){var d=c.labels.get("error_"+a.errorCode,{seconds:f--});c.showMessage({type:"loading",message:d,target:b.target})}};b.request.retryTimer=setInterval(g,1e3),g()}},Echo.Control.prototype.getPlugin=function(a){return this.plugins[a]},Echo.Control.prototype.template=function(){return this.invoke(this.templates.main)},Echo.Control.prototype.parentRenderer=function(a,b){var c=this.parentRenderers[a];return c?c.apply(this,b):b[0]},Echo.Control.prototype.extendTemplate=function(a,b,c){this.extension.template.push({action:a,anchor:b,html:c})},Echo.Control.prototype.extendRenderer=function(a,b){var c=this,d=this.extension.renderers,e=d[a]||this.renderers[a];d[a]=function(){return c.parentRenderers[a]=e,b.apply(c,arguments)}},Echo.Control.prototype.log=function(a){Echo.Utils.log(b.extend(a,{component:this.name}))},Echo.Control.prototype.getRelativeTime=function(a){if(a){var b=this,c="string"==typeof a?Echo.Utils.timestampFromW3CDTF(a):a;if(c){var d=new Date(1e3*c),e=(new Date).getTime(),f=Math.floor((e-d.getTime())/1e3),g=Math.floor(f/86400),h=function(a,c){return b.labels.get(c+(1===a?"":"s")+"Ago",{number:a})};return isNaN(g)||-60>f||g>=365?d.toLocaleDateString()+", "+d.toLocaleTimeString():10>f?this.labels.get("justNow"):60>f?h(f,"second"):3600>f?h(Math.floor(f/60),"minute"):86400>f?h(Math.floor(f/3600),"hour"):172800>f?this.labels.get("yesterday"):7>g?h(g,"day"):14>g?this.labels.get("lastWeek"):30>g?h(Math.floor(g/7),"week"):60>g?this.labels.get("lastMonth"):365>g?h(Math.floor(g/31),"month"):void 0}}},Echo.Control.prototype.placeImage=function(a){var c=a.position||"fill";a.container.addClass("echo-image-container"),"fill"===c&&a.container.addClass("echo-image-position-fill");var d=Echo.Utils.loadImage({image:a.image,defaultImage:a.defaultImage,onerror:a.onerror,onload:function(){"CSS1Compat"!==document.compatMode&&b(this).addClass(this.width<this.height?"echo-image-stretched-vertically":"echo-image-stretched-horizontally"),b.isFunction(a.onload)&&a.onload.apply(this,arguments)}});a.container.empty().append(d)},Echo.Control.prototype.checkAppKey=function(){return this.config.get("appkey")?!0:(this.showError({errorCode:"incorrect_appkey"},{critical:!0}),!1)},Echo.Control.prototype._init=function(a){var c=this;a&&a.length&&Echo.Utils.pipe(b.map(a,function(a){var d=a.split(":"),e=b.proxy(c._initializers[d[0]],c);return d[1]?Echo.Utils.promisify(e):function(){var d=e();return"undefined"!=typeof d&&(c[a]=d),b.Deferred().resolve()}}))},Echo.Control.prototype._initializers={},Echo.Control.prototype._initializers.list=[["vars",["init","refresh"]],["config",["init"]],["css",["init"]],["events",["init"]],["subscriptions",["init"]],["labels",["init"]],["view",["init"]],["loading",["init","refresh"]],["dependencies:async",["init"]],["user:async",["init","refresh"]],["plugins:async",["init","refresh"]],["init:async",["init","refresh"]],["ready",["init"]],["refresh",["refresh"]]],Echo.Control.prototype._initializers.get=function(a){return Echo.Utils.foldl([],this.list,function(c,d){~b.inArray(a,c[1])&&d.push(c[0])})},Echo.Control.prototype._initializers.vars=function(){b.extend(this,b.extend(!0,{},this._manifest("vars")))},Echo.Control.prototype._initializers.config=function(){var a=this,b=this._manifest("config"),c=function(c,d){return b.normalizer&&b.normalizer[c]?b.normalizer[c].call(this,d,a):d};return new Echo.Configuration(this.config,b,c,{data:!0,parent:!0})},Echo.Control.prototype._initializers.events=function(){var a=this,c=function(c){return c.context=c.context||a.config.get("context"),c.handler&&(c.handler=b.proxy(c.handler,a)),c};return{publish:function(d){var e,f;d.data=d.data||{},a._prepareEventParams&&(d.data=a._prepareEventParams(d.data)),d=c(d),d.inherited&&(e=a.constructor.parent,f=function g(a,b){return a&&a.name&&(b.unshift(a.name),g(a.constructor.parent,b)),b}(e,[]),b.map(f,function(a){Echo.Events.publish(b.extend({},d,{topic:a+"."+d.topic,global:!1}))})),d.topic=a.name+"."+d.topic,Echo.Events.publish(d)},subscribe:function(b){var d=Echo.Events.subscribe(c(b));return a.subscriptionIDs[d]=!0,d},unsubscribe:function(b){b&&b.handlerId&&delete a.subscriptionIDs[b.handlerId],Echo.Events.unsubscribe(c(b))}}},Echo.Control.prototype._initializers.subscriptions=function(){var a=this;b.each(a._manifest("events"),function c(d,e){if(b.isArray(e))for(var f=0;f<e.length;f++)c(d,e[f]);else e=b.isFunction(e)?{handler:e}:e,a.events.subscribe(b.extend({topic:d},e))}),b.map(["global",a.config.get("context")],function(b){a.events.subscribe({topic:"Echo.Control.onDataInvalidate",context:b,handler:function(){var b=a.get("request");b&&b.liveUpdates&&b.liveUpdates.start(!0)}})}),a.events.subscribe({topic:"Echo.Control.onDestroy",handler:function(c,d){var e=a.config.get("context")===d.producer.config.get("context");b.map(a.config.get("pluginsOrder"),function(b){var c=a.plugins[b];c&&c.destroy&&c.destroy()}),a._manifest("destroy")&&a._manifest("destroy").call(a,d.producer);var f=a.get("request");f&&(f.abort(),a.remove("request")),(d.self||!e)&&b.each(a.subscriptionIDs,function(b){a.events.unsubscribe({handlerId:b})}),e&&a.config.get("target").empty()}}),!a.dependent()&&this.config.get("refreshOnUserInvalidate")&&a.events.subscribe({topic:"Echo.UserSession.onInvalidate",context:"global",handler:a.refresh})},Echo.Control.prototype._initializers.labels=function(){return new Echo.Labels(this.config.get("labels"),this.name)},Echo.Control.prototype._initializers.css=function(){var a=this;this.config.get("target").addClass(this.cssClass),b.map(this._manifest("css"),function(b){if(b.id&&b.code&&!Echo.Utils.hasCSS(b.id))if(b.id!==a.name){var c,d=Echo.Utils.getComponent(b.id);d&&(c=a.substitute({template:b.code,instructions:{"class":function(a){return d.prototype.cssPrefix+a}}}),Echo.Utils.addCSS(c,b.id))}else Echo.Utils.addCSS(a.substitute({template:b.code}),b.id)})},Echo.Control.prototype._initializers.view=function(){var a=this;return new Echo.View({data:this.get("data"),cssPrefix:this.get("cssPrefix"),renderer:function(b){var c=a.extension.renderers[b.name]||a.renderers[b.name];return c?c.call(a,b.target,b.extra):b.target},substitutions:this._getSubstitutionInstructions()})},Echo.Control.prototype._initializers.loading=function(){this.showMessage({type:"loading",message:this.labels.get("loading")})},Echo.Control.prototype._initializers.dependencies=function(a){this._loadScripts(this._manifest("dependencies"),b.proxy(a,this))},Echo.Control.prototype._initializers.user=function(a){var b=this;if(!this.config.get("appkey"))return void a.call(b);if(this.config.get("user"))this.user=this.config.get("user"),a.call(b);else{var c=function(a,b){if(a){var c=Echo.Utils.parseURL(a);return(c.scheme||"https")+"://"+c.domain+b}};Echo.UserSession({appkey:this.config.get("appkey"),useSecureAPI:this.config.get("useSecureAPI"),endpoints:{logout:c(this.config.get("submissionProxyURL"),"/v2/"),whoami:c(this.config.get("apiBaseURL"),"/v1/users/")},ready:function(){b.user=this,a.call(b)}})}},Echo.Control.prototype._initializers.plugins=function(a){this._loadPluginScripts(function(){var c=this;b.map(c.config.get("pluginsOrder"),function(a){var b=Echo.Plugin.getClass(a,c.name);if(b){var d=new b({component:c});d.enabled()&&(d.init(),c.plugins[a]=d)}}),a.call(this)})},Echo.Control.prototype._initializers.init=function(a){this.ready=a,this._manifest("init").call(this)},Echo.Control.prototype._initializers.ready=function(){this.config.get("ready")&&(this.config.get("ready").call(this),this.config.remove("ready")),this.events.publish({topic:"onReady"})},Echo.Control.prototype._initializers.refresh=function(){this.events.publish({topic:"onRefresh"})},Echo.Control._merge=function(a,c){var d=this;c=c||b.extend(!0,Echo.Control.manifest(this._manifest.name),this._manifest);var e=function(a){return a.css=a.css||"",b.isArray(a.css)?a.css:[{id:a.name,code:a.css}]};a.css=e(a),c.css=e(c);var f=Echo.Utils.foldl({},a,function(a,b,e){b[e]=e in c&&d._merge[e]?d._merge[e](c[e],a):a});return b.extend(!0,{},c,f)};var c=function(a,b){return function(){var c=this.parent;this.parent=a;var d=b.apply(this,arguments);return this.parent=c,d}};Echo.Control._merge.methods=function(a,b){return Echo.Utils.foldl({},b,function(b,d,e){d[e]=e in a?c(a[e],b):b})},Echo.Control._merge.dependencies=function(a,b){return a.concat(b)},Echo.Control._merge.css=function(a,b){return a.concat(b)},Echo.Control._merge.events=function(a,b){return Echo.Utils.foldl({},b,function(b,c,d){c[d]=d in a?[b,a[d]]:b})},b.map(["init","destroy"],function(a){Echo.Control._merge[a]=c}),Echo.Control.prototype._getSubstitutionInstructions=function(){var a=this;return{"class":function(b){return b?a.cssPrefix+b:a.cssClass},"inherited.class":function(b){var c,d;return b?(d=a.constructor.parent,c=function e(a,c){return a&&a.cssPrefix&&(c.unshift(a.cssPrefix+b),e(a.constructor.parent,c)),c}(d,[]).join(" ")):c=a.cssClass,c},label:function(b,c){return a.labels.get(b,c)},self:function(b,c){var d=a.invoke(Echo.Utils.get(a,b));return"undefined"==typeof d?Echo.Utils.get(a.data,b,c):d},config:function(b,c){return a.invoke(a.config.get(b,c))}}},Echo.Control.prototype._manifest=function(a){var b=Echo.Utils.getComponent(this.name);return b?a?b._manifest[a]:b._manifest:void 0},Echo.Control.prototype._loadScripts=function(a,c){return a&&a.length?(a=b.map(a,b.proxy(function(a){if(!a.loaded){var c=a.app&&"App"||a.control&&"Control"||a.plugin&&"Plugin";c&&(a.loaded=function(){return Echo[c].isDefined(a[c.toLowerCase()])})}return b.extend(a,{url:this.substitute({template:a.url})})},this)),void Echo.Loader.download(a,b.proxy(function(){c.call(this)},this),{errorTimeout:this.config.get("scriptLoadErrorTimeout")})):void c.call(this)},Echo.Control.prototype._loadPluginScripts=function(a){var c=this,d=this.config.get("pluginsOrder"),e={plugins:function(a,b){var d="plugins."+a+".url";return!b&&c.config.get(d)?[{url:c.config.get(d),loaded:function(){return!!Echo.Plugin.getClass(a,c.name)}}]:void 0},dependencies:function(a,b){return b&&b.dependencies}},f=function(a){return Echo.Utils.foldl([],d,function(d,f){var g=Echo.Plugin.getClass(d,c.name),h=e[a](d,g);return b.isArray(h)&&h.length?f.concat(h):void 0})};this._loadScripts(f("plugins"),function(){this._loadScripts(f("dependencies"),a)})},Echo.Control.prototype._compileTemplate=function(){var a=this,c=this.get("data",{}),d=this.extension.template,e=a.substitute({data:c,template:this.invoke(this.template)}),f=b("<div/>").html(e);return d&&d.length&&b.map(d,function(b){f=a._domTransformer({dom:f,data:c,transformation:b})}),b(f.html())},Echo.Control.prototype._domTransformer=function(a){var c={insertBefore:"before",insertAfter:"after",insertAsFirstChild:"prepend",insertAsLastChild:"append",replace:"replaceWith",remove:"remove"},d=c[a.transformation.action];if(!d)return a.dom;var e,f=a.transformation.html,g="."+this.get("cssPrefix")+a.transformation.anchor;return f&&(e=this.substitute({data:a.data,template:f})),b(g,a.dom)[d](e),a.dom}}(Echo.jQuery),function(a){"use strict";var b=a,c={};c.name="Echo.Control",c.vars={plugins:{},extension:{template:[],renderers:{}},parentRenderers:{},subscriptionIDs:{},parent:function(){}},c.config={target:void 0,appkey:"",labels:{},apiBaseURL:"//api.echoenabled.com/v1/",submissionProxyURL:"https://apps.echoenabled.com/v2/esp/activity",useSecureAPI:!1,infoMessages:{enabled:!0,layout:"full"},cdnBaseURL:{sdk:Echo.Loader.getURL(""),"sdk-assets":Echo.Loader.getURL("",!1),apps:Echo.Loader.config.cdnBaseURL+"apps"},plugins:{},context:"",scriptLoadErrorTimeout:5e3,query:"",refreshOnUserInvalidate:!0,defaultAvatar:Echo.Loader.getURL("images/avatar-default.png",!1)},c.config.normalizer={target:b,plugins:function(a){var c=Echo.Utils.foldl({hash:{},order:[]},a||[],function(a,c){var d=b.inArray(a.name,c.order);d>=0&&c.order.splice(d,1),c.order.push(a.name),c.hash[a.name]=a});return this.set("pluginsOrder",c.order),c.hash},context:Echo.Events.newContextId,defaultAvatar:Echo.Loader.getURL},c.labels={loading:"Loading...",retrying:"Retrying...",error_busy:"Loading. Please wait...",error_timeout:"Loading. Please wait...",error_waiting:"Loading. Please wait...",error_view_limit:"View creation rate limit has been exceeded. Retrying in {seconds} seconds...",error_view_update_capacity_exceeded:"This stream is momentarily unavailable due to unusually high activity. Retrying in {seconds} seconds...",error_result_too_large:"(result_too_large) The search result is too large.",error_wrong_query:"(wrong_query) Incorrect or missing query parameter.",error_incorrect_appkey:"(incorrect_appkey) Incorrect or missing appkey.",error_internal_error:"(internal_error) Unknown server error.",error_quota_exceeded:"(quota_exceeded) Required more quota than is available.",error_incorrect_user_id:"(incorrect_user_id) Incorrect user specified in User ID predicate.",error_unknown:"(unknown) Unknown error.",today:"Today",justNow:"Just now",yesterday:"Yesterday",lastWeek:"Last Week",lastMonth:"Last Month",secondAgo:"{number} Second Ago",secondsAgo:"{number} Seconds Ago",minuteAgo:"{number} Minute Ago",minutesAgo:"{number} Minutes Ago",hourAgo:"{number} Hour Ago",hoursAgo:"{number} Hours Ago",dayAgo:"{number} Day Ago",daysAgo:"{number} Days Ago",weekAgo:"{number} Week Ago",weeksAgo:"{number} Weeks Ago",monthAgo:"{number} Month Ago",monthsAgo:"{number} Months Ago"},c.inherits=Echo.Control,c.templates={message:{}},c.templates.message.compact='<span class="echo-control-message echo-control-message-icon echo-control-message-{data:type} {class:messageIcon} {class:messageText}" title="{data:message}">&nbsp;</span>',c.templates.message.full='<div class="echo-control-message {class:messageText}"><span class="echo-control-message-icon echo-control-message-{data:type} {class:messageIcon}">{data:message}</span></div>',c.css='.echo-secondaryBackgroundColor { background-color: #F4F4F4; }.echo-trinaryBackgroundColor { background-color: #ECEFF5; }.echo-primaryColor { color: #3A3A3A; }.echo-secondaryColor { color: #C6C6C6; }.echo-primaryFont { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; font-size: 12px; font-weight: normal; line-height: 16px; }.echo-secondaryFont { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; font-size: 11px; }.echo-linkColor, .echo-linkColor a { color: #476CB8; }.echo-clickable { cursor: pointer; }.echo-relative { position: relative; }.echo-clear { clear: both; }.echo-image-container.echo-image-position-fill { text-align: center; overflow: hidden; }.echo-image-container.echo-image-position-fill img { max-width: 100%; max-height: 100%; width: auto; height: auto; vertical-align: top; }.echo-image-container.echo-image-position-fill img.echo-image-stretched-horizontally { width: 100%; height: auto; }.echo-image-container.echo-image-position-fill img.echo-image-stretched-vertically { width: auto; height: 100%; }.echo-control-message { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; padding: 15px 0px; text-align: center; }.echo-control-message-icon { height: 16px; padding-left: 16px; background: no-repeat left center; }.echo-control-message .echo-control-message-icon { padding-left: 21px; height: auto; }.echo-control-message-info { background-image: url({config:cdnBaseURL.sdk-assets}/images/information.png); }.echo-control-message-loading { background-image: url({config:cdnBaseURL.sdk-assets}/images/loading.gif); }.echo-control-message-error { background-image: url({config:cdnBaseURL.sdk-assets}/images/warning.gif); }',Echo.Control._manifest=c}(Echo.jQuery);
!function(a){"use strict";var b=a;Echo.Utils.isComponentDefined("Echo.App")||(Echo.App=Echo.Utils.inherit(Echo.Control),Echo.App.create=Echo.Control.create,Echo.App.manifest=function(){var a=Echo.App.parent.constructor.manifest.apply(this,arguments);return a.inherits=a.inherits||Echo.App,a},Echo.App.isDefined=Echo.Control.isDefined,Echo.App.prototype.initComponent=function(a){this.destroyComponent(a.id),a.config=a.config||{},this.user&&(a.config.user=this.user),a.config.parent=a.config.parent||this.config.getAsHash(),a.config.parent.components&&delete a.config.parent.components,a.config.plugins=this._mergeSpecsByName(b.extend(!0,[],this.config.get("components."+a.id+".plugins",[])),a.config.plugins||[]),a.config=this._normalizeComponentConfig(b.extend(!0,{},this.config.get("components."+a.id,{}),a.config));var c=Echo.Utils.getComponent(a.component);return this.set("components."+a.id,new c(a.config)),this.getComponent(a.id)},Echo.App.prototype.getComponent=function(a){return this.get("components."+a)},Echo.App.prototype.destroyComponent=function(a){var b=this.getComponent(a);b&&(b.destroy(),this.remove("components."+a))},Echo.App.prototype.destroyComponents=function(a){var c=this;a=a||[];var d=function(c){var d=!1;return b.each(a,function(a,b){return b===c?(d=!0,!1):void 0}),d};b.each(this.components,function(a){d(a)||c.destroyComponent(a)})},Echo.App._merge=Echo.Control._merge,Echo.App._manifest=Echo.Control._manifest,Echo.App.prototype._mergeSpecsByName=function(a){var c=this,d=function(a,c){var d=-1;return b.each(c,function(b,c){return a.name===c.name?(d=b,!1):void 0}),d},e=b.map(Array.prototype.slice.call(arguments,1)||[],function(a){return a});return Echo.Utils.foldl(a,e,function(e){var f=d(e,a);return~f?(e.name===a[f].name&&e.nestedPlugins&&(a[f].nestedPlugins=a[f].nestedPlugins||[],c._mergeSpecsByName(a[f].nestedPlugins,e.nestedPlugins),delete e.nestedPlugins),void(a[f]=b.extend(!0,{},a[f],e))):void a.push(e)})},Echo.App.prototype._normalizeComponentConfig=function(a){var c=this;Echo.Utils.foldl(a,this._manifest("config"),function(a,b,d){"undefined"==typeof b[d]&&(b[d]=c.config.get(d))});var d=function(a){return"string"==typeof a?c.substitute({template:a,strict:!0}):b.isPlainObject(a)?Echo.Utils.foldl({},a,function(a,b,c){b[c]=d(a)}):b.isArray(a)?b.map(a,function(a){return d(a)}):a};return d(a)})}(Echo.jQuery);
!function(a){"use strict";var b=a;Echo.Utils.isComponentDefined("Echo.Plugin")||(Echo.Plugin=function(){},Echo.Plugin.create=function(a){var c=Echo.Plugin.getClass(a.name,a.component.name);if(c)return c;var d=Echo.Utils.inherit(Echo.Plugin,function(b){return b&&b.component?(this.name=a.name,this.component=b.component,this.cssClass=this.component.get("cssPrefix")+"plugin-"+a.name,this.cssPrefix=this.cssClass+"-",this.component.config.get("target").addClass(this.cssClass),void this._init(["config"])):void Echo.Utils.log({type:"error",component:a.name,message:"Unable to initialize plugin, config is invalid",args:{config:b}})}),e=Echo.Plugin._getClassName(a.name,a.component.name);return d.manifest=a,d.dependencies=a.dependencies,d.prototype.namespace=e,Echo.Labels.set(b.extend({},a.labels),e,!0),a.methods&&b.extend(d.prototype,a.methods),Echo.Utils.set(window,e,d),d},Echo.Plugin.manifest=function(a,b){return{name:a,component:{name:b,renderers:{}},config:{},labels:{},events:{},methods:{},renderers:{},templates:{},dependencies:[],enabled:function(){return!0},init:function(){},destroy:function(){}}},Echo.Plugin.isDefined=function(a){if("string"==typeof a){var b=Echo.Utils.get(window,a);return!(!b||!b.manifest)}return!!Echo.Plugin.getClass(a.name,a.component.name)},Echo.Plugin.getClass=function(a,b){return Echo.Utils.get(window,Echo.Plugin._getClassName(a,b))},Echo.Plugin.prototype.init=function(){this._init(["css","events","subscriptions","labels","renderers","view","launcher"])},Echo.Plugin.prototype.enabled=function(){if("undefined"==typeof this._enabled){var a=this.config.get("enabled",!0);switch(b.type(a)){case"string":a="true"===a;break;case"function":a=a.call(this)}this._enabled=a&&!!this._manifest("enabled").call(this)}return this._enabled},Echo.Plugin.prototype.set=function(a,b){return Echo.Utils.set(this,a,b)},Echo.Plugin.prototype.get=function(a,b){return Echo.Utils.get(this,a,b)},Echo.Plugin.prototype.remove=function(a){return Echo.Utils.remove(this,a)},Echo.Plugin.prototype.invoke=function(a,b){return Echo.Utils.invoke(a,b||this)},Echo.Plugin.prototype.enable=function(a){a&&this.config.set("enabled",!0),this._enabled=!0},Echo.Plugin.prototype.disable=function(a){a&&this.config.set("enabled",!1),this._enabled=!1},Echo.Plugin.prototype.extendTemplate=function(a,b,c){c&&(c=this.substitute({template:this.invoke(c)})),this.component.extendTemplate.call(this.component,a,b,c)},Echo.Plugin.prototype.parentRenderer=function(){return this.component.parentRenderer.apply(this.component,arguments)},Echo.Plugin.prototype.substitute=function(a){var c=this,d=this._getSubstitutionInstructions();return a.instructions=a.instructions?b.extend(d,a.instructions):d,c.component.substitute(a)},Echo.Plugin.prototype.requestDataRefresh=function(){Echo.Events.publish({topic:"Echo.Control.onDataInvalidate",context:this.component.config.get("context"),global:!1,propagation:!1,data:{}})},Echo.Plugin.prototype.log=function(a){Echo.Utils.log(b.extend(a,{component:this.namespace}))},Echo.Plugin._defineNestedClass=function(a){Echo.Plugin[a]=function(a){this.plugin=a.plugin}},Echo.Plugin.prototype._init=function(){Echo.Control.prototype._init.apply(this,arguments)},Echo.Plugin.prototype._manifest=function(a){var b=Echo.Plugin.getClass(this.name,this.component.name);return b?a?b.manifest[a]:b.manifest:void 0},Echo.Plugin.prototype._initializers={},Echo.Plugin.prototype._initializers.css=function(){this._manifest("css")&&!Echo.Utils.hasCSS(this.namespace)&&Echo.Utils.addCSS(this.substitute({template:this._manifest("css")}),this.namespace)},Echo.Plugin.prototype._initializers.labels=function(){return new Echo.Labels(this.config.get("labels",{}),this.namespace)},Echo.Plugin.prototype._initializers.config=function(){return new Echo.Plugin.Config({plugin:this})},Echo.Plugin.prototype._initializers.events=function(){return new Echo.Plugin.Events({plugin:this})},Echo.Plugin.prototype._initializers.subscriptions=function(){var a=this;b.each(this._manifest("events"),function(c,d){d=b.isFunction(d)?{handler:d}:d,a.events.subscribe(b.extend({topic:c},d))})},Echo.Plugin.prototype._initializers.renderers=function(){var a=this;b.each(this._manifest("renderers"),function(c,d){a.component.extendRenderer.call(a.component,"plugin-"+a.name+"-"+c,b.proxy(d,a))}),b.each(this._manifest("component").renderers,function(c,d){a.component.extendRenderer.call(a.component,c,b.proxy(d,a))})},Echo.Plugin.prototype._initializers.view=function(){var a=this,b="plugin-"+this.name+"-",c=function(b,c){var d=a.component.get("view");return d[b].apply(d,c)};return{set:function(a,d){c("set",[b+a,d])},get:function(a){return c("get",[b+a])},remove:function(a){"string"==typeof a&&(a=b+a),c("remove",[a])},render:function(a){a&&a.name&&(a.name=b+a.name),c("render",[a])}}},Echo.Plugin.prototype._initializers.launcher=function(){this._manifest("init").call(this)},Echo.Plugin.prototype._getSubstitutionInstructions=function(){var a=this;return{"plugin.label":function(b){return a.labels.get(b,"")},"plugin.class":function(b){return b?a.cssPrefix+b:a.cssClass},"plugin.data":function(b){return"{self:plugins."+a.name+".data."+b+"}"},"plugin.self":function(b){return"{self:plugins."+a.name+"."+b+"}"},"plugin.config":function(b){return a.config.get(b,"")}}},Echo.Plugin._getClassName=function(a,b){return a&&b?b+".Plugins."+a:void 0},Echo.Plugin._defineNestedClass("Config"),Echo.Plugin.Config.prototype.set=function(a,b){this.plugin.component.config.set(this._normalize(a),b)},Echo.Plugin.Config.prototype.get=function(a,b,c){var d=this.plugin.component,e=d.config.get(this._normalize(a),this.plugin._manifest("config")[a]);return"undefined"==typeof e?c?d.config.get(a,b):b:e},Echo.Plugin.Config.prototype.remove=function(a){this.plugin.component.config.remove(this._normalize(a))},Echo.Plugin.Config.prototype.assemble=function(a){var b=this.plugin.component.config,c=this.plugin.component._manifest("config");a=a||{},a.user=this.plugin.component.user,a.parent=b.getAsHash(),a.plugins=(a.plugins||[]).concat(this.plugin.config.get("nestedPlugins",[])),Echo.Utils.foldl(a,c,function(c,d,e){"undefined"==typeof a[e]&&(d[e]=b.get(e))});var d={data:!0,parent:!0},e=new Echo.Configuration(a,this.plugin.config.get(),void 0,d);return e.getAsHash()},Echo.Plugin.Config.prototype._normalize=function(a){return["plugins",this.plugin.name].concat(a?a:[]).join(".")},Echo.Plugin._defineNestedClass("Events"),Echo.Plugin.Events.prototype.publish=function(a){return a.topic=["Plugins",this.plugin.name,a.topic].join("."),this.plugin.component.events.publish(a)},Echo.Plugin.Events.prototype.subscribe=function(a){return a.handler=b.proxy(a.handler,this.plugin),this.plugin.component.events.subscribe(a)},Echo.Plugin.Events.prototype.unsubscribe=function(a){this.plugin.component.events.unsubscribe(a)})}(Echo.jQuery);
!function(a){"use strict";var b=a,c=Echo.Control.manifest("Echo.Canvas");if(!Echo.Control.isDefined(c)){c.init=function(){var a,c,d=this,e=this.config.get("target");if(e.data("echo-canvas-initialized"))return void this._error({args:{target:e},code:"canvas_already_initialized"});e.data("echo-canvas-initialized",!0);var f=this._getOverrides(e,["id","mode","provider","useSecureAPI","appsInit","maxConfigFetchingRetries"]);return b.isEmptyObject(f)||this.config.extend(f),Echo.Loader.isDebug()&&this.config.set("mode","dev"),this._isManuallyConfigured()||this.config.get("id")?(this.config.get("id")&&(a=this._getIds().normalized,c=Echo.Utils.foldl("",["main","unique"],function(b,c){return c+=a[b]?d.get("cssPrefix")+a[b]+" ":""}),e.addClass(c)),void this._fetchConfig(function(){d.events.publish({topic:"onDataReceive",data:{id:d.config.get("id"),config:d.get("data")}});var a=d.get("data.backplane");a&&Backplane.init(a),d.updateLayout(this.get("data.apps"),this.get("data.layout")).then(function(){d.ready()})})):void this._error({args:{target:e},code:"invalid_canvas_config"})},c.config={appsInit:"async",appInitTimeout:5e3,id:"",data:{},overrides:{},mode:"prod",maxConfigFetchingRetries:2,provider:"aws",refreshOnUserInvalidate:!1},c.vars={apps:{}},c.labels={error_no_apps:"No applications defined for this canvas",error_no_config:"Unable to retrieve Canvas config",error_no_suitable_app_class:"Unable to init an app, no suitable JS class found",error_unable_to_retrieve_app_config:"Unable to retrieve Canvas config from the storage",error_incomplete_app_config:"Unable to init an app, config is incomplete",error_canvas_already_initialized:"Canvas has been initialized already",error_invalid_canvas_config:"Canvas with invalid configuration found"},c.templates.main='<div class="{class:container}"></div>',c.templates.row='<div class="echo-canvas-row" data-type="row"></div>',c.templates.column='<div class="echo-canvas-column" data-type="column"></div>',c.templates.app='<div class="{class:appContainer}"><div class="{class:appHeader}"></div><div class="{class:appBody}"></div></div>',c.destroy=function(){b.map(this.get("apps"),b.proxy(this._destroyApp,this)),this.config.get("target").data("echo-canvas-initialized",!1),Echo.Utils.remove(Echo.Loader.canvasesConfigById,this._getIds().unique)},c.renderers.container=function(a){return this._buildGrid(this.get("data.apps",[]),this.get("data.layout",[]),a)},c.methods.updateLayout=function(a,c){var d=function(a){return this.render(),a};return this.set("data.apps",a),this.set("data.layout",c||[]),Echo.Utils.pipe([b.proxy(this._loadAppResources,this,a),b.proxy(this._destroyOutdatedApps,this),b.proxy(this._prepareAppsView,this),b.proxy(d,this),b.proxy(this._sortAppsByLayout,this),b.proxy(this._initApps,this)])},c.methods._destroyOutdatedApps=function(a){var c=this;return b.each(this.apps,function(b,d){var e=c._indexOfApp(b,a)>-1;e||c._destroyApp(d)}),a},c.methods._indexOfApp=function(a,c){var d=-1;return b.each(c,function(b,c){return a===c.id?(d=b,!1):void 0}),d},c.methods._sortAppsByLayout=function(a){var b=this,c=this.get("data.layout",[]).sort(function(a,b){return a.row-b.row||a.col-b.col}),d=Echo.Utils.foldl([],c,function(c,d,e){var f=c.app,g=b._indexOfApp(f,a);return-1===g?d:(e>0&&d[e-1]?d[e]=a[g]:d.push(a[g]),a.splice(g,1),d)});return d.concat(a)},c.methods._isAppInitRequired=function(a){return!this.apps[a.id]||!this.apps[a.id].instance},c.methods._isAppReInitRequired=function(a){return!Echo.Utils.deepEqual(a,this.apps[a.id].data)},c.methods._initApps=function(a){var c=this,d=this.apps,e=b.proxy(this._initApp,this),f=b.proxy(this._reInitApp,this),g="sync"===this.config.get("appsInit"),h=function(a,c){d[c.id].data=b.extend(!0,{},c);var e=function(){return a(c).done(function(a){return d[c.id].instance=a,a})};return g?e:e()},i=b.map(a,function(a){return c._isAppInitRequired(a)?h(e,a):c._isAppReInitRequired(a)?h(f,a):h(function(){return b.Deferred().resolve(d[a.id].instance).promise()},a)});return g?Echo.Utils.pipe(i):b.when.apply(b,i)},c.methods._reInitApp=function(a){var b={},c=this.apps[a.id];return b.view=c.view,b.data=c.data,this._destroyApp(this.apps[a.id]),this.apps[a.id]=b,this._initApp(a)},c.methods._initApp=function(a){var c=b.Deferred(),d=Echo.Utils.getComponent(a.component);if(!d)return this._error({args:{app:a},code:"no_suitable_app_class"}),c.reject(a),c.promise();var e=this.config.get("overrides")[a.id];a.config.target=this.apps[a.id].view.get("appBody");var f,g=e?b.extend(!0,a.config,e):a.config,h=g.ready||b.noop,i=function(a){return clearTimeout(f),c.resolve(a)};if(d._manifest){var j=new d(b.extend(g,{ready:function(){h.apply(this,arguments),i(this)}}));f=setTimeout(function(){i(j)},this.config.get("appInitTimeout"))}else i(new d(g));return c.promise()},c.methods._normalizeApp=function(a){return b.extend(!0,{id:Echo.Utils.getUniqueString(),config:{canvasId:this.config.get("id")}},a)},c.methods._prepareAppsView=function(a){var c=this;return b.map(a,function(a){if(a=c._normalizeApp(a),c._isAppInitRequired(a)||c._isAppReInitRequired(a)){var b=c.get("cssPrefix")+"appId-"+a.id,d=c.view.fork({renderer:null,renderers:{appHeader:function(b){return a.caption?b.text(Echo.Utils.sanitize(a.caption,"plainText")).show():b.hide()},appBody:function(a){return a.addClass(b)}}});d.render({data:a,template:c.templates.app}),c.apps[a.id]=c.apps[a.id]||{},c.apps[a.id].view=d}return a})},c.methods._buildGrid=function(a,c,d){var e=this,f=Math.max.apply(null,b.map(c,function(a){return a.col+a.size_x-1}).concat(0)),g=function(a){return Echo.Utils.foldl([],a,function(a,c){c[a.row-1]||(c[a.row-1]=[]),c[a.row-1][a.col-1]=b.extend({},a,{row:a.row-1,col:a.col-1})})},h=function(a,b){var c=[],d=a[b.row+1]&&a[b.row+1][b.col];return d&&d.size_x===b.size_x&&(c=c.concat(d).concat(h(a,d))),c},i=[],j=g(c);b.each(j,function(a,c){var d={type:"row",items:[]},e=0;b.each(c||[],function(a,c){if(!c||c.processed)return!0;c.col>e&&(d.items.push({type:"column",size_x:c.col-e}),e=c.col);var f=h(j,c);b.each(f,function(a,b){b.processed=!0}),d.items.push({type:"column",items:[].concat(c).concat(f),size_x:c.size_x}),e=Math.max(e,c.col+c.size_x)}),f>e&&d.items.push({type:"column",size_x:f-e}),i.push(d)});var k=b.extend({},this.apps);return function l(a,c,d){d=d||0,b.each(a||[],function(a,g){if(g.app&&k[g.app])c.append(k[g.app].view.get("appContainer")),delete k[g.app];else if(g.type){var h=e.templates[g.type],i=b(e.substitute({template:h}));g.size_x&&i.addClass(e.cssPrefix+"column-"+g.size_x+"-"+f),g.items&&l(g.items,i,d+1),c.append(i)}}),d||b.isEmptyObject(k)||b.each(k,function(a,b){c.append(b.view.get("appContainer"))})}(i,d),d},c.methods._destroyApp=function(a){return a&&a.instance&&b.isFunction(a.instance.destroy)&&a.instance.destroy(),delete this.apps[a.data.id]},c.methods._isManuallyConfigured=function(){return!b.isEmptyObject(this.get("data"))},c.methods._getAppScriptURL=function(a){if(!a.scripts)return a.script;var b,c={dev:a.scripts.dev||a.scripts.prod,prod:a.scripts.prod||a.scripts.dev}[Echo.Loader.isDebug()?"dev":"prod"];return"string"==typeof c?c:(b=/^https/.test(window.location.protocol),c[b?"secure":"regular"])},c.methods._loadAppResources=function(a){var c=this,d=[],e=this._isManuallyConfigured(),f=b.Deferred();return b.map(a,function(a){var b=c._getAppScriptURL(a);return a.component&&b&&(e||a.id)?void d.push({url:b,loaded:function(){return Echo.Control.isDefined(a.component)}}):void c._error({args:{app:a},code:"incomplete_app_config"})}),Echo.Loader.download(d,function(){f.resolve(a)}),f.promise()},c.methods._getOverrides=function(a,b){return Echo.Utils.foldl({},b||[],function(b,c){var d="canvas-"+b.toLowerCase(),e=a.data(d);"undefined"!=typeof e&&(c[b]=e)})},c.methods._error=function(a){a.message=a.message||this.labels.get("error_"+a.code),Echo.Events.publish({topic:"Echo.Canvas.onError",data:a}),Echo.Utils.log(b.extend(a,{type:"error",component:"Echo.Canvas"})),a.renderError&&this.showMessage({type:"error",message:a.message})},c.methods._getIds=function(){var a=this.config.get("id"),b=a.split("#"),c=function(a){return a.replace(/[^a-z\d]/gi,"-")};return{unique:a,main:b[0],normalized:{unique:c(a),main:c(b[0])}}},c.methods._fetchConfig=function(a){var c=this,d=this.config.get("target"),e=this._isManuallyConfigured();if(e)return void a.call(this);var f=this.config.get("mode"),g=this.config.get("provider"),h="fastly"===g,i=function(){return Echo.Loader.canvasesConfigById[c._getIds().unique]},j=Echo.Utils.parseURL(Echo.Loader.config.storageURL[g][f]),k=this.substitute({template:"{data:scheme}://{data:domain}{data:path}{data:endpoint}",data:b.extend(j,{endpoint:this._getIds().main,scheme:this.config.get("useSecureAPI")?"https":j.scheme||"http"})})+(h?".json":"");setTimeout(function(){Echo.Utils.retry(function(){return b.ajax({url:k,crossDomain:!0,cache:"dev"!==f,dataType:h?"json":"script",timeout:Echo.Loader.config.errorTimeout,success:function(){var b=h?arguments[0]:i();if(!b||!b.apps||!b.apps.length){var e=c.labels.get("error_no_"+(b?"apps":"config"));return c.config.get("target").empty(),void c._error({args:{config:b,target:d},code:"invalid_canvas_config",message:e})}c.set("data",b),a.call(c)}})},{ratio:1,times:c.config.get("maxConfigFetchingRetries")}).fail(function(){c._error({args:{target:c.config.get("target"),network:arguments},code:"unable_to_retrieve_app_config",renderError:!0})})},0)};for(var d=[],e=1;8>=e;e++)for(var f=1;e>=f;f++)d.push(".{class:column-"+f+"-"+e+"} { width: "+f/e*100+"%; }");c.css=".{class:appHeader} { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }@media (min-width: 400px) {.{class:row} { display: table; table-layout: fixed; width: 100%; }.{class:column} { display: table-cell; vertical-align: top; }"+d.join(" ")+"}",Echo.Control.create(c)}}(Echo.jQuery);