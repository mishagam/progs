window.Backplane=window.Backplane||{channelByBus:{},config:{},initialized:!1,subscribers:{},awaiting:{since:0,until:0,queue:[]},intervals:{min:1,frequent:5,regular:60,slowdown:120}},Backplane.init=function(a){return a=a||{},!this.initialized&&a.serverBaseURL&&a.busName?(this.initialized=!0,this.timers={},this.config=a,this.channelByBus=this.getCookieChannels(),this.config.customChannelName=a.channelName,this.config.channelName=this.getChannelName(),this.config.serverBaseURL=this.normalizeURL(a.serverBaseURL),this.config.channelID=this.generateChannelID(),this.request(),!0):!1},Backplane.subscribe=function(a){if(!this.initialized)return!1;var b=(new Date).valueOf()+Math.random();return this.subscribers[b]=a,b},Backplane.unsubscribe=function(a){return this.initialized&&a?void delete this.subscribers[a]:!1},Backplane.getChannelID=function(){return this.initialized?this.config.channelID:!1},Backplane.expectMessages=function(a){this.expectMessagesWithin(60,a)},Backplane.expectMessagesWithin=function(a,b){if(!this.initialized||!a)return!1;this.awaiting.since=this.getTS(),this.awaiting.interval=a,this.awaiting.nonstop=!b,b&&(b="string"==typeof b?[b]:b,this.awaiting.queue.push(b));var c=this.awaiting.since+a;c>this.awaiting.until&&(this.awaiting.until=c),this.request()},Backplane.generateChannelID=function(){return this.config.serverBaseURL+"/bus/"+this.config.busName+"/channel/"+this.config.channelName},Backplane.getChannelName=function(){return this.initialized?this.config.customChannelName?this.config.customChannelName:(this.channelByBus[this.config.busName]||(this.channelByBus[this.config.busName]=(new Date).valueOf().toString()+Math.random().toString().substr(2,5),this.setCookieChannels()),this.channelByBus[this.config.busName]):!1},Backplane.getTS=function(){return Math.round((new Date).valueOf()/1e3)},Backplane.getCookieChannels=function(){var a=(document.cookie||"").match(/backplane-channel=(.*?)(?:$|;)/);if(!a||!a[1])return{};for(var b={},c=a[1].split("|"),d=0;d<c.length;d++){var e=c[d].split(":");b[decodeURIComponent(e[0])]=decodeURIComponent(e[1])}return b},Backplane.setCookieChannels=function(){var a=[];for(var b in this.channelByBus)this.channelByBus.hasOwnProperty(b)&&a.push(encodeURIComponent(b)+":"+encodeURIComponent(this.channelByBus[b]));var c=new Date;c.setFullYear(c.getFullYear()+5),document.cookie="backplane-channel="+a.join("|")+";expires="+c.toGMTString()+";path=/"},Backplane.resetCookieChannel=function(){delete this.channelByBus[this.config.busName],this.setCookieChannels(),this.config.channelName=this.getChannelName(),this.config.channelID=this.generateChannelID()},Backplane.normalizeURL=function(a){return a.replace(/^\s*(https?:\/\/)?(.*?)[\s\/]*$/,function(a,b,c){return(b||"https://")+c})},Backplane.calcTimeout=function(){var a,b=this.getTS();if(b<this.awaiting.until){if(!this.awaiting.nonstop&&!this.awaiting.queue.length)return this.awaiting.until=b,this.calcTimeout();var c=b-this.awaiting.since,d=this.intervals.frequent-this.intervals.min;a=this.intervals.min+Math.round(d*c/this.awaiting.interval)}else if(b<this.awaiting.until+this.intervals.slowdown){var c=b-this.awaiting.until,d=this.intervals.regular-this.intervals.frequent;a=this.intervals.frequent+Math.round(d*c/this.intervals.slowdown)}else a="undefined"==typeof this.since?0:this.intervals.regular,this.awaiting.nonstop=!1;return 1e3*a},Backplane.request=function(){var a=this;return this.initialized?(this.stopTimer("regular"),this.stopTimer("watchdog"),void(this.timers.regular=setTimeout(function(){a.timers.watchdog=setTimeout(function(){a.request()},5e3);var b=document.createElement("script");b.type="text/javascript",b.charset="utf-8",b.src=a.config.channelID+"?callback=Backplane.response"+(a.since?"&since="+encodeURIComponent(a.since):"")+"&rnd="+Math.random();var c=document.getElementsByTagName("head")[0]||document.documentElement;c.insertBefore(b,c.firstChild),b.onload=b.onreadystatechange=function(){var a=b.readyState;a&&"loaded"!==a&&"complete"!==a||(b.onload=b.onreadystatechange=null,b.parentNode&&b.parentNode.removeChild(b))}},this.calcTimeout()))):!1},Backplane.response=function(a){this.stopTimer("watchdog"),a=a||[];var b=a.length?a[a.length-1].id:this.since;"undefined"==typeof this.since&&(a=[]),this.since=b||"";for(var c=0;c<a.length;c++){for(var d in this.subscribers)this.subscribers.hasOwnProperty(d)&&this.subscribers[d](a[c].message);for(var e=[],f=0;f<this.awaiting.queue.length;f++){for(var g=!1,h=0;h<this.awaiting.queue[f].length;h++)this.awaiting.queue[f][h]==a[c].message.type&&(g=!0);g||e.push(this.awaiting.queue[f])}this.awaiting.queue=e}this.request()},Backplane.stopTimer=function(a){var b=this.timers[a];b&&clearTimeout(b)};