define(["jquery-1","gelui-1/core","jssignals-1","gelui-1/widget","jcarousel-1"],function(j,a,c,h,d){function f(){function k(n,o){return new k.fn.init(n,o)}j.extend(true,k,this);k.superclass=this;k.fn=k.prototype=this();k.fn.constructor=k;k.sub=this.sub;k.fn.init=function m(n,o){if(o&&o instanceof j&&!(o instanceof k)){o=k(o)}return j.fn.init.call(this,n,o,l)};k.fn.init.prototype=k.fn;var l=k(document);return k}var e=d(f.apply(j));function b(k){return{wrap:e('<div class="gelui-carousel" id="gelui-carousel-'+k+'"><div class="gelui-carousel-viewport" id="gelui-carousel-viewport-'+k+'"></div></div>'),buttons:{prev:e('<fieldset class="gelui-carousel-navigation gelui-carousel-navigation-left" role="toolbar"><legend>Navigation</legend><button id="gelui-carousel-button-prev-'+k+'" class="gelui-carousel-button gelui-carousel-button-prev" type="button">Previous</button></fieldset>'),next:e('<fieldset class="gelui-carousel-navigation gelui-carousel-navigation-right" role="toolbar"><legend>Navigation</legend><button id="gelui-carousel-button-next-'+k+'" class="gelui-carousel-button gelui-carousel-button-next" type="button">Next</button></fieldset>')}}}var g=function(w,k){var l=Math.floor(Math.random()*1000),r=b(l),v=e(w),m=v.children("li").attr("role","option"),y=this,s,q,u,p="gelui-carousel-button-disabled",x=function(z){z.removeProp("disabled").removeClass(p)},o=function(z){z.prop("disabled","disabled").addClass(p)};k=k||{};s=k.startAt||0;v.wrap(r.wrap);this.signals={move:new c.Signal(),aftermove:new c.Signal()};this.$carousel=e("#gelui-carousel-viewport-"+l);this.$carousel.before(r.buttons.prev).after(r.buttons.next);q=e("#gelui-carousel-button-prev-"+l);u=e("#gelui-carousel-button-next-"+l);this.$carousel.bind("jcarouselinitend",function(){y.$carousel.jcarousel("scroll",s,false)});this.$carousel.jcarousel();this.$carousel.data("moveBy",k.moveBy||1);n();q.mousedown(function(z){y.previous()});u.mousedown(function(z){y.next()});m.on("jcarouselfirstin",function(z){return false});m.on("jcarouselfirstout",function(z){return false});m.on("jcarousellastin",function(z){return false});m.on("jcarousellastout",function(z){return false});m.on("jcarouselvisiblein",function(z){return false});m.on("jcarouselvisibleout",function(z){return false});this.$carousel.bind("jcarouselscrollend",function(C,B){var z=y.$carousel.find("li"),A=z.index(B[0]);y.signals.move.dispatch(C);n();if(C.isDefaultPrevented()){return false}});this._visibleIndexes=t();this._fullyVisibleIndexes=[];m.bind("jcarouselitemvisiblein",function(A){var z=y.index(this);y._visibleIndexes.push(z);y._visibleIndexes.sort()});m.bind("jcarouselitemvisibleout",function(B){var z=y.index(this),A;while((A=e.inArray(z,y._visibleIndexes))>-1){y._visibleIndexes.splice(A,1)}});m.bind("jcarouselitemfullyvisiblein",function(A){var z=y.index(this);y._fullyVisibleIndexes.push(z);y._fullyVisibleIndexes.sort()});m.bind("jcarouselitemfullyvisibleout",function(B){var z=y.index(this),A;while((A=e.inArray(z,y._fullyVisibleIndexes))>-1){y._fullyVisibleIndexes.splice(A,1)}});function n(){var A,z=y.get();if(!y._fullyVisibleIndexes||y._fullyVisibleIndexes.length===0){A=t()}else{A=y._fullyVisibleIndexes}if(A[0]<=0){o(q)}else{x(q)}if(A[A.length-1]>=z.length-1){o(u)}else{x(u)}}function t(){var z=[];m.filter(".jcarousel-item-fullyvisible").each(function(A,B){z.push(e(m).index(B))});if(z.length===0){m.filter(".jcarousel-item-visible").each(function(A,B){z.push(e(m).index(B))})}return z.sort()}this.firstItem=0;m.on("jcarouselfirstin",function(A){var z=y.index(this);y.firstItem=z})};e.extend(g.prototype,h);g.prototype.next=function(m){var k=this,l=this.$carousel;l.jcarousel("scroll","+="+l.data("moveBy"),function(n){k.signals.aftermove.dispatch(n);if(m){m()}})};g.prototype.previous=function(m){var k=this,l=this.$carousel;l.jcarousel("scroll","-="+l.data("moveBy"),function(n){k.signals.aftermove.dispatch(n);if(m){m()}})};g.prototype.moveTo=function(l,k,n){var m=this;if(n===true){l=i(this.$carousel,l)}this.$carousel.jcarousel("scroll",l,k,function(o){m.signals.aftermove.dispatch(o)})};g.prototype.visibleIndexes=function(){return this._visibleIndexes};function i(l,o){var n=l,m=n.find("li");viewportWidth=n.innerWidth(),itemWidths=[],totalWidth=0,gotoZero=true;m.each(function(p){if(itemWidths.length<=o){itemWidths.push(e(this).outerWidth(true))}});for(var k=itemWidths.length-1;k>=0;k--){totalWidth+=itemWidths[k];if(totalWidth>=viewportWidth){gotoZero=false;return k}}if(gotoZero){return 0}}g.prototype.get=function(k){var l=e(this.$carousel.jcarousel("items"));if(typeof k!=="undefined"){l=e(l[k])}return l};g.prototype.index=function(k){if(typeof k==="string"){k=e(k)}if(k.length){k=k[0]}return this.$carousel.jcarousel("items").index(k)};return g});