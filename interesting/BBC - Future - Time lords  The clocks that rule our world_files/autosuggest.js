define(["jquery-1","gelui-1/core","gelui-1/widget","gelui-1/overlay","jssignals-1"],function(g,d,f,c,b){var e=b.Signal;var a=function(i){if(this.$input[0]!==i.target&&0===g(i.target).closest(".gelui-1-autosuggest").length){clearTimeout(this.timeoutId);if(this.overlay.isShown()){this.overlay.hide()}this.$suggestionList.children().removeClass("gelui-active")}else{clearTimeout(this.blurTimer)}};var h=function(l,k){if(!l||0===l.length||l[0].tagName!="INPUT"){throw ("$input must be defined and cannot be empty.")}var j=this;if(typeof k=="string"){j._getData=j._getFromUrl}else{if(g.isArray(k)){j._getData=j._getFromArray}else{throw ("Please provide a data source")}}j.$input=l;j.dataSource=k;j.currentText="";j.timeoutId=null;j._defaultMenuMarkup='<div class="gelui-1-autosuggest" role="listbox"><div class="gelui-container"><ul class="gelui-suggestionlist"></ul></div></div>';j.signals={inputchanged:new e(),dataready:new e(),appenditem:new e(),displayitems:new e(),itemhighlighted:new e(),itemselected:new e()};j._bindKeyCodeEvents();j.overlay=new c(g(j._defaultMenuMarkup).appendTo("body"),{closeOnScroll:false});j.keyCode=d.keyCode;j.$suggestionList=j.overlay.$element.find(".gelui-suggestionlist");var i=function(m){a.call(j,m)};j.overlay.signals.show.add(function(){g("body").bind("click",i)});j.overlay.signals.hide.add(function(){g("body").unbind("click",i)});j.$input.bind("blur",function(){j.blurTimer=setTimeout(function(){if(j.overlay.isShown()){j.overlay.hide()}},200)});j.signals.inputchanged.add(j._defaultListeners.inputchanged,j);j.signals.dataready.add(j._defaultListeners.dataready,j);j.signals.appenditem.add(j._defaultListeners.appenditem,j);j.signals.displayitems.add(j._defaultListeners.displayitems,j);j.signals.itemselected.add(j._defaultListeners.itemselected,j);j.signals.itemhighlighted.add(j._defaultListeners.itemhighlighted,j)};g.extend(h.prototype,f);h.prototype.name="autosuggest";h.prototype._defaultListeners={inputchanged:function(j){var i=this;if(""===j.value&&i.overlay){i.overlay.hide();return false}i._getData(j.value,i.dataSource)},dataready:function(m){var l=this,j=m.data;l.$suggestionList.empty();for(var k=0;k<j[1].length;k++){l.signals.appenditem.dispatch({item:j[1][k].title})}l.$suggestionList.children().bind({mouseenter:function(){l.signals.itemhighlighted.dispatch({item:g(this)[0]})},click:function(){l.signals.itemselected.dispatch({item:g(this)[0]})}});l.signals.displayitems.dispatch()},appenditem:function(i){this.$suggestionList.append('<li role="option">'+i.item+"</li>")},displayitems:function(){this.overlay.nextTo(this.$input,"bottom","left").show()},itemhighlighted:function(i){this.$suggestionList.children().removeClass("gelui-active");g(i.item).addClass("gelui-active")},itemselected:function(j){var i=this;if(g(j.item).text()!=""){this.$input.val(g(j.item).text())}this.$input.closest("form").trigger("submit")}};h.prototype._getFromArray=function(o,r){var p=this;var q=new RegExp(o.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i");var m=g.grep(r,function(i){return q.test(i)});var j=[];for(var n=0,k=m.length;n<k;n++){j[n]={title:m[n]}}p.signals.dataready.dispatch({value:o,data:[o,j]})};h.prototype._getFromUrl=function(j,i){var k=this;g.ajax({url:i.replace(/\{input\}/g,j),dataType:"jsonp",success:function(l){k.signals.dataready.dispatch({value:j,data:l})},error:function(){k.$input.attr("autocomplete","on")}})};h.prototype._bindKeyCodeEvents=function(){var i,l=this;k();function k(){i={downs:0,presses:0}}function o(p){i.presses++;if(i.downs==1&&i.presses>1){return m(p)}}function j(p){i.downs++;return m(p)}function n(p){k();switch(p.keyCode){case l.keyCode.DOWNARROW:case l.keyCode.UPARROW:case l.keyCode.ESCAPE:case l.keyCode.ENTER:break;default:if(l.$input.val()!=l.currentText){l.currentText=l.$input.val();clearTimeout(l.timeoutId);l.timeoutId=setTimeout(function(){l.signals.inputchanged.dispatch({value:l.currentText})},1000)}}}function m(r){var q=l.$suggestionList.children(),p=l.$suggestionList.find(".gelui-active");switch(r.keyCode){case l.keyCode.DOWNARROW:if(p.length===0){l.signals.itemhighlighted.dispatch({item:q.first()[0],keyPressed:r.keyCode});l.currentText=q.first().text()}else{l.signals.itemhighlighted.dispatch({item:p.next()[0],keyPressed:r.keyCode});l.currentText=p.next().text()}clearTimeout(l.timeoutId);break;case l.keyCode.UPARROW:if(p.length===0){l.signals.itemhighlighted.dispatch({item:q.last()[0],keyPressed:l.keyCode.UPARROW});l.currentText=q.last().text()}else{l.signals.itemhighlighted.dispatch({item:p.prev()[0],keyPressed:l.keyCode.UPARROW});l.currentText=p.prev().text()}clearTimeout(l.timeoutId);break;case l.keyCode.ESCAPE:clearTimeout(l.timeoutId);l.overlay.hide();l.$suggestionList.children().removeClass("gelui-active");break;case l.keyCode.ENTER:clearTimeout(l.timeoutId);l.signals.itemselected.dispatch({item:p[0]});break;default:}}this.$input.keydown(j);this.$input.keyup(n);this.$input.keypress(o)};return h});